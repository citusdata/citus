SET search_path TO upgrade_distributed_table_before, public;
SELECT * FROM t ORDER BY a;
 a 
---
 1
 2
 3
 4
 5
(5 rows)

SELECT * FROM t WHERE a = 1;
 a 
---
 1
(1 row)

INSERT INTO t SELECT * FROM generate_series(10, 15);
SELECT * FROM t WHERE a = 10;
 a  
----
 10
(1 row)

SELECT * FROM t WHERE a = 11;
 a  
----
 11
(1 row)

-- test distributed type
INSERT INTO t1 VALUES (1, (2,3)::tc1);
SELECT * FROM t1;
 a |   b   
---+-------
 1 | (2,3)
(1 row)

ALTER TYPE tc1 RENAME TO tc1_newname;
INSERT INTO t1 VALUES (3, (4,5)::tc1_newname);
TRUNCATE TABLE t;
SELECT * FROM T;
 a 
---
(0 rows)

-- verify that the table whose column is dropped before a pg_upgrade still works as expected.
SELECT * FROM t_ab ORDER BY b;
 b  
----
 11
 22
 33
(3 rows)

SELECT * FROM t_ab WHERE b = 11;
 b  
----
 11
(1 row)

SELECT * FROM t_ab WHERE b = 22;
 b  
----
 22
(1 row)

DROP TABLE t;
DROP SCHEMA upgrade_distributed_table_before CASCADE;
NOTICE:  drop cascades to 3 other objects
DETAIL:  drop cascades to type tc1_newname
drop cascades to table t1
drop cascades to table t_ab
