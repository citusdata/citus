CREATE SCHEMA alter_null_dist_key;
SET search_path TO alter_null_dist_key;
SET citus.next_shard_id TO 1720000;
SET citus.shard_count TO 32;
SET citus.shard_replication_factor TO 1;
CREATE SEQUENCE dist_seq;
CREATE TABLE null_dist_table(a bigint DEFAULT nextval('dist_seq'), "b" text);
INSERT INTO null_dist_table("b") VALUES ('test');
SELECT create_distributed_table('null_dist_table', null, colocate_with=>'none', distribution_type=>null);
NOTICE:  Copying data from local table...
NOTICE:  copying the data has completed
DETAIL:  The local data in the table is no longer visible, but is still on disk.
HINT:  To remove the local data, run: SELECT truncate_local_data_after_distributing_table($$alter_null_dist_key.null_dist_table$$)
 create_distributed_table
---------------------------------------------------------------------

(1 row)

-- add column
ALTER TABLE null_dist_table ADD COLUMN c bigint DEFAULT 2;
SELECT * FROM null_dist_table;
 a |  b   | c
---------------------------------------------------------------------
 1 | test | 2
(1 row)

-- alter column type
ALTER TABLE null_dist_table ALTER COLUMN c TYPE text;
UPDATE null_dist_table SET c = 'this is a text' WHERE c = '2';
SELECT * FROM null_dist_table;
 a |  b   |       c
---------------------------------------------------------------------
 1 | test | this is a text
(1 row)

-- drop seq column
ALTER TABLE null_dist_table DROP COLUMN a;
SELECT * FROM null_dist_table;
  b   |       c
---------------------------------------------------------------------
 test | this is a text
(1 row)

-- add not null constraint
ALTER TABLE null_dist_table ALTER COLUMN b SET NOT NULL;
-- not null constraint violation, error out
INSERT INTO null_dist_table VALUES (NULL, 'test');
ERROR:  null value in column "b" violates not-null constraint
DETAIL:  Failing row contains (null, test).
CONTEXT:  while executing command on localhost:xxxxx
-- drop not null constraint and try again
ALTER TABLE null_dist_table ALTER COLUMN b DROP NOT NULL;
INSERT INTO null_dist_table VALUES (NULL, 'test');
SELECT * FROM null_dist_table;
  b   |       c
---------------------------------------------------------------------
 test | this is a text
      | test
(2 rows)

-- add exclusion constraint
ALTER TABLE null_dist_table ADD CONSTRAINT exc_b EXCLUDE USING btree (b with =);
-- cleanup
SET client_min_messages TO ERROR;
DROP SCHEMA alter_null_dist_key CASCADE;
