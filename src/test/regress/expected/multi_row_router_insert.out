\set VERBOSITY terse
SET citus.next_shard_id TO 1511000;
SET citus.shard_replication_factor TO 1;
SET citus.enable_local_execution TO ON;
SET citus.log_local_commands TO ON;
CREATE SCHEMA multi_row_router_insert;
SET search_path TO multi_row_router_insert;
SET client_min_messages to ERROR;
SELECT 1 FROM master_add_node('localhost', :master_port, groupId => 0);
 ?column?
---------------------------------------------------------------------
        1
(1 row)

RESET client_min_messages;
-- when using local execution, multi-row & router inserts works fine
-- even when not specifying some default columns
CREATE TABLE reference_table(a INT DEFAULT 1111, b INT DEFAULT 2222);
SELECT create_reference_table('reference_table');
 create_reference_table
---------------------------------------------------------------------

(1 row)

INSERT INTO reference_table VALUES (5), (6);
NOTICE:  executing the command locally: INSERT INTO multi_row_router_insert.reference_table_1511000 AS citus_table_alias (a, b) VALUES (5,2222), (6,2222)
INSERT INTO reference_table VALUES (DEFAULT), (7);
NOTICE:  executing the command locally: INSERT INTO multi_row_router_insert.reference_table_1511000 AS citus_table_alias (a, b) VALUES (1111,2222), (7,2222)
INSERT INTO reference_table (b) VALUES (8), (9);
NOTICE:  executing the command locally: INSERT INTO multi_row_router_insert.reference_table_1511000 AS citus_table_alias (a, b) VALUES (1111,8), (1111,9)
SELECT * FROM reference_table ORDER BY 1,2;
NOTICE:  executing the command locally: SELECT a, b FROM multi_row_router_insert.reference_table_1511000 reference_table ORDER BY a, b
  a   |  b
---------------------------------------------------------------------
    5 | 2222
    6 | 2222
    7 | 2222
 1111 |    8
 1111 |    9
 1111 | 2222
(6 rows)

CREATE OR REPLACE FUNCTION square(a INT) RETURNS INT AS $$
BEGIN
    RETURN a*a;
END; $$ LANGUAGE PLPGSQL STABLE;
CREATE TABLE citus_local_table(a int, b int DEFAULT square(10));
SELECT create_citus_local_table('citus_local_table');
 create_citus_local_table
---------------------------------------------------------------------

(1 row)

INSERT INTO citus_local_table VALUES (10), (11);
NOTICE:  executing the command locally: INSERT INTO multi_row_router_insert.citus_local_table_1511001 AS citus_table_alias (a, b) VALUES (10,100), (11,100)
INSERT INTO citus_local_table (a) VALUES (12), (13);
NOTICE:  executing the command locally: INSERT INTO multi_row_router_insert.citus_local_table_1511001 AS citus_table_alias (a, b) VALUES (12,100), (13,100)
SELECT * FROM citus_local_table ORDER BY 1,2;
NOTICE:  executing the command locally: SELECT a, b FROM multi_row_router_insert.citus_local_table_1511001 citus_local_table ORDER BY a, b
 a  |  b
---------------------------------------------------------------------
 10 | 100
 11 | 100
 12 | 100
 13 | 100
(4 rows)

-- cleanup at exit
DROP SCHEMA multi_row_router_insert CASCADE;
NOTICE:  drop cascades to 5 other objects
