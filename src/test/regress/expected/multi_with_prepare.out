-- prepared statements
PREPARE prepared_test_1 AS
WITH basic AS(
  SELECT * FROM users_table
)
SELECT
  * 
FROM
  basic
WHERE
  basic.value_2 IN (1, 2, 3)
ORDER BY
  1, 2, 3, 4, 5, 6
LIMIT 10;
PREPARE prepared_test_2 AS
WITH users_events AS(
  SELECT
      users_table.user_id as user_id,
      events_table.event_type as event_type
  FROM
      users_table,
      events_table
  WHERE
      users_table.user_id = events_table.user_id
  GROUP BY
      users_table.user_id,
      events_table.event_type
),
event_attendee_count AS(
  SELECT
    event_type, count(distinct user_id)
  FROM
    users_events
  GROUP BY
    1
),
user_coolness AS(
  SELECT
    user_id,
    sum(count)
  FROM
    users_events
    join
    event_attendee_count
    on (users_events.event_type = event_attendee_count.event_type)
  GROUP BY
    user_id
)
SELECT
  * 
FROM
  user_coolness
ORDER BY
  2, 1;
PREPARE prepared_test_3 AS
WITH users_events AS(
  -- events 1 and 2 only
  WITH spec_events AS(
    SELECT 
      *
    FROM
      events_table
    WHERE
      event_type IN (1, 2)
  )
  -- users who have done 1 or 2
  SELECT
      users_table.user_id,
      spec_events.event_type
  FROM
    users_table
    join
    spec_events
    on (users_table.user_id = spec_events.user_id)
  ORDER BY
    1,
    event_type
),
event_attendee_count AS(
  -- distinct attendee count of each event in users_event
  WITH event_attendee_count AS(
    SELECT
      event_type, count(distinct user_id)
    FROM
      users_events
    GROUP BY
      1
  )
  -- distinct attendee count of first 3 events
  SELECT
    *
  FROM
    event_attendee_count
  ORDER BY
    event_type
  LIMIT 3
),
-- measure how cool an attendee is by checking the number of events he attended
user_coolness AS(
  SELECT
    user_id,
    sum(count)
  FROM
    users_events
    join
    event_attendee_count
    on (users_events.event_type = event_attendee_count.event_type)
  GROUP BY
    user_id
)
SELECT
  * 
FROM
  user_coolness
ORDER BY
  2, 1;
EXECUTE prepared_test_1;
 user_id |              time               | value_1 | value_2 | value_3 | value_4 
---------+---------------------------------+---------+---------+---------+---------
       1 | Thu Nov 23 03:32:50.803031 2017 |       3 |       2 |       1 |        
       1 | Thu Nov 23 09:26:42.145043 2017 |       1 |       3 |       3 |        
       1 | Thu Nov 23 11:44:57.515981 2017 |       4 |       3 |       4 |        
       2 | Thu Nov 23 01:04:26.198826 2017 |       4 |       3 |       4 |        
       2 | Thu Nov 23 03:27:50.327051 2017 |       2 |       2 |       0 |        
       2 | Thu Nov 23 06:50:30.797805 2017 |       1 |       1 |       1 |        
       2 | Thu Nov 23 06:56:38.46819 2017  |       0 |       1 |       3 |        
       2 | Thu Nov 23 08:22:22.169158 2017 |       4 |       2 |       5 |        
       2 | Thu Nov 23 08:49:47.029236 2017 |       4 |       2 |       4 |        
       2 | Thu Nov 23 09:54:28.13665 2017  |       0 |       3 |       4 |        
(10 rows)

EXECUTE prepared_test_1;
 user_id |              time               | value_1 | value_2 | value_3 | value_4 
---------+---------------------------------+---------+---------+---------+---------
       1 | Thu Nov 23 03:32:50.803031 2017 |       3 |       2 |       1 |        
       1 | Thu Nov 23 09:26:42.145043 2017 |       1 |       3 |       3 |        
       1 | Thu Nov 23 11:44:57.515981 2017 |       4 |       3 |       4 |        
       2 | Thu Nov 23 01:04:26.198826 2017 |       4 |       3 |       4 |        
       2 | Thu Nov 23 03:27:50.327051 2017 |       2 |       2 |       0 |        
       2 | Thu Nov 23 06:50:30.797805 2017 |       1 |       1 |       1 |        
       2 | Thu Nov 23 06:56:38.46819 2017  |       0 |       1 |       3 |        
       2 | Thu Nov 23 08:22:22.169158 2017 |       4 |       2 |       5 |        
       2 | Thu Nov 23 08:49:47.029236 2017 |       4 |       2 |       4 |        
       2 | Thu Nov 23 09:54:28.13665 2017  |       0 |       3 |       4 |        
(10 rows)

EXECUTE prepared_test_1;
 user_id |              time               | value_1 | value_2 | value_3 | value_4 
---------+---------------------------------+---------+---------+---------+---------
       1 | Thu Nov 23 03:32:50.803031 2017 |       3 |       2 |       1 |        
       1 | Thu Nov 23 09:26:42.145043 2017 |       1 |       3 |       3 |        
       1 | Thu Nov 23 11:44:57.515981 2017 |       4 |       3 |       4 |        
       2 | Thu Nov 23 01:04:26.198826 2017 |       4 |       3 |       4 |        
       2 | Thu Nov 23 03:27:50.327051 2017 |       2 |       2 |       0 |        
       2 | Thu Nov 23 06:50:30.797805 2017 |       1 |       1 |       1 |        
       2 | Thu Nov 23 06:56:38.46819 2017  |       0 |       1 |       3 |        
       2 | Thu Nov 23 08:22:22.169158 2017 |       4 |       2 |       5 |        
       2 | Thu Nov 23 08:49:47.029236 2017 |       4 |       2 |       4 |        
       2 | Thu Nov 23 09:54:28.13665 2017  |       0 |       3 |       4 |        
(10 rows)

EXECUTE prepared_test_1;
 user_id |              time               | value_1 | value_2 | value_3 | value_4 
---------+---------------------------------+---------+---------+---------+---------
       1 | Thu Nov 23 03:32:50.803031 2017 |       3 |       2 |       1 |        
       1 | Thu Nov 23 09:26:42.145043 2017 |       1 |       3 |       3 |        
       1 | Thu Nov 23 11:44:57.515981 2017 |       4 |       3 |       4 |        
       2 | Thu Nov 23 01:04:26.198826 2017 |       4 |       3 |       4 |        
       2 | Thu Nov 23 03:27:50.327051 2017 |       2 |       2 |       0 |        
       2 | Thu Nov 23 06:50:30.797805 2017 |       1 |       1 |       1 |        
       2 | Thu Nov 23 06:56:38.46819 2017  |       0 |       1 |       3 |        
       2 | Thu Nov 23 08:22:22.169158 2017 |       4 |       2 |       5 |        
       2 | Thu Nov 23 08:49:47.029236 2017 |       4 |       2 |       4 |        
       2 | Thu Nov 23 09:54:28.13665 2017  |       0 |       3 |       4 |        
(10 rows)

EXECUTE prepared_test_1;
 user_id |              time               | value_1 | value_2 | value_3 | value_4 
---------+---------------------------------+---------+---------+---------+---------
       1 | Thu Nov 23 03:32:50.803031 2017 |       3 |       2 |       1 |        
       1 | Thu Nov 23 09:26:42.145043 2017 |       1 |       3 |       3 |        
       1 | Thu Nov 23 11:44:57.515981 2017 |       4 |       3 |       4 |        
       2 | Thu Nov 23 01:04:26.198826 2017 |       4 |       3 |       4 |        
       2 | Thu Nov 23 03:27:50.327051 2017 |       2 |       2 |       0 |        
       2 | Thu Nov 23 06:50:30.797805 2017 |       1 |       1 |       1 |        
       2 | Thu Nov 23 06:56:38.46819 2017  |       0 |       1 |       3 |        
       2 | Thu Nov 23 08:22:22.169158 2017 |       4 |       2 |       5 |        
       2 | Thu Nov 23 08:49:47.029236 2017 |       4 |       2 |       4 |        
       2 | Thu Nov 23 09:54:28.13665 2017  |       0 |       3 |       4 |        
(10 rows)

EXECUTE prepared_test_1;
 user_id |              time               | value_1 | value_2 | value_3 | value_4 
---------+---------------------------------+---------+---------+---------+---------
       1 | Thu Nov 23 03:32:50.803031 2017 |       3 |       2 |       1 |        
       1 | Thu Nov 23 09:26:42.145043 2017 |       1 |       3 |       3 |        
       1 | Thu Nov 23 11:44:57.515981 2017 |       4 |       3 |       4 |        
       2 | Thu Nov 23 01:04:26.198826 2017 |       4 |       3 |       4 |        
       2 | Thu Nov 23 03:27:50.327051 2017 |       2 |       2 |       0 |        
       2 | Thu Nov 23 06:50:30.797805 2017 |       1 |       1 |       1 |        
       2 | Thu Nov 23 06:56:38.46819 2017  |       0 |       1 |       3 |        
       2 | Thu Nov 23 08:22:22.169158 2017 |       4 |       2 |       5 |        
       2 | Thu Nov 23 08:49:47.029236 2017 |       4 |       2 |       4 |        
       2 | Thu Nov 23 09:54:28.13665 2017  |       0 |       3 |       4 |        
(10 rows)

EXECUTE prepared_test_2;
 user_id | sum 
---------+-----
       1 |  29
       3 |  29
       6 |  29
       2 |  33
       4 |  33
       5 |  33
(6 rows)

EXECUTE prepared_test_2;
 user_id | sum 
---------+-----
       1 |  29
       3 |  29
       6 |  29
       2 |  33
       4 |  33
       5 |  33
(6 rows)

EXECUTE prepared_test_2;
 user_id | sum 
---------+-----
       1 |  29
       3 |  29
       6 |  29
       2 |  33
       4 |  33
       5 |  33
(6 rows)

EXECUTE prepared_test_2;
 user_id | sum 
---------+-----
       1 |  29
       3 |  29
       6 |  29
       2 |  33
       4 |  33
       5 |  33
(6 rows)

EXECUTE prepared_test_2;
 user_id | sum 
---------+-----
       1 |  29
       3 |  29
       6 |  29
       2 |  33
       4 |  33
       5 |  33
(6 rows)

EXECUTE prepared_test_2;
 user_id | sum 
---------+-----
       1 |  29
       3 |  29
       6 |  29
       2 |  33
       4 |  33
       5 |  33
(6 rows)

EXECUTE prepared_test_3;
 user_id | sum  
---------+------
       1 |  168
       6 |  240
       5 |  936
       2 | 1080
       4 | 1104
       3 | 1122
(6 rows)

EXECUTE prepared_test_3;
 user_id | sum  
---------+------
       1 |  168
       6 |  240
       5 |  936
       2 | 1080
       4 | 1104
       3 | 1122
(6 rows)

EXECUTE prepared_test_3;
 user_id | sum  
---------+------
       1 |  168
       6 |  240
       5 |  936
       2 | 1080
       4 | 1104
       3 | 1122
(6 rows)

EXECUTE prepared_test_3;
 user_id | sum  
---------+------
       1 |  168
       6 |  240
       5 |  936
       2 | 1080
       4 | 1104
       3 | 1122
(6 rows)

EXECUTE prepared_test_3;
 user_id | sum  
---------+------
       1 |  168
       6 |  240
       5 |  936
       2 | 1080
       4 | 1104
       3 | 1122
(6 rows)

EXECUTE prepared_test_3;
 user_id | sum  
---------+------
       1 |  168
       6 |  240
       5 |  936
       2 | 1080
       4 | 1104
       3 | 1122
(6 rows)

DEALLOCATE ALL;
