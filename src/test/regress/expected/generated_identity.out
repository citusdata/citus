CREATE SCHEMA generated_identities;
SET search_path TO generated_identities;
DROP TABLE IF EXISTS test;
NOTICE:  table "test" does not exist, skipping
CREATE TABLE generated_identities_test (
    a int GENERATED BY DEFAULT AS IDENTITY,
    b bigint GENERATED ALWAYS AS IDENTITY (START WITH 10 INCREMENT BY 10),
    c smallint GENERATED BY DEFAULT AS IDENTITY,
    d serial,
    e bigserial,
    f smallserial,
    g int
)
PARTITION BY RANGE (a);
CREATE TABLE generated_identities_test_1_5 PARTITION OF generated_identities_test FOR VALUES FROM (1) TO (5);
CREATE TABLE generated_identities_test_5_50 PARTITION OF generated_identities_test FOR VALUES FROM (5) TO (50);
select create_distributed_table('generated_identities_test', 'a');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

\d generated_identities_test
               Partitioned table "generated_identities.generated_identities_test"
 Column |   Type   | Collation | Nullable |                       Default
---------------------------------------------------------------------
 a      | integer  |           | not null | generated by default as identity
 b      | bigint   |           | not null | generated always as identity
 c      | smallint |           | not null | generated by default as identity
 d      | integer  |           | not null | nextval('generated_identities_test_d_seq'::regclass)
 e      | bigint   |           | not null | nextval('generated_identities_test_e_seq'::regclass)
 f      | smallint |           | not null | nextval('generated_identities_test_f_seq'::regclass)
 g      | integer  |           |          |
Partition key: RANGE (a)
Number of partitions: 2 (Use \d+ to list them.)

\c - - - :worker_1_port
\d generated_identities_test
\c - - - :master_port
SET search_path TO generated_identities;
insert into generated_identities_test (g) values (1);
insert into generated_identities_test (g) select 2;
INSERT INTO generated_identities_test (g)
SELECT s FROM generate_series(3,7) s;
SELECT * FROM generated_identities_test ORDER BY 1;
 a | b  | c | d | e | f | g
---------------------------------------------------------------------
 1 | 10 | 1 | 1 | 1 | 1 | 1
 2 | 20 | 2 | 2 | 2 | 2 | 2
 3 | 30 | 3 | 3 | 3 | 3 | 3
 4 | 40 | 4 | 4 | 4 | 4 | 4
 5 | 50 | 5 | 5 | 5 | 5 | 5
 6 | 60 | 6 | 6 | 6 | 6 | 6
 7 | 70 | 7 | 7 | 7 | 7 | 7
(7 rows)

select undistribute_table('generated_identities_test');
NOTICE:  converting the partitions of generated_identities.generated_identities_test
NOTICE:  creating a new table for generated_identities.generated_identities_test_1_5
NOTICE:  moving the data of generated_identities.generated_identities_test_1_5
NOTICE:  dropping the old generated_identities.generated_identities_test_1_5
NOTICE:  renaming the new table to generated_identities.generated_identities_test_1_5
NOTICE:  creating a new table for generated_identities.generated_identities_test_5_50
NOTICE:  moving the data of generated_identities.generated_identities_test_5_50
NOTICE:  dropping the old generated_identities.generated_identities_test_5_50
NOTICE:  renaming the new table to generated_identities.generated_identities_test_5_50
NOTICE:  creating a new table for generated_identities.generated_identities_test
NOTICE:  dropping the old generated_identities.generated_identities_test
NOTICE:  renaming the new table to generated_identities.generated_identities_test
 undistribute_table
---------------------------------------------------------------------

(1 row)

SELECT * FROM generated_identities_test ORDER BY 1;
 a | b  | c | d | e | f | g
---------------------------------------------------------------------
 1 | 10 | 1 | 1 | 1 | 1 | 1
 2 | 20 | 2 | 2 | 2 | 2 | 2
 3 | 30 | 3 | 3 | 3 | 3 | 3
 4 | 40 | 4 | 4 | 4 | 4 | 4
 5 | 50 | 5 | 5 | 5 | 5 | 5
 6 | 60 | 6 | 6 | 6 | 6 | 6
 7 | 70 | 7 | 7 | 7 | 7 | 7
(7 rows)

\d generated_identities_test
               Partitioned table "generated_identities.generated_identities_test"
 Column |   Type   | Collation | Nullable |                       Default
---------------------------------------------------------------------
 a      | integer  |           | not null | generated by default as identity
 b      | bigint   |           | not null | generated always as identity
 c      | smallint |           | not null | generated by default as identity
 d      | integer  |           | not null | nextval('generated_identities_test_d_seq'::regclass)
 e      | bigint   |           | not null | nextval('generated_identities_test_e_seq'::regclass)
 f      | smallint |           | not null | nextval('generated_identities_test_f_seq'::regclass)
 g      | integer  |           |          |
Partition key: RANGE (a)
Number of partitions: 2 (Use \d+ to list them.)

INSERT INTO generated_identities_test (g)
SELECT s FROM generate_series(8,10) s;
SELECT * FROM generated_identities_test ORDER BY 1;
 a  |  b  | c  | d  | e  | f  | g
---------------------------------------------------------------------
  1 |  10 |  1 |  1 |  1 |  1 |  1
  2 |  20 |  2 |  2 |  2 |  2 |  2
  3 |  30 |  3 |  3 |  3 |  3 |  3
  4 |  40 |  4 |  4 |  4 |  4 |  4
  5 |  50 |  5 |  5 |  5 |  5 |  5
  6 |  60 |  6 |  6 |  6 |  6 |  6
  7 |  70 |  7 |  7 |  7 |  7 |  7
  8 |  80 |  8 |  8 |  8 |  8 |  8
  9 |  90 |  9 |  9 |  9 |  9 |  9
 10 | 100 | 10 | 10 | 10 | 10 | 10
(10 rows)

select create_distributed_table('generated_identities_test', 'a');
NOTICE:  Copying data from local table...
NOTICE:  copying the data has completed
DETAIL:  The local data in the table is no longer visible, but is still on disk.
HINT:  To remove the local data, run: SELECT truncate_local_data_after_distributing_table($$generated_identities.generated_identities_test_1_5$$)
NOTICE:  Copying data from local table...
NOTICE:  copying the data has completed
DETAIL:  The local data in the table is no longer visible, but is still on disk.
HINT:  To remove the local data, run: SELECT truncate_local_data_after_distributing_table($$generated_identities.generated_identities_test_5_50$$)
 create_distributed_table
---------------------------------------------------------------------

(1 row)

select alter_distributed_table('generated_identities_test', 'g');
NOTICE:  converting the partitions of generated_identities.generated_identities_test
NOTICE:  creating a new table for generated_identities.generated_identities_test_1_5
NOTICE:  moving the data of generated_identities.generated_identities_test_1_5
NOTICE:  dropping the old generated_identities.generated_identities_test_1_5
NOTICE:  renaming the new table to generated_identities.generated_identities_test_1_5
NOTICE:  creating a new table for generated_identities.generated_identities_test_5_50
NOTICE:  moving the data of generated_identities.generated_identities_test_5_50
NOTICE:  dropping the old generated_identities.generated_identities_test_5_50
NOTICE:  renaming the new table to generated_identities.generated_identities_test_5_50
NOTICE:  creating a new table for generated_identities.generated_identities_test
NOTICE:  dropping the old generated_identities.generated_identities_test
NOTICE:  renaming the new table to generated_identities.generated_identities_test
 alter_distributed_table
---------------------------------------------------------------------

(1 row)

select alter_distributed_table('generated_identities_test', 'b');
NOTICE:  converting the partitions of generated_identities.generated_identities_test
NOTICE:  creating a new table for generated_identities.generated_identities_test_1_5
NOTICE:  moving the data of generated_identities.generated_identities_test_1_5
NOTICE:  dropping the old generated_identities.generated_identities_test_1_5
NOTICE:  renaming the new table to generated_identities.generated_identities_test_1_5
NOTICE:  creating a new table for generated_identities.generated_identities_test_5_50
NOTICE:  moving the data of generated_identities.generated_identities_test_5_50
NOTICE:  dropping the old generated_identities.generated_identities_test_5_50
NOTICE:  renaming the new table to generated_identities.generated_identities_test_5_50
NOTICE:  creating a new table for generated_identities.generated_identities_test
NOTICE:  dropping the old generated_identities.generated_identities_test
NOTICE:  renaming the new table to generated_identities.generated_identities_test
 alter_distributed_table
---------------------------------------------------------------------

(1 row)

select alter_distributed_table('generated_identities_test', 'c');
NOTICE:  converting the partitions of generated_identities.generated_identities_test
NOTICE:  creating a new table for generated_identities.generated_identities_test_1_5
NOTICE:  moving the data of generated_identities.generated_identities_test_1_5
NOTICE:  dropping the old generated_identities.generated_identities_test_1_5
NOTICE:  renaming the new table to generated_identities.generated_identities_test_1_5
NOTICE:  creating a new table for generated_identities.generated_identities_test_5_50
NOTICE:  moving the data of generated_identities.generated_identities_test_5_50
NOTICE:  dropping the old generated_identities.generated_identities_test_5_50
NOTICE:  renaming the new table to generated_identities.generated_identities_test_5_50
NOTICE:  creating a new table for generated_identities.generated_identities_test
NOTICE:  dropping the old generated_identities.generated_identities_test
NOTICE:  renaming the new table to generated_identities.generated_identities_test
 alter_distributed_table
---------------------------------------------------------------------

(1 row)

select undistribute_table('generated_identities_test');
NOTICE:  converting the partitions of generated_identities.generated_identities_test
NOTICE:  creating a new table for generated_identities.generated_identities_test_1_5
NOTICE:  moving the data of generated_identities.generated_identities_test_1_5
NOTICE:  dropping the old generated_identities.generated_identities_test_1_5
NOTICE:  renaming the new table to generated_identities.generated_identities_test_1_5
NOTICE:  creating a new table for generated_identities.generated_identities_test_5_50
NOTICE:  moving the data of generated_identities.generated_identities_test_5_50
NOTICE:  dropping the old generated_identities.generated_identities_test_5_50
NOTICE:  renaming the new table to generated_identities.generated_identities_test_5_50
NOTICE:  creating a new table for generated_identities.generated_identities_test
NOTICE:  dropping the old generated_identities.generated_identities_test
NOTICE:  renaming the new table to generated_identities.generated_identities_test
 undistribute_table
---------------------------------------------------------------------

(1 row)

SELECT * FROM generated_identities_test ORDER BY g;
 a  |  b  | c  | d  | e  | f  | g
---------------------------------------------------------------------
  1 |  10 |  1 |  1 |  1 |  1 |  1
  2 |  20 |  2 |  2 |  2 |  2 |  2
  3 |  30 |  3 |  3 |  3 |  3 |  3
  4 |  40 |  4 |  4 |  4 |  4 |  4
  5 |  50 |  5 |  5 |  5 |  5 |  5
  6 |  60 |  6 |  6 |  6 |  6 |  6
  7 |  70 |  7 |  7 |  7 |  7 |  7
  8 |  80 |  8 |  8 |  8 |  8 |  8
  9 |  90 |  9 |  9 |  9 |  9 |  9
 10 | 100 | 10 | 10 | 10 | 10 | 10
(10 rows)

SELECT create_reference_table('generated_identities_test');
ERROR:  distributing partitioned tables in only supported for hash-distributed tables
INSERT INTO generated_identities_test (g)
SELECT s FROM generate_series(11,20) s;
SELECT * FROM generated_identities_test ORDER BY g;
 a  |  b  | c  | d  | e  | f  | g
---------------------------------------------------------------------
  1 |  10 |  1 |  1 |  1 |  1 |  1
  2 |  20 |  2 |  2 |  2 |  2 |  2
  3 |  30 |  3 |  3 |  3 |  3 |  3
  4 |  40 |  4 |  4 |  4 |  4 |  4
  5 |  50 |  5 |  5 |  5 |  5 |  5
  6 |  60 |  6 |  6 |  6 |  6 |  6
  7 |  70 |  7 |  7 |  7 |  7 |  7
  8 |  80 |  8 |  8 |  8 |  8 |  8
  9 |  90 |  9 |  9 |  9 |  9 |  9
 10 | 100 | 10 | 10 | 10 | 10 | 10
 11 | 110 | 11 | 11 | 11 | 11 | 11
 12 | 120 | 12 | 12 | 12 | 12 | 12
 13 | 130 | 13 | 13 | 13 | 13 | 13
 14 | 140 | 14 | 14 | 14 | 14 | 14
 15 | 150 | 15 | 15 | 15 | 15 | 15
 16 | 160 | 16 | 16 | 16 | 16 | 16
 17 | 170 | 17 | 17 | 17 | 17 | 17
 18 | 180 | 18 | 18 | 18 | 18 | 18
 19 | 190 | 19 | 19 | 19 | 19 | 19
 20 | 200 | 20 | 20 | 20 | 20 | 20
(20 rows)

select undistribute_table('generated_identities_test');
ERROR:  cannot undistribute table because the table is not distributed
DROP SCHEMA "generated_identities" CASCADE;
NOTICE:  drop cascades to table generated_identities_test
