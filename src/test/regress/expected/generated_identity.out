CREATE SCHEMA generated_identities;
SET search_path TO generated_identities;
SET client_min_messages to ERROR;
SELECT 1 from citus_add_node('localhost', :master_port, groupId=>0);
 ?column?
---------------------------------------------------------------------
        1
(1 row)

DROP TABLE IF EXISTS generated_identities_test;
-- create a partitioned table for testing.
CREATE TABLE generated_identities_test (
    a int CONSTRAINT myconname GENERATED BY DEFAULT AS IDENTITY,
    b bigint GENERATED ALWAYS AS IDENTITY (START WITH 10 INCREMENT BY 10),
    c smallint GENERATED BY DEFAULT AS IDENTITY,
    d serial,
    e bigserial,
    f smallserial,
    g int
)
PARTITION BY RANGE (a);
CREATE TABLE generated_identities_test_1_5 PARTITION OF generated_identities_test FOR VALUES FROM (1) TO (5);
CREATE TABLE generated_identities_test_5_50 PARTITION OF generated_identities_test FOR VALUES FROM (5) TO (50);
-- local tables
SELECT citus_add_local_table_to_metadata('generated_identities_test');
 citus_add_local_table_to_metadata
---------------------------------------------------------------------

(1 row)

SELECT r::text FROM information_schema.columns AS r WHERE table_name = 'generated_identities_test' ;
                                                                                                         r
---------------------------------------------------------------------
 (regression,generated_identities,generated_identities_test,a,1,,NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,1,NO,YES,"BY DEFAULT",1,1,2147483647,1,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,b,2,,NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,2,NO,YES,ALWAYS,10,10,9223372036854775807,1,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,c,3,,NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,3,NO,YES,"BY DEFAULT",1,1,32767,1,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,d,4,"nextval('generated_identities_test_d_seq'::regclass)",NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,4,NO,NO,,,,,,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,e,5,"nextval('generated_identities_test_e_seq'::regclass)",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,5,NO,NO,,,,,,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,f,6,"nextval('generated_identities_test_f_seq'::regclass)",NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,6,NO,NO,,,,,,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,g,7,,YES,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,7,NO,NO,,,,,,NO,NEVER,,YES)
(7 rows)

SELECT run_command_on_workers($$select json_agg(r::text) from information_schema.columns AS r WHERE table_name = 'generated_identities_test' $$);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  run_command_on_workers
---------------------------------------------------------------------
 (localhost,57637,t,"[""(regression,generated_identities,generated_identities_test,a,1,\\""worker_nextval('generated_identities.generated_identities_test_a_seq'::regclass)\\"",NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,1,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,b,2,\\""nextval('generated_identities.generated_identities_test_b_seq'::regclass)\\"",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,2,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,c,3,\\""worker_nextval('generated_identities.generated_identities_test_c_seq'::regclass)\\"",NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,3,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,d,4,\\""worker_nextval('generated_identities.generated_identities_test_d_seq'::regclass)\\"",NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,4,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,e,5,\\""nextval('generated_identities.generated_identities_test_e_seq'::regclass)\\"",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,5,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,f,6,\\""worker_nextval('generated_identities.generated_identities_test_f_seq'::regclass)\\"",NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,6,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,g,7,,YES,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,7,NO,NO,,,,,,NO,NEVER,,YES)""]")
 (localhost,57638,t,"[""(regression,generated_identities,generated_identities_test,a,1,\\""worker_nextval('generated_identities.generated_identities_test_a_seq'::regclass)\\"",NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,1,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,b,2,\\""nextval('generated_identities.generated_identities_test_b_seq'::regclass)\\"",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,2,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,c,3,\\""worker_nextval('generated_identities.generated_identities_test_c_seq'::regclass)\\"",NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,3,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,d,4,\\""worker_nextval('generated_identities.generated_identities_test_d_seq'::regclass)\\"",NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,4,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,e,5,\\""nextval('generated_identities.generated_identities_test_e_seq'::regclass)\\"",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,5,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,f,6,\\""worker_nextval('generated_identities.generated_identities_test_f_seq'::regclass)\\"",NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,6,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,g,7,,YES,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,7,NO,NO,,,,,,NO,NEVER,,YES)""]")
(2 rows)

SELECT undistribute_table('generated_identities_test');
 undistribute_table
---------------------------------------------------------------------

(1 row)

SELECT citus_remove_node('localhost', :master_port);
 citus_remove_node
---------------------------------------------------------------------

(1 row)

SELECT create_distributed_table('generated_identities_test', 'a');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

SELECT r::text FROM information_schema.columns AS r WHERE table_name = 'generated_identities_test' ;
                                                                                                         r
---------------------------------------------------------------------
 (regression,generated_identities,generated_identities_test,a,1,,NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,1,NO,YES,"BY DEFAULT",1,1,2147483647,1,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,b,2,,NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,2,NO,YES,ALWAYS,10,10,9223372036854775807,1,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,c,3,,NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,3,NO,YES,"BY DEFAULT",1,1,32767,1,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,d,4,"nextval('generated_identities_test_d_seq'::regclass)",NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,4,NO,NO,,,,,,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,e,5,"nextval('generated_identities_test_e_seq'::regclass)",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,5,NO,NO,,,,,,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,f,6,"nextval('generated_identities_test_f_seq'::regclass)",NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,6,NO,NO,,,,,,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,g,7,,YES,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,7,NO,NO,,,,,,NO,NEVER,,YES)
(7 rows)

SELECT run_command_on_workers($$select json_agg(r::text) from information_schema.columns AS r WHERE table_name = 'generated_identities_test' $$);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  run_command_on_workers
---------------------------------------------------------------------
 (localhost,57637,t,"[""(regression,generated_identities,generated_identities_test,a,1,\\""worker_nextval('generated_identities.generated_identities_test_a_seq'::regclass)\\"",NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,1,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,b,2,\\""nextval('generated_identities.generated_identities_test_b_seq'::regclass)\\"",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,2,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,c,3,\\""worker_nextval('generated_identities.generated_identities_test_c_seq'::regclass)\\"",NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,3,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,d,4,\\""worker_nextval('generated_identities.generated_identities_test_d_seq'::regclass)\\"",NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,4,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,e,5,\\""nextval('generated_identities.generated_identities_test_e_seq'::regclass)\\"",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,5,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,f,6,\\""worker_nextval('generated_identities.generated_identities_test_f_seq'::regclass)\\"",NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,6,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,g,7,,YES,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,7,NO,NO,,,,,,NO,NEVER,,YES)""]")
 (localhost,57638,t,"[""(regression,generated_identities,generated_identities_test,a,1,\\""worker_nextval('generated_identities.generated_identities_test_a_seq'::regclass)\\"",NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,1,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,b,2,\\""nextval('generated_identities.generated_identities_test_b_seq'::regclass)\\"",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,2,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,c,3,\\""worker_nextval('generated_identities.generated_identities_test_c_seq'::regclass)\\"",NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,3,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,d,4,\\""worker_nextval('generated_identities.generated_identities_test_d_seq'::regclass)\\"",NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,4,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,e,5,\\""nextval('generated_identities.generated_identities_test_e_seq'::regclass)\\"",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,5,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,f,6,\\""worker_nextval('generated_identities.generated_identities_test_f_seq'::regclass)\\"",NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,6,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,g,7,,YES,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,7,NO,NO,,,,,,NO,NEVER,,YES)""]")
(2 rows)

insert into generated_identities_test (g) values (1);
insert into generated_identities_test (g) SELECT 2;
INSERT INTO generated_identities_test (g)
SELECT s FROM generate_series(3,7) s;
SELECT * FROM generated_identities_test ORDER BY 1;
 a | b  | c | d | e | f | g
---------------------------------------------------------------------
 1 | 10 | 1 | 1 | 1 | 1 | 1
 2 | 20 | 2 | 2 | 2 | 2 | 2
 3 | 30 | 3 | 3 | 3 | 3 | 3
 4 | 40 | 4 | 4 | 4 | 4 | 4
 5 | 50 | 5 | 5 | 5 | 5 | 5
 6 | 60 | 6 | 6 | 6 | 6 | 6
 7 | 70 | 7 | 7 | 7 | 7 | 7
(7 rows)

SELECT undistribute_table('generated_identities_test');
 undistribute_table
---------------------------------------------------------------------

(1 row)

SELECT * FROM generated_identities_test ORDER BY 1;
 a | b  | c | d | e | f | g
---------------------------------------------------------------------
 1 | 10 | 1 | 1 | 1 | 1 | 1
 2 | 20 | 2 | 2 | 2 | 2 | 2
 3 | 30 | 3 | 3 | 3 | 3 | 3
 4 | 40 | 4 | 4 | 4 | 4 | 4
 5 | 50 | 5 | 5 | 5 | 5 | 5
 6 | 60 | 6 | 6 | 6 | 6 | 6
 7 | 70 | 7 | 7 | 7 | 7 | 7
(7 rows)

SELECT r::text FROM information_schema.columns AS r WHERE table_name = 'generated_identities_test' ;
                                                                                                         r
---------------------------------------------------------------------
 (regression,generated_identities,generated_identities_test,a,1,,NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,1,NO,YES,"BY DEFAULT",8,1,2147483647,1,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,b,2,,NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,2,NO,YES,ALWAYS,80,10,9223372036854775807,1,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,c,3,,NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,3,NO,YES,"BY DEFAULT",8,1,32767,1,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,d,4,"nextval('generated_identities_test_d_seq'::regclass)",NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,4,NO,NO,,,,,,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,e,5,"nextval('generated_identities_test_e_seq'::regclass)",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,5,NO,NO,,,,,,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,f,6,"nextval('generated_identities_test_f_seq'::regclass)",NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,6,NO,NO,,,,,,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,g,7,,YES,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,7,NO,NO,,,,,,NO,NEVER,,YES)
(7 rows)

SELECT run_command_on_workers($$select json_agg(r::text) from information_schema.columns AS r WHERE table_name = 'generated_identities_test' $$);
 run_command_on_workers
---------------------------------------------------------------------
 (localhost,57637,t,"")
 (localhost,57638,t,"")
(2 rows)

INSERT INTO generated_identities_test (g)
SELECT s FROM generate_series(8,10) s;
SELECT * FROM generated_identities_test ORDER BY 1;
 a  |  b  | c  | d  | e  | f  | g
---------------------------------------------------------------------
  1 |  10 |  1 |  1 |  1 |  1 |  1
  2 |  20 |  2 |  2 |  2 |  2 |  2
  3 |  30 |  3 |  3 |  3 |  3 |  3
  4 |  40 |  4 |  4 |  4 |  4 |  4
  5 |  50 |  5 |  5 |  5 |  5 |  5
  6 |  60 |  6 |  6 |  6 |  6 |  6
  7 |  70 |  7 |  7 |  7 |  7 |  7
  8 |  80 |  8 |  8 |  8 |  8 |  8
  9 |  90 |  9 |  9 |  9 |  9 |  9
 10 | 100 | 10 | 10 | 10 | 10 | 10
(10 rows)

-- distributed table
SELECT create_distributed_table('generated_identities_test', 'a');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

-- alter table .. alter column .. add is unsupported
ALTER TABLE generated_identities_test ALTER COLUMN g ADD GENERATED ALWAYS AS IDENTITY;
ERROR:  alter table command is currently unsupported
DETAIL:  Only ADD|DROP COLUMN, SET|DROP NOT NULL, SET|DROP DEFAULT, ADD|DROP|VALIDATE CONSTRAINT, SET (), RESET (), ENABLE|DISABLE|NO FORCE|FORCE ROW LEVEL SECURITY, ATTACH|DETACH PARTITION and TYPE subcommands are supported.
-- alter table .. alter column is unsupported
ALTER TABLE generated_identities_test ALTER COLUMN b TYPE int;
ERROR:  cannot execute ALTER COLUMN command involving identity column
SELECT alter_distributed_table('generated_identities_test', 'g');
 alter_distributed_table
---------------------------------------------------------------------

(1 row)

SELECT alter_distributed_table('generated_identities_test', 'b');
 alter_distributed_table
---------------------------------------------------------------------

(1 row)

SELECT alter_distributed_table('generated_identities_test', 'c');
 alter_distributed_table
---------------------------------------------------------------------

(1 row)

SELECT undistribute_table('generated_identities_test');
 undistribute_table
---------------------------------------------------------------------

(1 row)

SELECT * FROM generated_identities_test ORDER BY g;
 a  |  b  | c  | d  | e  | f  | g
---------------------------------------------------------------------
  1 |  10 |  1 |  1 |  1 |  1 |  1
  2 |  20 |  2 |  2 |  2 |  2 |  2
  3 |  30 |  3 |  3 |  3 |  3 |  3
  4 |  40 |  4 |  4 |  4 |  4 |  4
  5 |  50 |  5 |  5 |  5 |  5 |  5
  6 |  60 |  6 |  6 |  6 |  6 |  6
  7 |  70 |  7 |  7 |  7 |  7 |  7
  8 |  80 |  8 |  8 |  8 |  8 |  8
  9 |  90 |  9 |  9 |  9 |  9 |  9
 10 | 100 | 10 | 10 | 10 | 10 | 10
(10 rows)

-- reference table
DROP TABLE generated_identities_test;
CREATE TABLE generated_identities_test (
    a int GENERATED BY DEFAULT AS IDENTITY,
    b bigint GENERATED ALWAYS AS IDENTITY (START WITH 10 INCREMENT BY 10),
    c smallint GENERATED BY DEFAULT AS IDENTITY,
    d serial,
    e bigserial,
    f smallserial,
    g int
);
SELECT create_reference_table('generated_identities_test');
 create_reference_table
---------------------------------------------------------------------

(1 row)

SELECT r::text FROM information_schema.columns AS r WHERE table_name = 'generated_identities_test' ;
                                                                                                         r
---------------------------------------------------------------------
 (regression,generated_identities,generated_identities_test,a,1,,NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,1,NO,YES,"BY DEFAULT",1,1,2147483647,1,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,b,2,,NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,2,NO,YES,ALWAYS,10,10,9223372036854775807,1,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,c,3,,NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,3,NO,YES,"BY DEFAULT",1,1,32767,1,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,d,4,"nextval('generated_identities_test_d_seq'::regclass)",NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,4,NO,NO,,,,,,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,e,5,"nextval('generated_identities_test_e_seq'::regclass)",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,5,NO,NO,,,,,,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,f,6,"nextval('generated_identities_test_f_seq'::regclass)",NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,6,NO,NO,,,,,,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,g,7,,YES,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,7,NO,NO,,,,,,NO,NEVER,,YES)
(7 rows)

SELECT run_command_on_workers($$select json_agg(r::text) from information_schema.columns AS r WHERE table_name = 'generated_identities_test' $$);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  run_command_on_workers
---------------------------------------------------------------------
 (localhost,57637,t,"[""(regression,generated_identities,generated_identities_test,a,1,\\""worker_nextval('generated_identities.generated_identities_test_a_seq'::regclass)\\"",NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,1,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,b,2,\\""nextval('generated_identities.generated_identities_test_b_seq'::regclass)\\"",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,2,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,c,3,\\""worker_nextval('generated_identities.generated_identities_test_c_seq'::regclass)\\"",NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,3,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,d,4,\\""worker_nextval('generated_identities.generated_identities_test_d_seq'::regclass)\\"",NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,4,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,e,5,\\""nextval('generated_identities.generated_identities_test_e_seq'::regclass)\\"",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,5,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,f,6,\\""worker_nextval('generated_identities.generated_identities_test_f_seq'::regclass)\\"",NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,6,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,g,7,,YES,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,7,NO,NO,,,,,,NO,NEVER,,YES)""]")
 (localhost,57638,t,"[""(regression,generated_identities,generated_identities_test,a,1,\\""worker_nextval('generated_identities.generated_identities_test_a_seq'::regclass)\\"",NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,1,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,b,2,\\""nextval('generated_identities.generated_identities_test_b_seq'::regclass)\\"",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,2,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,c,3,\\""worker_nextval('generated_identities.generated_identities_test_c_seq'::regclass)\\"",NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,3,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,d,4,\\""worker_nextval('generated_identities.generated_identities_test_d_seq'::regclass)\\"",NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,4,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,e,5,\\""nextval('generated_identities.generated_identities_test_e_seq'::regclass)\\"",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,5,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,f,6,\\""worker_nextval('generated_identities.generated_identities_test_f_seq'::regclass)\\"",NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,6,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,generated_identities_test,g,7,,YES,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,7,NO,NO,,,,,,NO,NEVER,,YES)""]")
(2 rows)

INSERT INTO generated_identities_test (g)
SELECT s FROM generate_series(11,20) s;
SELECT * FROM generated_identities_test ORDER BY g;
 a  |  b  | c  | d  | e  | f  | g
---------------------------------------------------------------------
  1 |  10 |  1 |  1 |  1 |  1 | 11
  2 |  20 |  2 |  2 |  2 |  2 | 12
  3 |  30 |  3 |  3 |  3 |  3 | 13
  4 |  40 |  4 |  4 |  4 |  4 | 14
  5 |  50 |  5 |  5 |  5 |  5 | 15
  6 |  60 |  6 |  6 |  6 |  6 | 16
  7 |  70 |  7 |  7 |  7 |  7 | 17
  8 |  80 |  8 |  8 |  8 |  8 | 18
  9 |  90 |  9 |  9 |  9 |  9 | 19
 10 | 100 | 10 | 10 | 10 | 10 | 20
(10 rows)

SELECT undistribute_table('generated_identities_test');
 undistribute_table
---------------------------------------------------------------------

(1 row)

SELECT r::text FROM information_schema.columns AS r WHERE table_name = 'generated_identities_test' ;
                                                                                                         r
---------------------------------------------------------------------
 (regression,generated_identities,generated_identities_test,a,1,,NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,1,NO,YES,"BY DEFAULT",11,1,2147483647,1,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,b,2,,NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,2,NO,YES,ALWAYS,110,10,9223372036854775807,1,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,c,3,,NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,3,NO,YES,"BY DEFAULT",11,1,32767,1,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,d,4,"nextval('generated_identities_test_d_seq'::regclass)",NO,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,4,NO,NO,,,,,,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,e,5,"nextval('generated_identities_test_e_seq'::regclass)",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,5,NO,NO,,,,,,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,f,6,"nextval('generated_identities_test_f_seq'::regclass)",NO,smallint,,,16,2,0,,,,,,,,,,,,,regression,pg_catalog,int2,,,,,6,NO,NO,,,,,,NO,NEVER,,YES)
 (regression,generated_identities,generated_identities_test,g,7,,YES,integer,,,32,2,0,,,,,,,,,,,,,regression,pg_catalog,int4,,,,,7,NO,NO,,,,,,NO,NEVER,,YES)
(7 rows)

SELECT run_command_on_workers($$select json_agg(r::text) from information_schema.columns AS r WHERE table_name = 'generated_identities_test' $$);
 run_command_on_workers
---------------------------------------------------------------------
 (localhost,57637,t,"")
 (localhost,57638,t,"")
(2 rows)

-- alter table .. add column .. GENERATED .. AS IDENTITY
DROP TABLE IF EXISTS color;
CREATE TABLE color (
    color_name VARCHAR NOT NULL
);
SELECT create_distributed_table('color', 'color_name');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

ALTER TABLE color ADD COLUMN color_id BIGINT GENERATED ALWAYS AS IDENTITY;
INSERT INTO color(color_name) VALUES ('Red');
ALTER TABLE color ADD COLUMN color_id_1 BIGINT GENERATED ALWAYS AS IDENTITY;
ERROR:  Cannot add an identity column because the table is not empty
DROP TABLE color;
-- insert data from workers
CREATE TABLE color (
    color_id BIGINT GENERATED ALWAYS AS IDENTITY UNIQUE,
    color_name VARCHAR NOT NULL
);
SELECT create_distributed_table('color', 'color_id');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

SELECT run_command_on_workers($$INSERT INTO generated_identities.color(color_name) VALUES ('Red');$$);
      run_command_on_workers
---------------------------------------------------------------------
 (localhost,57637,t,"INSERT 0 1")
 (localhost,57638,t,"INSERT 0 1")
(2 rows)

SELECT undistribute_table('color');
 undistribute_table
---------------------------------------------------------------------

(1 row)

SELECT create_distributed_table('color', 'color_id');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

SELECT run_command_on_workers($$INSERT INTO generated_identities.color(color_name) VALUES ('Red');$$);
      run_command_on_workers
---------------------------------------------------------------------
 (localhost,57637,t,"INSERT 0 1")
 (localhost,57638,t,"INSERT 0 1")
(2 rows)

INSERT INTO color(color_name) VALUES ('Red');
SELECT count(*) from color;
 count
---------------------------------------------------------------------
     5
(1 row)

-- modify sequence & alter table
DROP TABLE color;
CREATE TABLE color (
    color_id BIGINT GENERATED ALWAYS AS IDENTITY UNIQUE,
    color_name VARCHAR NOT NULL
);
SELECT create_distributed_table('color', 'color_id');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

SELECT run_command_on_workers($$INSERT INTO generated_identities.color(color_name) VALUES ('Red');$$);
      run_command_on_workers
---------------------------------------------------------------------
 (localhost,57637,t,"INSERT 0 1")
 (localhost,57638,t,"INSERT 0 1")
(2 rows)

SELECT undistribute_table('color');
 undistribute_table
---------------------------------------------------------------------

(1 row)

ALTER SEQUENCE color_color_id_seq RENAME TO myseq;
SELECT create_distributed_table('color', 'color_id');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

SELECT run_command_on_workers($$INSERT INTO generated_identities.color(color_name) VALUES ('Red');$$);
      run_command_on_workers
---------------------------------------------------------------------
 (localhost,57637,t,"INSERT 0 1")
 (localhost,57638,t,"INSERT 0 1")
(2 rows)

select * from pg_catalog.pg_sequences where sequencename = 'myseq';
      schemaname      | sequencename | sequenceowner | data_type | start_value | min_value |      max_value      | increment_by | cycle | cache_size | last_value
---------------------------------------------------------------------
 generated_identities | myseq        | postgres      | bigint    |           1 |         1 | 9223372036854775807 |            1 | f     |          1 |
(1 row)

select * from pg_catalog.pg_sequences where sequencename = 'color_color_id_seq';
 schemaname | sequencename | sequenceowner | data_type | start_value | min_value | max_value | increment_by | cycle | cache_size | last_value
---------------------------------------------------------------------
(0 rows)

select * from information_schema.columns where table_name = 'color' ;
 table_catalog |     table_schema     | table_name | column_name | ordinal_position | column_default | is_nullable |     data_type     | character_maximum_length | character_octet_length | numeric_precision | numeric_precision_radix | numeric_scale | datetime_precision | interval_type | interval_precision | character_set_catalog | character_set_schema | character_set_name | collation_catalog | collation_schema | collation_name | domain_catalog | domain_schema | domain_name | udt_catalog | udt_schema | udt_name | scope_catalog | scope_schema | scope_name | maximum_cardinality | dtd_identifier | is_self_referencing | is_identity | identity_generation | identity_start | identity_increment |  identity_maximum   | identity_minimum | identity_cycle | is_generated | generation_expression | is_updatable
---------------------------------------------------------------------
 regression    | generated_identities | color      | color_id    |                1 |                | NO          | bigint            |                          |                        |                64 |                       2 |             0 |                    |               |                    |                       |                      |                    |                   |                  |                |                |               |             | regression  | pg_catalog | int8     |               |              |            |                     | 1              | NO                  | YES         | ALWAYS              | 1              | 1                  | 9223372036854775807 | 1                | NO             | NEVER        |                       | YES
 regression    | generated_identities | color      | color_name  |                2 |                | NO          | character varying |                          |             1073741824 |                   |                         |               |                    |               |                    |                       |                      |                    |                   |                  |                |                |               |             | regression  | pg_catalog | varchar  |               |              |            |                     | 2              | NO                  | NO          |                     |                |                    |                     |                  | NO             | NEVER        |                       | YES
(2 rows)

SELECT run_command_on_workers($$select s::text from pg_catalog.pg_sequences as s where sequencename = 'myseq'$$);
                                                            run_command_on_workers
---------------------------------------------------------------------
 (localhost,57637,t,"(generated_identities,myseq,postgres,bigint,3940649673949185,3940649673949185,4222124650659841,1,f,1,3940649673949186)")
 (localhost,57638,t,"(generated_identities,myseq,postgres,bigint,4503599627370497,4503599627370497,4785074604081153,1,f,1,4503599627370498)")
(2 rows)

SELECT run_command_on_workers($$select s::text from pg_catalog.pg_sequences as s where sequencename = 'color_color_id_seq'$$);
 run_command_on_workers
---------------------------------------------------------------------
 (localhost,57637,t,"")
 (localhost,57638,t,"")
(2 rows)

SELECT run_command_on_workers($$select json_agg(r::text) from information_schema.columns AS r WHERE table_name = 'color' $$);
                                                                                                                                                                                             run_command_on_workers
---------------------------------------------------------------------
 (localhost,57637,t,"[""(regression,generated_identities,color,color_id,1,\\""nextval('generated_identities.myseq'::regclass)\\"",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,1,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,color,color_name,2,,NO,\\""character varying\\"",,1073741824,,,,,,,,,,,,,,,,regression,pg_catalog,varchar,,,,,2,NO,NO,,,,,,NO,NEVER,,YES)""]")
 (localhost,57638,t,"[""(regression,generated_identities,color,color_id,1,\\""nextval('generated_identities.myseq'::regclass)\\"",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,1,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,color,color_name,2,,NO,\\""character varying\\"",,1073741824,,,,,,,,,,,,,,,,regression,pg_catalog,varchar,,,,,2,NO,NO,,,,,,NO,NEVER,,YES)""]")
(2 rows)

INSERT INTO color(color_name) VALUES ('Red');
ALTER SEQUENCE myseq RENAME TO color_color_id_seq;
select * from pg_catalog.pg_sequences where sequencename = 'myseq';
 schemaname | sequencename | sequenceowner | data_type | start_value | min_value | max_value | increment_by | cycle | cache_size | last_value
---------------------------------------------------------------------
(0 rows)

select * from pg_catalog.pg_sequences where sequencename = 'color_color_id_seq';
      schemaname      |    sequencename    | sequenceowner | data_type | start_value | min_value |      max_value      | increment_by | cycle | cache_size | last_value
---------------------------------------------------------------------
 generated_identities | color_color_id_seq | postgres      | bigint    |           1 |         1 | 9223372036854775807 |            1 | f     |          1 |          1
(1 row)

INSERT INTO color(color_name) VALUES ('Red');
SELECT run_command_on_workers($$select s::text from pg_catalog.pg_sequences as s where sequencename = 'myseq'$$);
 run_command_on_workers
---------------------------------------------------------------------
 (localhost,57637,t,"")
 (localhost,57638,t,"")
(2 rows)

SELECT run_command_on_workers($$select s::text from pg_catalog.pg_sequences as s where sequencename = 'color_color_id_seq'$$);
                                                                  run_command_on_workers
---------------------------------------------------------------------
 (localhost,57637,t,"(generated_identities,color_color_id_seq,postgres,bigint,3940649673949185,3940649673949185,4222124650659841,1,f,1,3940649673949186)")
 (localhost,57638,t,"(generated_identities,color_color_id_seq,postgres,bigint,4503599627370497,4503599627370497,4785074604081153,1,f,1,4503599627370498)")
(2 rows)

SELECT run_command_on_workers($$select json_agg(r::text) from information_schema.columns AS r WHERE table_name = 'color' $$);
                                                                                                                                                                                                    run_command_on_workers
---------------------------------------------------------------------
 (localhost,57637,t,"[""(regression,generated_identities,color,color_id,1,\\""nextval('generated_identities.color_color_id_seq'::regclass)\\"",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,1,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,color,color_name,2,,NO,\\""character varying\\"",,1073741824,,,,,,,,,,,,,,,,regression,pg_catalog,varchar,,,,,2,NO,NO,,,,,,NO,NEVER,,YES)""]")
 (localhost,57638,t,"[""(regression,generated_identities,color,color_id,1,\\""nextval('generated_identities.color_color_id_seq'::regclass)\\"",NO,bigint,,,64,2,0,,,,,,,,,,,,,regression,pg_catalog,int8,,,,,1,NO,NO,,,,,,NO,NEVER,,YES)"", ""(regression,generated_identities,color,color_name,2,,NO,\\""character varying\\"",,1073741824,,,,,,,,,,,,,,,,regression,pg_catalog,varchar,,,,,2,NO,NO,,,,,,NO,NEVER,,YES)""]")
(2 rows)

INSERT INTO color(color_name) VALUES ('Red');
SELECT alter_distributed_table('color', shard_count := 6);
 alter_distributed_table
---------------------------------------------------------------------

(1 row)

INSERT INTO color(color_name) VALUES ('Red');
SELECT run_command_on_workers($$INSERT INTO generated_identities.color(color_name) VALUES ('Red');$$);
      run_command_on_workers
---------------------------------------------------------------------
 (localhost,57637,t,"INSERT 0 1")
 (localhost,57638,t,"INSERT 0 1")
(2 rows)

select * from pg_catalog.pg_sequences where sequencename = 'color_color_id_seq';
      schemaname      |    sequencename    | sequenceowner | data_type | start_value | min_value |      max_value      | increment_by | cycle | cache_size | last_value
---------------------------------------------------------------------
 generated_identities | color_color_id_seq | postgres      | bigint    |           4 |         1 | 9223372036854775807 |            1 | f     |          1 |          4
(1 row)

DROP SCHEMA generated_identities CASCADE;
