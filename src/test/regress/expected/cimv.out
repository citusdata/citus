--
-- CIMV
--   Tests for Citus Incremental Materialized Views
--
\set VERBOSITY terse
SET citus.next_shard_id TO 400000;
CREATE SCHEMA cimv;
SET search_path TO cimv, public;
SET citus.shard_count TO 4;
CREATE TABLE events (a int, b int, c double precision, d timestamp, e bigint);
INSERT INTO events
SELECT v % 10 AS a,
       v % 100 AS b,
       v / 3.0 AS c,
       timestamp '2020-01-01 20:00:00' +
       ((v / 10000.0) * (timestamp '2020-01-01 15:00:00' -
                   timestamp '2020-01-01 10:00:00')) AS d,
       v AS e
FROM generate_series(1, 10000) v;
CREATE MATERIALIZED VIEW mv WITH (citus.cimv) AS
SELECT a,
       date_trunc('hour', d) AS d_hour,
       min(b) AS min_b,
       max(b) AS max_b,
       avg(b) AS avg_b,
       min(c) AS min_c,
       max(c) AS max_c,
       avg(c) AS avg_c,
       min(e) AS min_e,
       max(e) AS max_e,
       avg(e) AS avg_e
FROM events
WHERE b > 10
GROUP BY a, d_hour;
SELECT a,
       d_hour,
       min_b::numeric(12,2),
       max_b::numeric(12,2),
       avg_b::numeric(12,2),
       min_c::numeric(12,2),
       max_c::numeric(12,2),
       avg_c::numeric(12,2),
       min_e::numeric(12,2),
       max_e::numeric(12,2),
       avg_e::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          | min_b | max_b | avg_b |  min_c  |  max_c  |  avg_c  |  min_e  |  max_e  |  avg_e
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 20.00 | 90.00 | 55.00 |    6.67 |  663.33 |  335.00 |   20.00 | 1990.00 | 1005.00
 0 | Wed Jan 01 21:00:00 2020 | 20.00 | 90.00 | 55.00 |  673.33 | 1330.00 | 1001.67 | 2020.00 | 3990.00 | 3005.00
 0 | Wed Jan 01 22:00:00 2020 | 20.00 | 90.00 | 55.00 | 1340.00 | 1996.67 | 1668.33 | 4020.00 | 5990.00 | 5005.00
 0 | Wed Jan 01 23:00:00 2020 | 20.00 | 90.00 | 55.00 | 2006.67 | 2663.33 | 2335.00 | 6020.00 | 7990.00 | 7005.00
 0 | Thu Jan 02 00:00:00 2020 | 20.00 | 90.00 | 55.00 | 2673.33 | 3330.00 | 3001.67 | 8020.00 | 9990.00 | 9005.00
 1 | Wed Jan 01 20:00:00 2020 | 11.00 | 91.00 | 51.00 |    3.67 |  663.67 |  333.67 |   11.00 | 1991.00 | 1001.00
 1 | Wed Jan 01 21:00:00 2020 | 11.00 | 91.00 | 51.00 |  670.33 | 1330.33 | 1000.33 | 2011.00 | 3991.00 | 3001.00
 1 | Wed Jan 01 22:00:00 2020 | 11.00 | 91.00 | 51.00 | 1337.00 | 1997.00 | 1667.00 | 4011.00 | 5991.00 | 5001.00
 1 | Wed Jan 01 23:00:00 2020 | 11.00 | 91.00 | 51.00 | 2003.67 | 2663.67 | 2333.67 | 6011.00 | 7991.00 | 7001.00
 1 | Thu Jan 02 00:00:00 2020 | 11.00 | 91.00 | 51.00 | 2670.33 | 3330.33 | 3000.33 | 8011.00 | 9991.00 | 9001.00
 2 | Wed Jan 01 20:00:00 2020 | 12.00 | 92.00 | 52.00 |    4.00 |  664.00 |  334.00 |   12.00 | 1992.00 | 1002.00
 2 | Wed Jan 01 21:00:00 2020 | 12.00 | 92.00 | 52.00 |  670.67 | 1330.67 | 1000.67 | 2012.00 | 3992.00 | 3002.00
 2 | Wed Jan 01 22:00:00 2020 | 12.00 | 92.00 | 52.00 | 1337.33 | 1997.33 | 1667.33 | 4012.00 | 5992.00 | 5002.00
 2 | Wed Jan 01 23:00:00 2020 | 12.00 | 92.00 | 52.00 | 2004.00 | 2664.00 | 2334.00 | 6012.00 | 7992.00 | 7002.00
 2 | Thu Jan 02 00:00:00 2020 | 12.00 | 92.00 | 52.00 | 2670.67 | 3330.67 | 3000.67 | 8012.00 | 9992.00 | 9002.00
 3 | Wed Jan 01 20:00:00 2020 | 13.00 | 93.00 | 53.00 |    4.33 |  664.33 |  334.33 |   13.00 | 1993.00 | 1003.00
 3 | Wed Jan 01 21:00:00 2020 | 13.00 | 93.00 | 53.00 |  671.00 | 1331.00 | 1001.00 | 2013.00 | 3993.00 | 3003.00
 3 | Wed Jan 01 22:00:00 2020 | 13.00 | 93.00 | 53.00 | 1337.67 | 1997.67 | 1667.67 | 4013.00 | 5993.00 | 5003.00
 3 | Wed Jan 01 23:00:00 2020 | 13.00 | 93.00 | 53.00 | 2004.33 | 2664.33 | 2334.33 | 6013.00 | 7993.00 | 7003.00
 3 | Thu Jan 02 00:00:00 2020 | 13.00 | 93.00 | 53.00 | 2671.00 | 3331.00 | 3001.00 | 8013.00 | 9993.00 | 9003.00
 4 | Wed Jan 01 20:00:00 2020 | 14.00 | 94.00 | 54.00 |    4.67 |  664.67 |  334.67 |   14.00 | 1994.00 | 1004.00
 4 | Wed Jan 01 21:00:00 2020 | 14.00 | 94.00 | 54.00 |  671.33 | 1331.33 | 1001.33 | 2014.00 | 3994.00 | 3004.00
 4 | Wed Jan 01 22:00:00 2020 | 14.00 | 94.00 | 54.00 | 1338.00 | 1998.00 | 1668.00 | 4014.00 | 5994.00 | 5004.00
 4 | Wed Jan 01 23:00:00 2020 | 14.00 | 94.00 | 54.00 | 2004.67 | 2664.67 | 2334.67 | 6014.00 | 7994.00 | 7004.00
 4 | Thu Jan 02 00:00:00 2020 | 14.00 | 94.00 | 54.00 | 2671.33 | 3331.33 | 3001.33 | 8014.00 | 9994.00 | 9004.00
 5 | Wed Jan 01 20:00:00 2020 | 15.00 | 95.00 | 55.00 |    5.00 |  665.00 |  335.00 |   15.00 | 1995.00 | 1005.00
 5 | Wed Jan 01 21:00:00 2020 | 15.00 | 95.00 | 55.00 |  671.67 | 1331.67 | 1001.67 | 2015.00 | 3995.00 | 3005.00
 5 | Wed Jan 01 22:00:00 2020 | 15.00 | 95.00 | 55.00 | 1338.33 | 1998.33 | 1668.33 | 4015.00 | 5995.00 | 5005.00
 5 | Wed Jan 01 23:00:00 2020 | 15.00 | 95.00 | 55.00 | 2005.00 | 2665.00 | 2335.00 | 6015.00 | 7995.00 | 7005.00
 5 | Thu Jan 02 00:00:00 2020 | 15.00 | 95.00 | 55.00 | 2671.67 | 3331.67 | 3001.67 | 8015.00 | 9995.00 | 9005.00
 6 | Wed Jan 01 20:00:00 2020 | 16.00 | 96.00 | 56.00 |    5.33 |  665.33 |  335.33 |   16.00 | 1996.00 | 1006.00
 6 | Wed Jan 01 21:00:00 2020 | 16.00 | 96.00 | 56.00 |  672.00 | 1332.00 | 1002.00 | 2016.00 | 3996.00 | 3006.00
 6 | Wed Jan 01 22:00:00 2020 | 16.00 | 96.00 | 56.00 | 1338.67 | 1998.67 | 1668.67 | 4016.00 | 5996.00 | 5006.00
 6 | Wed Jan 01 23:00:00 2020 | 16.00 | 96.00 | 56.00 | 2005.33 | 2665.33 | 2335.33 | 6016.00 | 7996.00 | 7006.00
 6 | Thu Jan 02 00:00:00 2020 | 16.00 | 96.00 | 56.00 | 2672.00 | 3332.00 | 3002.00 | 8016.00 | 9996.00 | 9006.00
 7 | Wed Jan 01 20:00:00 2020 | 17.00 | 97.00 | 57.00 |    5.67 |  665.67 |  335.67 |   17.00 | 1997.00 | 1007.00
 7 | Wed Jan 01 21:00:00 2020 | 17.00 | 97.00 | 57.00 |  672.33 | 1332.33 | 1002.33 | 2017.00 | 3997.00 | 3007.00
 7 | Wed Jan 01 22:00:00 2020 | 17.00 | 97.00 | 57.00 | 1339.00 | 1999.00 | 1669.00 | 4017.00 | 5997.00 | 5007.00
 7 | Wed Jan 01 23:00:00 2020 | 17.00 | 97.00 | 57.00 | 2005.67 | 2665.67 | 2335.67 | 6017.00 | 7997.00 | 7007.00
 7 | Thu Jan 02 00:00:00 2020 | 17.00 | 97.00 | 57.00 | 2672.33 | 3332.33 | 3002.33 | 8017.00 | 9997.00 | 9007.00
 8 | Wed Jan 01 20:00:00 2020 | 18.00 | 98.00 | 58.00 |    6.00 |  666.00 |  336.00 |   18.00 | 1998.00 | 1008.00
 8 | Wed Jan 01 21:00:00 2020 | 18.00 | 98.00 | 58.00 |  672.67 | 1332.67 | 1002.67 | 2018.00 | 3998.00 | 3008.00
 8 | Wed Jan 01 22:00:00 2020 | 18.00 | 98.00 | 58.00 | 1339.33 | 1999.33 | 1669.33 | 4018.00 | 5998.00 | 5008.00
 8 | Wed Jan 01 23:00:00 2020 | 18.00 | 98.00 | 58.00 | 2006.00 | 2666.00 | 2336.00 | 6018.00 | 7998.00 | 7008.00
 8 | Thu Jan 02 00:00:00 2020 | 18.00 | 98.00 | 58.00 | 2672.67 | 3332.67 | 3002.67 | 8018.00 | 9998.00 | 9008.00
 9 | Wed Jan 01 20:00:00 2020 | 19.00 | 99.00 | 59.00 |    6.33 |  666.33 |  336.33 |   19.00 | 1999.00 | 1009.00
 9 | Wed Jan 01 21:00:00 2020 | 19.00 | 99.00 | 59.00 |  673.00 | 1333.00 | 1003.00 | 2019.00 | 3999.00 | 3009.00
 9 | Wed Jan 01 22:00:00 2020 | 19.00 | 99.00 | 59.00 | 1339.67 | 1999.67 | 1669.67 | 4019.00 | 5999.00 | 5009.00
 9 | Wed Jan 01 23:00:00 2020 | 19.00 | 99.00 | 59.00 | 2006.33 | 2666.33 | 2336.33 | 6019.00 | 7999.00 | 7009.00
 9 | Thu Jan 02 00:00:00 2020 | 19.00 | 99.00 | 59.00 | 2673.00 | 3333.00 | 3003.00 | 8019.00 | 9999.00 | 9009.00
(50 rows)

INSERT INTO events
SELECT v % 10 AS a,
       v % 100 AS b,
       v / 3.0 AS c,
       timestamp '2020-01-01 20:00:00' +
       ((v / 10000.0) * (timestamp '2020-01-01 15:00:00' -
                   timestamp '2020-01-01 10:00:00')) AS d,
       v AS e
FROM generate_series(10000, 11000) v;
SELECT a,
       d_hour,
       min_b::numeric(12,2),
       max_b::numeric(12,2),
       avg_b::numeric(12,2),
       min_c::numeric(12,2),
       max_c::numeric(12,2),
       avg_c::numeric(12,2),
       min_e::numeric(12,2),
       max_e::numeric(12,2),
       avg_e::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          | min_b | max_b | avg_b |  min_c  |  max_c  |  avg_c  |  min_e   |  max_e   |  avg_e
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 20.00 | 90.00 | 55.00 |    6.67 |  663.33 |  335.00 |    20.00 |  1990.00 |  1005.00
 0 | Wed Jan 01 21:00:00 2020 | 20.00 | 90.00 | 55.00 |  673.33 | 1330.00 | 1001.67 |  2020.00 |  3990.00 |  3005.00
 0 | Wed Jan 01 22:00:00 2020 | 20.00 | 90.00 | 55.00 | 1340.00 | 1996.67 | 1668.33 |  4020.00 |  5990.00 |  5005.00
 0 | Wed Jan 01 23:00:00 2020 | 20.00 | 90.00 | 55.00 | 2006.67 | 2663.33 | 2335.00 |  6020.00 |  7990.00 |  7005.00
 0 | Thu Jan 02 00:00:00 2020 | 20.00 | 90.00 | 55.00 | 2673.33 | 3330.00 | 3001.67 |  8020.00 |  9990.00 |  9005.00
 0 | Thu Jan 02 01:00:00 2020 | 20.00 | 90.00 | 55.00 | 3340.00 | 3663.33 | 3501.67 | 10020.00 | 10990.00 | 10505.00
 1 | Wed Jan 01 20:00:00 2020 | 11.00 | 91.00 | 51.00 |    3.67 |  663.67 |  333.67 |    11.00 |  1991.00 |  1001.00
 1 | Wed Jan 01 21:00:00 2020 | 11.00 | 91.00 | 51.00 |  670.33 | 1330.33 | 1000.33 |  2011.00 |  3991.00 |  3001.00
 1 | Wed Jan 01 22:00:00 2020 | 11.00 | 91.00 | 51.00 | 1337.00 | 1997.00 | 1667.00 |  4011.00 |  5991.00 |  5001.00
 1 | Wed Jan 01 23:00:00 2020 | 11.00 | 91.00 | 51.00 | 2003.67 | 2663.67 | 2333.67 |  6011.00 |  7991.00 |  7001.00
 1 | Thu Jan 02 00:00:00 2020 | 11.00 | 91.00 | 51.00 | 2670.33 | 3330.33 | 3000.33 |  8011.00 |  9991.00 |  9001.00
 1 | Thu Jan 02 01:00:00 2020 | 11.00 | 91.00 | 51.00 | 3337.00 | 3663.67 | 3500.33 | 10011.00 | 10991.00 | 10501.00
 2 | Wed Jan 01 20:00:00 2020 | 12.00 | 92.00 | 52.00 |    4.00 |  664.00 |  334.00 |    12.00 |  1992.00 |  1002.00
 2 | Wed Jan 01 21:00:00 2020 | 12.00 | 92.00 | 52.00 |  670.67 | 1330.67 | 1000.67 |  2012.00 |  3992.00 |  3002.00
 2 | Wed Jan 01 22:00:00 2020 | 12.00 | 92.00 | 52.00 | 1337.33 | 1997.33 | 1667.33 |  4012.00 |  5992.00 |  5002.00
 2 | Wed Jan 01 23:00:00 2020 | 12.00 | 92.00 | 52.00 | 2004.00 | 2664.00 | 2334.00 |  6012.00 |  7992.00 |  7002.00
 2 | Thu Jan 02 00:00:00 2020 | 12.00 | 92.00 | 52.00 | 2670.67 | 3330.67 | 3000.67 |  8012.00 |  9992.00 |  9002.00
 2 | Thu Jan 02 01:00:00 2020 | 12.00 | 92.00 | 52.00 | 3337.33 | 3664.00 | 3500.67 | 10012.00 | 10992.00 | 10502.00
 3 | Wed Jan 01 20:00:00 2020 | 13.00 | 93.00 | 53.00 |    4.33 |  664.33 |  334.33 |    13.00 |  1993.00 |  1003.00
 3 | Wed Jan 01 21:00:00 2020 | 13.00 | 93.00 | 53.00 |  671.00 | 1331.00 | 1001.00 |  2013.00 |  3993.00 |  3003.00
 3 | Wed Jan 01 22:00:00 2020 | 13.00 | 93.00 | 53.00 | 1337.67 | 1997.67 | 1667.67 |  4013.00 |  5993.00 |  5003.00
 3 | Wed Jan 01 23:00:00 2020 | 13.00 | 93.00 | 53.00 | 2004.33 | 2664.33 | 2334.33 |  6013.00 |  7993.00 |  7003.00
 3 | Thu Jan 02 00:00:00 2020 | 13.00 | 93.00 | 53.00 | 2671.00 | 3331.00 | 3001.00 |  8013.00 |  9993.00 |  9003.00
 3 | Thu Jan 02 01:00:00 2020 | 13.00 | 93.00 | 53.00 | 3337.67 | 3664.33 | 3501.00 | 10013.00 | 10993.00 | 10503.00
 4 | Wed Jan 01 20:00:00 2020 | 14.00 | 94.00 | 54.00 |    4.67 |  664.67 |  334.67 |    14.00 |  1994.00 |  1004.00
 4 | Wed Jan 01 21:00:00 2020 | 14.00 | 94.00 | 54.00 |  671.33 | 1331.33 | 1001.33 |  2014.00 |  3994.00 |  3004.00
 4 | Wed Jan 01 22:00:00 2020 | 14.00 | 94.00 | 54.00 | 1338.00 | 1998.00 | 1668.00 |  4014.00 |  5994.00 |  5004.00
 4 | Wed Jan 01 23:00:00 2020 | 14.00 | 94.00 | 54.00 | 2004.67 | 2664.67 | 2334.67 |  6014.00 |  7994.00 |  7004.00
 4 | Thu Jan 02 00:00:00 2020 | 14.00 | 94.00 | 54.00 | 2671.33 | 3331.33 | 3001.33 |  8014.00 |  9994.00 |  9004.00
 4 | Thu Jan 02 01:00:00 2020 | 14.00 | 94.00 | 54.00 | 3338.00 | 3664.67 | 3501.33 | 10014.00 | 10994.00 | 10504.00
 5 | Wed Jan 01 20:00:00 2020 | 15.00 | 95.00 | 55.00 |    5.00 |  665.00 |  335.00 |    15.00 |  1995.00 |  1005.00
 5 | Wed Jan 01 21:00:00 2020 | 15.00 | 95.00 | 55.00 |  671.67 | 1331.67 | 1001.67 |  2015.00 |  3995.00 |  3005.00
 5 | Wed Jan 01 22:00:00 2020 | 15.00 | 95.00 | 55.00 | 1338.33 | 1998.33 | 1668.33 |  4015.00 |  5995.00 |  5005.00
 5 | Wed Jan 01 23:00:00 2020 | 15.00 | 95.00 | 55.00 | 2005.00 | 2665.00 | 2335.00 |  6015.00 |  7995.00 |  7005.00
 5 | Thu Jan 02 00:00:00 2020 | 15.00 | 95.00 | 55.00 | 2671.67 | 3331.67 | 3001.67 |  8015.00 |  9995.00 |  9005.00
 5 | Thu Jan 02 01:00:00 2020 | 15.00 | 95.00 | 55.00 | 3338.33 | 3665.00 | 3501.67 | 10015.00 | 10995.00 | 10505.00
 6 | Wed Jan 01 20:00:00 2020 | 16.00 | 96.00 | 56.00 |    5.33 |  665.33 |  335.33 |    16.00 |  1996.00 |  1006.00
 6 | Wed Jan 01 21:00:00 2020 | 16.00 | 96.00 | 56.00 |  672.00 | 1332.00 | 1002.00 |  2016.00 |  3996.00 |  3006.00
 6 | Wed Jan 01 22:00:00 2020 | 16.00 | 96.00 | 56.00 | 1338.67 | 1998.67 | 1668.67 |  4016.00 |  5996.00 |  5006.00
 6 | Wed Jan 01 23:00:00 2020 | 16.00 | 96.00 | 56.00 | 2005.33 | 2665.33 | 2335.33 |  6016.00 |  7996.00 |  7006.00
 6 | Thu Jan 02 00:00:00 2020 | 16.00 | 96.00 | 56.00 | 2672.00 | 3332.00 | 3002.00 |  8016.00 |  9996.00 |  9006.00
 6 | Thu Jan 02 01:00:00 2020 | 16.00 | 96.00 | 56.00 | 3338.67 | 3665.33 | 3502.00 | 10016.00 | 10996.00 | 10506.00
 7 | Wed Jan 01 20:00:00 2020 | 17.00 | 97.00 | 57.00 |    5.67 |  665.67 |  335.67 |    17.00 |  1997.00 |  1007.00
 7 | Wed Jan 01 21:00:00 2020 | 17.00 | 97.00 | 57.00 |  672.33 | 1332.33 | 1002.33 |  2017.00 |  3997.00 |  3007.00
 7 | Wed Jan 01 22:00:00 2020 | 17.00 | 97.00 | 57.00 | 1339.00 | 1999.00 | 1669.00 |  4017.00 |  5997.00 |  5007.00
 7 | Wed Jan 01 23:00:00 2020 | 17.00 | 97.00 | 57.00 | 2005.67 | 2665.67 | 2335.67 |  6017.00 |  7997.00 |  7007.00
 7 | Thu Jan 02 00:00:00 2020 | 17.00 | 97.00 | 57.00 | 2672.33 | 3332.33 | 3002.33 |  8017.00 |  9997.00 |  9007.00
 7 | Thu Jan 02 01:00:00 2020 | 17.00 | 97.00 | 57.00 | 3339.00 | 3665.67 | 3502.33 | 10017.00 | 10997.00 | 10507.00
 8 | Wed Jan 01 20:00:00 2020 | 18.00 | 98.00 | 58.00 |    6.00 |  666.00 |  336.00 |    18.00 |  1998.00 |  1008.00
 8 | Wed Jan 01 21:00:00 2020 | 18.00 | 98.00 | 58.00 |  672.67 | 1332.67 | 1002.67 |  2018.00 |  3998.00 |  3008.00
 8 | Wed Jan 01 22:00:00 2020 | 18.00 | 98.00 | 58.00 | 1339.33 | 1999.33 | 1669.33 |  4018.00 |  5998.00 |  5008.00
 8 | Wed Jan 01 23:00:00 2020 | 18.00 | 98.00 | 58.00 | 2006.00 | 2666.00 | 2336.00 |  6018.00 |  7998.00 |  7008.00
 8 | Thu Jan 02 00:00:00 2020 | 18.00 | 98.00 | 58.00 | 2672.67 | 3332.67 | 3002.67 |  8018.00 |  9998.00 |  9008.00
 8 | Thu Jan 02 01:00:00 2020 | 18.00 | 98.00 | 58.00 | 3339.33 | 3666.00 | 3502.67 | 10018.00 | 10998.00 | 10508.00
 9 | Wed Jan 01 20:00:00 2020 | 19.00 | 99.00 | 59.00 |    6.33 |  666.33 |  336.33 |    19.00 |  1999.00 |  1009.00
 9 | Wed Jan 01 21:00:00 2020 | 19.00 | 99.00 | 59.00 |  673.00 | 1333.00 | 1003.00 |  2019.00 |  3999.00 |  3009.00
 9 | Wed Jan 01 22:00:00 2020 | 19.00 | 99.00 | 59.00 | 1339.67 | 1999.67 | 1669.67 |  4019.00 |  5999.00 |  5009.00
 9 | Wed Jan 01 23:00:00 2020 | 19.00 | 99.00 | 59.00 | 2006.33 | 2666.33 | 2336.33 |  6019.00 |  7999.00 |  7009.00
 9 | Thu Jan 02 00:00:00 2020 | 19.00 | 99.00 | 59.00 | 2673.00 | 3333.00 | 3003.00 |  8019.00 |  9999.00 |  9009.00
 9 | Thu Jan 02 01:00:00 2020 | 19.00 | 99.00 | 59.00 | 3339.67 | 3666.33 | 3503.00 | 10019.00 | 10999.00 | 10509.00
(60 rows)

DELETE FROM events WHERE b < 100;
ERROR:  MATERIALIZED VIEW 'mv' on table 'events' does not support UPDATE/DELETE
DROP VIEW mv;
ERROR:  DROP VIEW not supported for mv
DROP MATERIALIZED VIEW mv;
NOTICE:  drop cascades to 4 other objects
CREATE MATERIALIZED VIEW mv WITH (citus.cimv) AS
SELECT a,
       date_trunc('hour', d) AS d_hour,
       avg(b) AS avg_b
FROM events
WHERE b > 10
GROUP BY a, d_hour;
SELECT a,
       d_hour,
       avg_b::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          | avg_b
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 55.00
 0 | Wed Jan 01 21:00:00 2020 | 55.00
 0 | Wed Jan 01 22:00:00 2020 | 55.00
 0 | Wed Jan 01 23:00:00 2020 | 55.00
 0 | Thu Jan 02 00:00:00 2020 | 55.00
 0 | Thu Jan 02 01:00:00 2020 | 55.00
 1 | Wed Jan 01 20:00:00 2020 | 51.00
 1 | Wed Jan 01 21:00:00 2020 | 51.00
 1 | Wed Jan 01 22:00:00 2020 | 51.00
 1 | Wed Jan 01 23:00:00 2020 | 51.00
 1 | Thu Jan 02 00:00:00 2020 | 51.00
 1 | Thu Jan 02 01:00:00 2020 | 51.00
 2 | Wed Jan 01 20:00:00 2020 | 52.00
 2 | Wed Jan 01 21:00:00 2020 | 52.00
 2 | Wed Jan 01 22:00:00 2020 | 52.00
 2 | Wed Jan 01 23:00:00 2020 | 52.00
 2 | Thu Jan 02 00:00:00 2020 | 52.00
 2 | Thu Jan 02 01:00:00 2020 | 52.00
 3 | Wed Jan 01 20:00:00 2020 | 53.00
 3 | Wed Jan 01 21:00:00 2020 | 53.00
 3 | Wed Jan 01 22:00:00 2020 | 53.00
 3 | Wed Jan 01 23:00:00 2020 | 53.00
 3 | Thu Jan 02 00:00:00 2020 | 53.00
 3 | Thu Jan 02 01:00:00 2020 | 53.00
 4 | Wed Jan 01 20:00:00 2020 | 54.00
 4 | Wed Jan 01 21:00:00 2020 | 54.00
 4 | Wed Jan 01 22:00:00 2020 | 54.00
 4 | Wed Jan 01 23:00:00 2020 | 54.00
 4 | Thu Jan 02 00:00:00 2020 | 54.00
 4 | Thu Jan 02 01:00:00 2020 | 54.00
 5 | Wed Jan 01 20:00:00 2020 | 55.00
 5 | Wed Jan 01 21:00:00 2020 | 55.00
 5 | Wed Jan 01 22:00:00 2020 | 55.00
 5 | Wed Jan 01 23:00:00 2020 | 55.00
 5 | Thu Jan 02 00:00:00 2020 | 55.00
 5 | Thu Jan 02 01:00:00 2020 | 55.00
 6 | Wed Jan 01 20:00:00 2020 | 56.00
 6 | Wed Jan 01 21:00:00 2020 | 56.00
 6 | Wed Jan 01 22:00:00 2020 | 56.00
 6 | Wed Jan 01 23:00:00 2020 | 56.00
 6 | Thu Jan 02 00:00:00 2020 | 56.00
 6 | Thu Jan 02 01:00:00 2020 | 56.00
 7 | Wed Jan 01 20:00:00 2020 | 57.00
 7 | Wed Jan 01 21:00:00 2020 | 57.00
 7 | Wed Jan 01 22:00:00 2020 | 57.00
 7 | Wed Jan 01 23:00:00 2020 | 57.00
 7 | Thu Jan 02 00:00:00 2020 | 57.00
 7 | Thu Jan 02 01:00:00 2020 | 57.00
 8 | Wed Jan 01 20:00:00 2020 | 58.00
 8 | Wed Jan 01 21:00:00 2020 | 58.00
 8 | Wed Jan 01 22:00:00 2020 | 58.00
 8 | Wed Jan 01 23:00:00 2020 | 58.00
 8 | Thu Jan 02 00:00:00 2020 | 58.00
 8 | Thu Jan 02 01:00:00 2020 | 58.00
 9 | Wed Jan 01 20:00:00 2020 | 59.00
 9 | Wed Jan 01 21:00:00 2020 | 59.00
 9 | Wed Jan 01 22:00:00 2020 | 59.00
 9 | Wed Jan 01 23:00:00 2020 | 59.00
 9 | Thu Jan 02 00:00:00 2020 | 59.00
 9 | Thu Jan 02 01:00:00 2020 | 59.00
(60 rows)

DELETE FROM events WHERE b < 20;
SELECT a,
       d_hour,
       avg_b::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          | avg_b
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 55.00
 0 | Wed Jan 01 21:00:00 2020 | 55.00
 0 | Wed Jan 01 22:00:00 2020 | 55.00
 0 | Wed Jan 01 23:00:00 2020 | 55.00
 0 | Thu Jan 02 00:00:00 2020 | 55.00
 0 | Thu Jan 02 01:00:00 2020 | 55.00
 1 | Wed Jan 01 20:00:00 2020 | 56.00
 1 | Wed Jan 01 21:00:00 2020 | 56.00
 1 | Wed Jan 01 22:00:00 2020 | 56.00
 1 | Wed Jan 01 23:00:00 2020 | 56.00
 1 | Thu Jan 02 00:00:00 2020 | 56.00
 1 | Thu Jan 02 01:00:00 2020 | 56.00
 2 | Wed Jan 01 20:00:00 2020 | 57.00
 2 | Wed Jan 01 21:00:00 2020 | 57.00
 2 | Wed Jan 01 22:00:00 2020 | 57.00
 2 | Wed Jan 01 23:00:00 2020 | 57.00
 2 | Thu Jan 02 00:00:00 2020 | 57.00
 2 | Thu Jan 02 01:00:00 2020 | 57.00
 3 | Wed Jan 01 20:00:00 2020 | 58.00
 3 | Wed Jan 01 21:00:00 2020 | 58.00
 3 | Wed Jan 01 22:00:00 2020 | 58.00
 3 | Wed Jan 01 23:00:00 2020 | 58.00
 3 | Thu Jan 02 00:00:00 2020 | 58.00
 3 | Thu Jan 02 01:00:00 2020 | 58.00
 4 | Wed Jan 01 20:00:00 2020 | 59.00
 4 | Wed Jan 01 21:00:00 2020 | 59.00
 4 | Wed Jan 01 22:00:00 2020 | 59.00
 4 | Wed Jan 01 23:00:00 2020 | 59.00
 4 | Thu Jan 02 00:00:00 2020 | 59.00
 4 | Thu Jan 02 01:00:00 2020 | 59.00
 5 | Wed Jan 01 20:00:00 2020 | 60.00
 5 | Wed Jan 01 21:00:00 2020 | 60.00
 5 | Wed Jan 01 22:00:00 2020 | 60.00
 5 | Wed Jan 01 23:00:00 2020 | 60.00
 5 | Thu Jan 02 00:00:00 2020 | 60.00
 5 | Thu Jan 02 01:00:00 2020 | 60.00
 6 | Wed Jan 01 20:00:00 2020 | 61.00
 6 | Wed Jan 01 21:00:00 2020 | 61.00
 6 | Wed Jan 01 22:00:00 2020 | 61.00
 6 | Wed Jan 01 23:00:00 2020 | 61.00
 6 | Thu Jan 02 00:00:00 2020 | 61.00
 6 | Thu Jan 02 01:00:00 2020 | 61.00
 7 | Wed Jan 01 20:00:00 2020 | 62.00
 7 | Wed Jan 01 21:00:00 2020 | 62.00
 7 | Wed Jan 01 22:00:00 2020 | 62.00
 7 | Wed Jan 01 23:00:00 2020 | 62.00
 7 | Thu Jan 02 00:00:00 2020 | 62.00
 7 | Thu Jan 02 01:00:00 2020 | 62.00
 8 | Wed Jan 01 20:00:00 2020 | 63.00
 8 | Wed Jan 01 21:00:00 2020 | 63.00
 8 | Wed Jan 01 22:00:00 2020 | 63.00
 8 | Wed Jan 01 23:00:00 2020 | 63.00
 8 | Thu Jan 02 00:00:00 2020 | 63.00
 8 | Thu Jan 02 01:00:00 2020 | 63.00
 9 | Wed Jan 01 20:00:00 2020 | 64.00
 9 | Wed Jan 01 21:00:00 2020 | 64.00
 9 | Wed Jan 01 22:00:00 2020 | 64.00
 9 | Wed Jan 01 23:00:00 2020 | 64.00
 9 | Thu Jan 02 00:00:00 2020 | 64.00
 9 | Thu Jan 02 01:00:00 2020 | 64.00
(60 rows)

UPDATE events SET b = b + b;
SELECT a,
       d_hour,
       avg_b::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          | avg_b
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 110.00
 0 | Wed Jan 01 21:00:00 2020 | 110.00
 0 | Wed Jan 01 22:00:00 2020 | 110.00
 0 | Wed Jan 01 23:00:00 2020 | 110.00
 0 | Thu Jan 02 00:00:00 2020 | 110.00
 0 | Thu Jan 02 01:00:00 2020 | 110.00
 1 | Wed Jan 01 20:00:00 2020 | 112.00
 1 | Wed Jan 01 21:00:00 2020 | 112.00
 1 | Wed Jan 01 22:00:00 2020 | 112.00
 1 | Wed Jan 01 23:00:00 2020 | 112.00
 1 | Thu Jan 02 00:00:00 2020 | 112.00
 1 | Thu Jan 02 01:00:00 2020 | 112.00
 2 | Wed Jan 01 20:00:00 2020 | 114.00
 2 | Wed Jan 01 21:00:00 2020 | 114.00
 2 | Wed Jan 01 22:00:00 2020 | 114.00
 2 | Wed Jan 01 23:00:00 2020 | 114.00
 2 | Thu Jan 02 00:00:00 2020 | 114.00
 2 | Thu Jan 02 01:00:00 2020 | 114.00
 3 | Wed Jan 01 20:00:00 2020 | 116.00
 3 | Wed Jan 01 21:00:00 2020 | 116.00
 3 | Wed Jan 01 22:00:00 2020 | 116.00
 3 | Wed Jan 01 23:00:00 2020 | 116.00
 3 | Thu Jan 02 00:00:00 2020 | 116.00
 3 | Thu Jan 02 01:00:00 2020 | 116.00
 4 | Wed Jan 01 20:00:00 2020 | 118.00
 4 | Wed Jan 01 21:00:00 2020 | 118.00
 4 | Wed Jan 01 22:00:00 2020 | 118.00
 4 | Wed Jan 01 23:00:00 2020 | 118.00
 4 | Thu Jan 02 00:00:00 2020 | 118.00
 4 | Thu Jan 02 01:00:00 2020 | 118.00
 5 | Wed Jan 01 20:00:00 2020 | 120.00
 5 | Wed Jan 01 21:00:00 2020 | 120.00
 5 | Wed Jan 01 22:00:00 2020 | 120.00
 5 | Wed Jan 01 23:00:00 2020 | 120.00
 5 | Thu Jan 02 00:00:00 2020 | 120.00
 5 | Thu Jan 02 01:00:00 2020 | 120.00
 6 | Wed Jan 01 20:00:00 2020 | 122.00
 6 | Wed Jan 01 21:00:00 2020 | 122.00
 6 | Wed Jan 01 22:00:00 2020 | 122.00
 6 | Wed Jan 01 23:00:00 2020 | 122.00
 6 | Thu Jan 02 00:00:00 2020 | 122.00
 6 | Thu Jan 02 01:00:00 2020 | 122.00
 7 | Wed Jan 01 20:00:00 2020 | 124.00
 7 | Wed Jan 01 21:00:00 2020 | 124.00
 7 | Wed Jan 01 22:00:00 2020 | 124.00
 7 | Wed Jan 01 23:00:00 2020 | 124.00
 7 | Thu Jan 02 00:00:00 2020 | 124.00
 7 | Thu Jan 02 01:00:00 2020 | 124.00
 8 | Wed Jan 01 20:00:00 2020 | 126.00
 8 | Wed Jan 01 21:00:00 2020 | 126.00
 8 | Wed Jan 01 22:00:00 2020 | 126.00
 8 | Wed Jan 01 23:00:00 2020 | 126.00
 8 | Thu Jan 02 00:00:00 2020 | 126.00
 8 | Thu Jan 02 01:00:00 2020 | 126.00
 9 | Wed Jan 01 20:00:00 2020 | 128.00
 9 | Wed Jan 01 21:00:00 2020 | 128.00
 9 | Wed Jan 01 22:00:00 2020 | 128.00
 9 | Wed Jan 01 23:00:00 2020 | 128.00
 9 | Thu Jan 02 00:00:00 2020 | 128.00
 9 | Thu Jan 02 01:00:00 2020 | 128.00
(60 rows)

DROP MATERIALIZED VIEW mv;
NOTICE:  drop cascades to 4 other objects
CREATE MATERIALIZED VIEW mv WITH (citus.cimv, citus.insertonlycapture) AS
SELECT a,
       date_trunc('hour', d) AS d_hour,
       avg(b) AS avg_b
FROM events
WHERE b > 10
GROUP BY a, d_hour;
SELECT a,
       d_hour,
       avg_b::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          | avg_b
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 110.00
 0 | Wed Jan 01 21:00:00 2020 | 110.00
 0 | Wed Jan 01 22:00:00 2020 | 110.00
 0 | Wed Jan 01 23:00:00 2020 | 110.00
 0 | Thu Jan 02 00:00:00 2020 | 110.00
 0 | Thu Jan 02 01:00:00 2020 | 110.00
 1 | Wed Jan 01 20:00:00 2020 | 112.00
 1 | Wed Jan 01 21:00:00 2020 | 112.00
 1 | Wed Jan 01 22:00:00 2020 | 112.00
 1 | Wed Jan 01 23:00:00 2020 | 112.00
 1 | Thu Jan 02 00:00:00 2020 | 112.00
 1 | Thu Jan 02 01:00:00 2020 | 112.00
 2 | Wed Jan 01 20:00:00 2020 | 114.00
 2 | Wed Jan 01 21:00:00 2020 | 114.00
 2 | Wed Jan 01 22:00:00 2020 | 114.00
 2 | Wed Jan 01 23:00:00 2020 | 114.00
 2 | Thu Jan 02 00:00:00 2020 | 114.00
 2 | Thu Jan 02 01:00:00 2020 | 114.00
 3 | Wed Jan 01 20:00:00 2020 | 116.00
 3 | Wed Jan 01 21:00:00 2020 | 116.00
 3 | Wed Jan 01 22:00:00 2020 | 116.00
 3 | Wed Jan 01 23:00:00 2020 | 116.00
 3 | Thu Jan 02 00:00:00 2020 | 116.00
 3 | Thu Jan 02 01:00:00 2020 | 116.00
 4 | Wed Jan 01 20:00:00 2020 | 118.00
 4 | Wed Jan 01 21:00:00 2020 | 118.00
 4 | Wed Jan 01 22:00:00 2020 | 118.00
 4 | Wed Jan 01 23:00:00 2020 | 118.00
 4 | Thu Jan 02 00:00:00 2020 | 118.00
 4 | Thu Jan 02 01:00:00 2020 | 118.00
 5 | Wed Jan 01 20:00:00 2020 | 120.00
 5 | Wed Jan 01 21:00:00 2020 | 120.00
 5 | Wed Jan 01 22:00:00 2020 | 120.00
 5 | Wed Jan 01 23:00:00 2020 | 120.00
 5 | Thu Jan 02 00:00:00 2020 | 120.00
 5 | Thu Jan 02 01:00:00 2020 | 120.00
 6 | Wed Jan 01 20:00:00 2020 | 122.00
 6 | Wed Jan 01 21:00:00 2020 | 122.00
 6 | Wed Jan 01 22:00:00 2020 | 122.00
 6 | Wed Jan 01 23:00:00 2020 | 122.00
 6 | Thu Jan 02 00:00:00 2020 | 122.00
 6 | Thu Jan 02 01:00:00 2020 | 122.00
 7 | Wed Jan 01 20:00:00 2020 | 124.00
 7 | Wed Jan 01 21:00:00 2020 | 124.00
 7 | Wed Jan 01 22:00:00 2020 | 124.00
 7 | Wed Jan 01 23:00:00 2020 | 124.00
 7 | Thu Jan 02 00:00:00 2020 | 124.00
 7 | Thu Jan 02 01:00:00 2020 | 124.00
 8 | Wed Jan 01 20:00:00 2020 | 126.00
 8 | Wed Jan 01 21:00:00 2020 | 126.00
 8 | Wed Jan 01 22:00:00 2020 | 126.00
 8 | Wed Jan 01 23:00:00 2020 | 126.00
 8 | Thu Jan 02 00:00:00 2020 | 126.00
 8 | Thu Jan 02 01:00:00 2020 | 126.00
 9 | Wed Jan 01 20:00:00 2020 | 128.00
 9 | Wed Jan 01 21:00:00 2020 | 128.00
 9 | Wed Jan 01 22:00:00 2020 | 128.00
 9 | Wed Jan 01 23:00:00 2020 | 128.00
 9 | Thu Jan 02 00:00:00 2020 | 128.00
 9 | Thu Jan 02 01:00:00 2020 | 128.00
(60 rows)

INSERT INTO events
SELECT v % 10 AS a,
       v % 100 AS b,
       v / 3.0 AS c,
       timestamp '2020-01-01 20:00:00' +
       ((v / 10000.0) * (timestamp '2020-01-01 15:00:00' -
                   timestamp '2020-01-01 10:00:00')) AS d,
       v AS e
FROM generate_series(11000, 12000) v;
SELECT a,
       d_hour,
       avg_b::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          | avg_b
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 110.00
 0 | Wed Jan 01 21:00:00 2020 | 110.00
 0 | Wed Jan 01 22:00:00 2020 | 110.00
 0 | Wed Jan 01 23:00:00 2020 | 110.00
 0 | Thu Jan 02 00:00:00 2020 | 110.00
 0 | Thu Jan 02 01:00:00 2020 |  82.50
 1 | Wed Jan 01 20:00:00 2020 | 112.00
 1 | Wed Jan 01 21:00:00 2020 | 112.00
 1 | Wed Jan 01 22:00:00 2020 | 112.00
 1 | Wed Jan 01 23:00:00 2020 | 112.00
 1 | Thu Jan 02 00:00:00 2020 | 112.00
 1 | Thu Jan 02 01:00:00 2020 |  79.71
 2 | Wed Jan 01 20:00:00 2020 | 114.00
 2 | Wed Jan 01 21:00:00 2020 | 114.00
 2 | Wed Jan 01 22:00:00 2020 | 114.00
 2 | Wed Jan 01 23:00:00 2020 | 114.00
 2 | Thu Jan 02 00:00:00 2020 | 114.00
 2 | Thu Jan 02 01:00:00 2020 |  81.18
 3 | Wed Jan 01 20:00:00 2020 | 116.00
 3 | Wed Jan 01 21:00:00 2020 | 116.00
 3 | Wed Jan 01 22:00:00 2020 | 116.00
 3 | Wed Jan 01 23:00:00 2020 | 116.00
 3 | Thu Jan 02 00:00:00 2020 | 116.00
 3 | Thu Jan 02 01:00:00 2020 |  82.65
 4 | Wed Jan 01 20:00:00 2020 | 118.00
 4 | Wed Jan 01 21:00:00 2020 | 118.00
 4 | Wed Jan 01 22:00:00 2020 | 118.00
 4 | Wed Jan 01 23:00:00 2020 | 118.00
 4 | Thu Jan 02 00:00:00 2020 | 118.00
 4 | Thu Jan 02 01:00:00 2020 |  84.12
 5 | Wed Jan 01 20:00:00 2020 | 120.00
 5 | Wed Jan 01 21:00:00 2020 | 120.00
 5 | Wed Jan 01 22:00:00 2020 | 120.00
 5 | Wed Jan 01 23:00:00 2020 | 120.00
 5 | Thu Jan 02 00:00:00 2020 | 120.00
 5 | Thu Jan 02 01:00:00 2020 |  85.59
 6 | Wed Jan 01 20:00:00 2020 | 122.00
 6 | Wed Jan 01 21:00:00 2020 | 122.00
 6 | Wed Jan 01 22:00:00 2020 | 122.00
 6 | Wed Jan 01 23:00:00 2020 | 122.00
 6 | Thu Jan 02 00:00:00 2020 | 122.00
 6 | Thu Jan 02 01:00:00 2020 |  87.06
 7 | Wed Jan 01 20:00:00 2020 | 124.00
 7 | Wed Jan 01 21:00:00 2020 | 124.00
 7 | Wed Jan 01 22:00:00 2020 | 124.00
 7 | Wed Jan 01 23:00:00 2020 | 124.00
 7 | Thu Jan 02 00:00:00 2020 | 124.00
 7 | Thu Jan 02 01:00:00 2020 |  88.53
 8 | Wed Jan 01 20:00:00 2020 | 126.00
 8 | Wed Jan 01 21:00:00 2020 | 126.00
 8 | Wed Jan 01 22:00:00 2020 | 126.00
 8 | Wed Jan 01 23:00:00 2020 | 126.00
 8 | Thu Jan 02 00:00:00 2020 | 126.00
 8 | Thu Jan 02 01:00:00 2020 |  90.00
 9 | Wed Jan 01 20:00:00 2020 | 128.00
 9 | Wed Jan 01 21:00:00 2020 | 128.00
 9 | Wed Jan 01 22:00:00 2020 | 128.00
 9 | Wed Jan 01 23:00:00 2020 | 128.00
 9 | Thu Jan 02 00:00:00 2020 | 128.00
 9 | Thu Jan 02 01:00:00 2020 |  91.47
(60 rows)

DELETE FROM events WHERE b < 100;
SELECT a,
       d_hour,
       avg_b::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          | avg_b
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 110.00
 0 | Wed Jan 01 21:00:00 2020 | 110.00
 0 | Wed Jan 01 22:00:00 2020 | 110.00
 0 | Wed Jan 01 23:00:00 2020 | 110.00
 0 | Thu Jan 02 00:00:00 2020 | 110.00
 0 | Thu Jan 02 01:00:00 2020 |  82.50
 1 | Wed Jan 01 20:00:00 2020 | 112.00
 1 | Wed Jan 01 21:00:00 2020 | 112.00
 1 | Wed Jan 01 22:00:00 2020 | 112.00
 1 | Wed Jan 01 23:00:00 2020 | 112.00
 1 | Thu Jan 02 00:00:00 2020 | 112.00
 1 | Thu Jan 02 01:00:00 2020 |  79.71
 2 | Wed Jan 01 20:00:00 2020 | 114.00
 2 | Wed Jan 01 21:00:00 2020 | 114.00
 2 | Wed Jan 01 22:00:00 2020 | 114.00
 2 | Wed Jan 01 23:00:00 2020 | 114.00
 2 | Thu Jan 02 00:00:00 2020 | 114.00
 2 | Thu Jan 02 01:00:00 2020 |  81.18
 3 | Wed Jan 01 20:00:00 2020 | 116.00
 3 | Wed Jan 01 21:00:00 2020 | 116.00
 3 | Wed Jan 01 22:00:00 2020 | 116.00
 3 | Wed Jan 01 23:00:00 2020 | 116.00
 3 | Thu Jan 02 00:00:00 2020 | 116.00
 3 | Thu Jan 02 01:00:00 2020 |  82.65
 4 | Wed Jan 01 20:00:00 2020 | 118.00
 4 | Wed Jan 01 21:00:00 2020 | 118.00
 4 | Wed Jan 01 22:00:00 2020 | 118.00
 4 | Wed Jan 01 23:00:00 2020 | 118.00
 4 | Thu Jan 02 00:00:00 2020 | 118.00
 4 | Thu Jan 02 01:00:00 2020 |  84.12
 5 | Wed Jan 01 20:00:00 2020 | 120.00
 5 | Wed Jan 01 21:00:00 2020 | 120.00
 5 | Wed Jan 01 22:00:00 2020 | 120.00
 5 | Wed Jan 01 23:00:00 2020 | 120.00
 5 | Thu Jan 02 00:00:00 2020 | 120.00
 5 | Thu Jan 02 01:00:00 2020 |  85.59
 6 | Wed Jan 01 20:00:00 2020 | 122.00
 6 | Wed Jan 01 21:00:00 2020 | 122.00
 6 | Wed Jan 01 22:00:00 2020 | 122.00
 6 | Wed Jan 01 23:00:00 2020 | 122.00
 6 | Thu Jan 02 00:00:00 2020 | 122.00
 6 | Thu Jan 02 01:00:00 2020 |  87.06
 7 | Wed Jan 01 20:00:00 2020 | 124.00
 7 | Wed Jan 01 21:00:00 2020 | 124.00
 7 | Wed Jan 01 22:00:00 2020 | 124.00
 7 | Wed Jan 01 23:00:00 2020 | 124.00
 7 | Thu Jan 02 00:00:00 2020 | 124.00
 7 | Thu Jan 02 01:00:00 2020 |  88.53
 8 | Wed Jan 01 20:00:00 2020 | 126.00
 8 | Wed Jan 01 21:00:00 2020 | 126.00
 8 | Wed Jan 01 22:00:00 2020 | 126.00
 8 | Wed Jan 01 23:00:00 2020 | 126.00
 8 | Thu Jan 02 00:00:00 2020 | 126.00
 8 | Thu Jan 02 01:00:00 2020 |  90.00
 9 | Wed Jan 01 20:00:00 2020 | 128.00
 9 | Wed Jan 01 21:00:00 2020 | 128.00
 9 | Wed Jan 01 22:00:00 2020 | 128.00
 9 | Wed Jan 01 23:00:00 2020 | 128.00
 9 | Thu Jan 02 00:00:00 2020 | 128.00
 9 | Thu Jan 02 01:00:00 2020 |  91.47
(60 rows)

UPDATE events SET b = b + b;
SELECT a,
       d_hour,
       avg_b::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          | avg_b
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 110.00
 0 | Wed Jan 01 21:00:00 2020 | 110.00
 0 | Wed Jan 01 22:00:00 2020 | 110.00
 0 | Wed Jan 01 23:00:00 2020 | 110.00
 0 | Thu Jan 02 00:00:00 2020 | 110.00
 0 | Thu Jan 02 01:00:00 2020 |  82.50
 1 | Wed Jan 01 20:00:00 2020 | 112.00
 1 | Wed Jan 01 21:00:00 2020 | 112.00
 1 | Wed Jan 01 22:00:00 2020 | 112.00
 1 | Wed Jan 01 23:00:00 2020 | 112.00
 1 | Thu Jan 02 00:00:00 2020 | 112.00
 1 | Thu Jan 02 01:00:00 2020 |  79.71
 2 | Wed Jan 01 20:00:00 2020 | 114.00
 2 | Wed Jan 01 21:00:00 2020 | 114.00
 2 | Wed Jan 01 22:00:00 2020 | 114.00
 2 | Wed Jan 01 23:00:00 2020 | 114.00
 2 | Thu Jan 02 00:00:00 2020 | 114.00
 2 | Thu Jan 02 01:00:00 2020 |  81.18
 3 | Wed Jan 01 20:00:00 2020 | 116.00
 3 | Wed Jan 01 21:00:00 2020 | 116.00
 3 | Wed Jan 01 22:00:00 2020 | 116.00
 3 | Wed Jan 01 23:00:00 2020 | 116.00
 3 | Thu Jan 02 00:00:00 2020 | 116.00
 3 | Thu Jan 02 01:00:00 2020 |  82.65
 4 | Wed Jan 01 20:00:00 2020 | 118.00
 4 | Wed Jan 01 21:00:00 2020 | 118.00
 4 | Wed Jan 01 22:00:00 2020 | 118.00
 4 | Wed Jan 01 23:00:00 2020 | 118.00
 4 | Thu Jan 02 00:00:00 2020 | 118.00
 4 | Thu Jan 02 01:00:00 2020 |  84.12
 5 | Wed Jan 01 20:00:00 2020 | 120.00
 5 | Wed Jan 01 21:00:00 2020 | 120.00
 5 | Wed Jan 01 22:00:00 2020 | 120.00
 5 | Wed Jan 01 23:00:00 2020 | 120.00
 5 | Thu Jan 02 00:00:00 2020 | 120.00
 5 | Thu Jan 02 01:00:00 2020 |  85.59
 6 | Wed Jan 01 20:00:00 2020 | 122.00
 6 | Wed Jan 01 21:00:00 2020 | 122.00
 6 | Wed Jan 01 22:00:00 2020 | 122.00
 6 | Wed Jan 01 23:00:00 2020 | 122.00
 6 | Thu Jan 02 00:00:00 2020 | 122.00
 6 | Thu Jan 02 01:00:00 2020 |  87.06
 7 | Wed Jan 01 20:00:00 2020 | 124.00
 7 | Wed Jan 01 21:00:00 2020 | 124.00
 7 | Wed Jan 01 22:00:00 2020 | 124.00
 7 | Wed Jan 01 23:00:00 2020 | 124.00
 7 | Thu Jan 02 00:00:00 2020 | 124.00
 7 | Thu Jan 02 01:00:00 2020 |  88.53
 8 | Wed Jan 01 20:00:00 2020 | 126.00
 8 | Wed Jan 01 21:00:00 2020 | 126.00
 8 | Wed Jan 01 22:00:00 2020 | 126.00
 8 | Wed Jan 01 23:00:00 2020 | 126.00
 8 | Thu Jan 02 00:00:00 2020 | 126.00
 8 | Thu Jan 02 01:00:00 2020 |  90.00
 9 | Wed Jan 01 20:00:00 2020 | 128.00
 9 | Wed Jan 01 21:00:00 2020 | 128.00
 9 | Wed Jan 01 22:00:00 2020 | 128.00
 9 | Wed Jan 01 23:00:00 2020 | 128.00
 9 | Thu Jan 02 00:00:00 2020 | 128.00
 9 | Thu Jan 02 01:00:00 2020 |  91.47
(60 rows)

REFRESH MATERIALIZED VIEW mv WITH NO DATA;
SELECT * FROM mv;
 a | d_hour | avg_b
---------------------------------------------------------------------
(0 rows)

REFRESH MATERIALIZED VIEW mv;
SELECT a,
       d_hour,
       avg_b::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          | avg_b
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 280.00
 0 | Wed Jan 01 21:00:00 2020 | 280.00
 0 | Wed Jan 01 22:00:00 2020 | 280.00
 0 | Wed Jan 01 23:00:00 2020 | 280.00
 0 | Thu Jan 02 00:00:00 2020 | 280.00
 0 | Thu Jan 02 01:00:00 2020 | 280.00
 1 | Wed Jan 01 20:00:00 2020 | 284.00
 1 | Wed Jan 01 21:00:00 2020 | 284.00
 1 | Wed Jan 01 22:00:00 2020 | 284.00
 1 | Wed Jan 01 23:00:00 2020 | 284.00
 1 | Thu Jan 02 00:00:00 2020 | 284.00
 1 | Thu Jan 02 01:00:00 2020 | 284.00
 2 | Wed Jan 01 20:00:00 2020 | 288.00
 2 | Wed Jan 01 21:00:00 2020 | 288.00
 2 | Wed Jan 01 22:00:00 2020 | 288.00
 2 | Wed Jan 01 23:00:00 2020 | 288.00
 2 | Thu Jan 02 00:00:00 2020 | 288.00
 2 | Thu Jan 02 01:00:00 2020 | 288.00
 3 | Wed Jan 01 20:00:00 2020 | 292.00
 3 | Wed Jan 01 21:00:00 2020 | 292.00
 3 | Wed Jan 01 22:00:00 2020 | 292.00
 3 | Wed Jan 01 23:00:00 2020 | 292.00
 3 | Thu Jan 02 00:00:00 2020 | 292.00
 3 | Thu Jan 02 01:00:00 2020 | 292.00
 4 | Wed Jan 01 20:00:00 2020 | 296.00
 4 | Wed Jan 01 21:00:00 2020 | 296.00
 4 | Wed Jan 01 22:00:00 2020 | 296.00
 4 | Wed Jan 01 23:00:00 2020 | 296.00
 4 | Thu Jan 02 00:00:00 2020 | 296.00
 4 | Thu Jan 02 01:00:00 2020 | 296.00
 5 | Wed Jan 01 20:00:00 2020 | 300.00
 5 | Wed Jan 01 21:00:00 2020 | 300.00
 5 | Wed Jan 01 22:00:00 2020 | 300.00
 5 | Wed Jan 01 23:00:00 2020 | 300.00
 5 | Thu Jan 02 00:00:00 2020 | 300.00
 5 | Thu Jan 02 01:00:00 2020 | 300.00
 6 | Wed Jan 01 20:00:00 2020 | 304.00
 6 | Wed Jan 01 21:00:00 2020 | 304.00
 6 | Wed Jan 01 22:00:00 2020 | 304.00
 6 | Wed Jan 01 23:00:00 2020 | 304.00
 6 | Thu Jan 02 00:00:00 2020 | 304.00
 6 | Thu Jan 02 01:00:00 2020 | 304.00
 7 | Wed Jan 01 20:00:00 2020 | 308.00
 7 | Wed Jan 01 21:00:00 2020 | 308.00
 7 | Wed Jan 01 22:00:00 2020 | 308.00
 7 | Wed Jan 01 23:00:00 2020 | 308.00
 7 | Thu Jan 02 00:00:00 2020 | 308.00
 7 | Thu Jan 02 01:00:00 2020 | 308.00
 8 | Wed Jan 01 20:00:00 2020 | 312.00
 8 | Wed Jan 01 21:00:00 2020 | 312.00
 8 | Wed Jan 01 22:00:00 2020 | 312.00
 8 | Wed Jan 01 23:00:00 2020 | 312.00
 8 | Thu Jan 02 00:00:00 2020 | 312.00
 8 | Thu Jan 02 01:00:00 2020 | 312.00
 9 | Wed Jan 01 20:00:00 2020 | 316.00
 9 | Wed Jan 01 21:00:00 2020 | 316.00
 9 | Wed Jan 01 22:00:00 2020 | 316.00
 9 | Wed Jan 01 23:00:00 2020 | 316.00
 9 | Thu Jan 02 00:00:00 2020 | 316.00
 9 | Thu Jan 02 01:00:00 2020 | 316.00
(60 rows)

DROP MATERIALIZED VIEW mv;
NOTICE:  drop cascades to trigger mv_3_INSERT on table events
CREATE MATERIALIZED VIEW mv WITH (citus.cimv, citus.insertonlycapture) AS
SELECT a,
       date_trunc('hour', d) AS d_hour,
       avg(b) AS avg_b
FROM events
WHERE b > 10
GROUP BY a, d_hour WITH NO DATA;
SELECT * FROM mv;
 a | d_hour | avg_b
---------------------------------------------------------------------
(0 rows)

DROP MATERIALIZED VIEW mv;
NOTICE:  drop cascades to trigger mv_4_INSERT on table events
SELECT create_distributed_table('events', 'a');
NOTICE:  Copying data from local table...
NOTICE:  copying the data has completed
 create_distributed_table
---------------------------------------------------------------------

(1 row)

CREATE MATERIALIZED VIEW mv WITH (citus.cimv) AS
SELECT a,
       date_trunc('hour', d) AS d_hour,
       min(b) AS min_b,
       max(b) AS max_b,
       avg(b) AS avg_b,
       min(c) AS min_c,
       max(c) AS max_c,
       avg(c) AS avg_c,
       min(e) AS min_e,
       max(e) AS max_e,
       avg(e) AS avg_e
FROM events
WHERE b > 10
GROUP BY a, d_hour;
SELECT a,
       d_hour,
       min_b::numeric(12,2),
       max_b::numeric(12,2),
       avg_b::numeric(12,2),
       min_c::numeric(12,2),
       max_c::numeric(12,2),
       avg_c::numeric(12,2),
       min_e::numeric(12,2),
       max_e::numeric(12,2),
       avg_e::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          | min_b  | max_b  | avg_b  |  min_c  |  max_c  |  avg_c  |  min_e   |  max_e   |  avg_e
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 200.00 | 360.00 | 280.00 |   16.67 |  663.33 |  340.00 |    50.00 |  1990.00 |  1020.00
 0 | Wed Jan 01 21:00:00 2020 | 200.00 | 360.00 | 280.00 |  683.33 | 1330.00 | 1006.67 |  2050.00 |  3990.00 |  3020.00
 0 | Wed Jan 01 22:00:00 2020 | 200.00 | 360.00 | 280.00 | 1350.00 | 1996.67 | 1673.33 |  4050.00 |  5990.00 |  5020.00
 0 | Wed Jan 01 23:00:00 2020 | 200.00 | 360.00 | 280.00 | 2016.67 | 2663.33 | 2340.00 |  6050.00 |  7990.00 |  7020.00
 0 | Thu Jan 02 00:00:00 2020 | 200.00 | 360.00 | 280.00 | 2683.33 | 3330.00 | 3006.67 |  8050.00 |  9990.00 |  9020.00
 0 | Thu Jan 02 01:00:00 2020 | 200.00 | 360.00 | 280.00 | 3350.00 | 3663.33 | 3506.67 | 10050.00 | 10990.00 | 10520.00
 1 | Wed Jan 01 20:00:00 2020 | 204.00 | 364.00 | 284.00 |   17.00 |  663.67 |  340.33 |    51.00 |  1991.00 |  1021.00
 1 | Wed Jan 01 21:00:00 2020 | 204.00 | 364.00 | 284.00 |  683.67 | 1330.33 | 1007.00 |  2051.00 |  3991.00 |  3021.00
 1 | Wed Jan 01 22:00:00 2020 | 204.00 | 364.00 | 284.00 | 1350.33 | 1997.00 | 1673.67 |  4051.00 |  5991.00 |  5021.00
 1 | Wed Jan 01 23:00:00 2020 | 204.00 | 364.00 | 284.00 | 2017.00 | 2663.67 | 2340.33 |  6051.00 |  7991.00 |  7021.00
 1 | Thu Jan 02 00:00:00 2020 | 204.00 | 364.00 | 284.00 | 2683.67 | 3330.33 | 3007.00 |  8051.00 |  9991.00 |  9021.00
 1 | Thu Jan 02 01:00:00 2020 | 204.00 | 364.00 | 284.00 | 3350.33 | 3663.67 | 3507.00 | 10051.00 | 10991.00 | 10521.00
 2 | Wed Jan 01 20:00:00 2020 | 208.00 | 368.00 | 288.00 |   17.33 |  664.00 |  340.67 |    52.00 |  1992.00 |  1022.00
 2 | Wed Jan 01 21:00:00 2020 | 208.00 | 368.00 | 288.00 |  684.00 | 1330.67 | 1007.33 |  2052.00 |  3992.00 |  3022.00
 2 | Wed Jan 01 22:00:00 2020 | 208.00 | 368.00 | 288.00 | 1350.67 | 1997.33 | 1674.00 |  4052.00 |  5992.00 |  5022.00
 2 | Wed Jan 01 23:00:00 2020 | 208.00 | 368.00 | 288.00 | 2017.33 | 2664.00 | 2340.67 |  6052.00 |  7992.00 |  7022.00
 2 | Thu Jan 02 00:00:00 2020 | 208.00 | 368.00 | 288.00 | 2684.00 | 3330.67 | 3007.33 |  8052.00 |  9992.00 |  9022.00
 2 | Thu Jan 02 01:00:00 2020 | 208.00 | 368.00 | 288.00 | 3350.67 | 3664.00 | 3507.33 | 10052.00 | 10992.00 | 10522.00
 3 | Wed Jan 01 20:00:00 2020 | 212.00 | 372.00 | 292.00 |   17.67 |  664.33 |  341.00 |    53.00 |  1993.00 |  1023.00
 3 | Wed Jan 01 21:00:00 2020 | 212.00 | 372.00 | 292.00 |  684.33 | 1331.00 | 1007.67 |  2053.00 |  3993.00 |  3023.00
 3 | Wed Jan 01 22:00:00 2020 | 212.00 | 372.00 | 292.00 | 1351.00 | 1997.67 | 1674.33 |  4053.00 |  5993.00 |  5023.00
 3 | Wed Jan 01 23:00:00 2020 | 212.00 | 372.00 | 292.00 | 2017.67 | 2664.33 | 2341.00 |  6053.00 |  7993.00 |  7023.00
 3 | Thu Jan 02 00:00:00 2020 | 212.00 | 372.00 | 292.00 | 2684.33 | 3331.00 | 3007.67 |  8053.00 |  9993.00 |  9023.00
 3 | Thu Jan 02 01:00:00 2020 | 212.00 | 372.00 | 292.00 | 3351.00 | 3664.33 | 3507.67 | 10053.00 | 10993.00 | 10523.00
 4 | Wed Jan 01 20:00:00 2020 | 216.00 | 376.00 | 296.00 |   18.00 |  664.67 |  341.33 |    54.00 |  1994.00 |  1024.00
 4 | Wed Jan 01 21:00:00 2020 | 216.00 | 376.00 | 296.00 |  684.67 | 1331.33 | 1008.00 |  2054.00 |  3994.00 |  3024.00
 4 | Wed Jan 01 22:00:00 2020 | 216.00 | 376.00 | 296.00 | 1351.33 | 1998.00 | 1674.67 |  4054.00 |  5994.00 |  5024.00
 4 | Wed Jan 01 23:00:00 2020 | 216.00 | 376.00 | 296.00 | 2018.00 | 2664.67 | 2341.33 |  6054.00 |  7994.00 |  7024.00
 4 | Thu Jan 02 00:00:00 2020 | 216.00 | 376.00 | 296.00 | 2684.67 | 3331.33 | 3008.00 |  8054.00 |  9994.00 |  9024.00
 4 | Thu Jan 02 01:00:00 2020 | 216.00 | 376.00 | 296.00 | 3351.33 | 3664.67 | 3508.00 | 10054.00 | 10994.00 | 10524.00
 5 | Wed Jan 01 20:00:00 2020 | 220.00 | 380.00 | 300.00 |   18.33 |  665.00 |  341.67 |    55.00 |  1995.00 |  1025.00
 5 | Wed Jan 01 21:00:00 2020 | 220.00 | 380.00 | 300.00 |  685.00 | 1331.67 | 1008.33 |  2055.00 |  3995.00 |  3025.00
 5 | Wed Jan 01 22:00:00 2020 | 220.00 | 380.00 | 300.00 | 1351.67 | 1998.33 | 1675.00 |  4055.00 |  5995.00 |  5025.00
 5 | Wed Jan 01 23:00:00 2020 | 220.00 | 380.00 | 300.00 | 2018.33 | 2665.00 | 2341.67 |  6055.00 |  7995.00 |  7025.00
 5 | Thu Jan 02 00:00:00 2020 | 220.00 | 380.00 | 300.00 | 2685.00 | 3331.67 | 3008.33 |  8055.00 |  9995.00 |  9025.00
 5 | Thu Jan 02 01:00:00 2020 | 220.00 | 380.00 | 300.00 | 3351.67 | 3665.00 | 3508.33 | 10055.00 | 10995.00 | 10525.00
 6 | Wed Jan 01 20:00:00 2020 | 224.00 | 384.00 | 304.00 |   18.67 |  665.33 |  342.00 |    56.00 |  1996.00 |  1026.00
 6 | Wed Jan 01 21:00:00 2020 | 224.00 | 384.00 | 304.00 |  685.33 | 1332.00 | 1008.67 |  2056.00 |  3996.00 |  3026.00
 6 | Wed Jan 01 22:00:00 2020 | 224.00 | 384.00 | 304.00 | 1352.00 | 1998.67 | 1675.33 |  4056.00 |  5996.00 |  5026.00
 6 | Wed Jan 01 23:00:00 2020 | 224.00 | 384.00 | 304.00 | 2018.67 | 2665.33 | 2342.00 |  6056.00 |  7996.00 |  7026.00
 6 | Thu Jan 02 00:00:00 2020 | 224.00 | 384.00 | 304.00 | 2685.33 | 3332.00 | 3008.67 |  8056.00 |  9996.00 |  9026.00
 6 | Thu Jan 02 01:00:00 2020 | 224.00 | 384.00 | 304.00 | 3352.00 | 3665.33 | 3508.67 | 10056.00 | 10996.00 | 10526.00
 7 | Wed Jan 01 20:00:00 2020 | 228.00 | 388.00 | 308.00 |   19.00 |  665.67 |  342.33 |    57.00 |  1997.00 |  1027.00
 7 | Wed Jan 01 21:00:00 2020 | 228.00 | 388.00 | 308.00 |  685.67 | 1332.33 | 1009.00 |  2057.00 |  3997.00 |  3027.00
 7 | Wed Jan 01 22:00:00 2020 | 228.00 | 388.00 | 308.00 | 1352.33 | 1999.00 | 1675.67 |  4057.00 |  5997.00 |  5027.00
 7 | Wed Jan 01 23:00:00 2020 | 228.00 | 388.00 | 308.00 | 2019.00 | 2665.67 | 2342.33 |  6057.00 |  7997.00 |  7027.00
 7 | Thu Jan 02 00:00:00 2020 | 228.00 | 388.00 | 308.00 | 2685.67 | 3332.33 | 3009.00 |  8057.00 |  9997.00 |  9027.00
 7 | Thu Jan 02 01:00:00 2020 | 228.00 | 388.00 | 308.00 | 3352.33 | 3665.67 | 3509.00 | 10057.00 | 10997.00 | 10527.00
 8 | Wed Jan 01 20:00:00 2020 | 232.00 | 392.00 | 312.00 |   19.33 |  666.00 |  342.67 |    58.00 |  1998.00 |  1028.00
 8 | Wed Jan 01 21:00:00 2020 | 232.00 | 392.00 | 312.00 |  686.00 | 1332.67 | 1009.33 |  2058.00 |  3998.00 |  3028.00
 8 | Wed Jan 01 22:00:00 2020 | 232.00 | 392.00 | 312.00 | 1352.67 | 1999.33 | 1676.00 |  4058.00 |  5998.00 |  5028.00
 8 | Wed Jan 01 23:00:00 2020 | 232.00 | 392.00 | 312.00 | 2019.33 | 2666.00 | 2342.67 |  6058.00 |  7998.00 |  7028.00
 8 | Thu Jan 02 00:00:00 2020 | 232.00 | 392.00 | 312.00 | 2686.00 | 3332.67 | 3009.33 |  8058.00 |  9998.00 |  9028.00
 8 | Thu Jan 02 01:00:00 2020 | 232.00 | 392.00 | 312.00 | 3352.67 | 3666.00 | 3509.33 | 10058.00 | 10998.00 | 10528.00
 9 | Wed Jan 01 20:00:00 2020 | 236.00 | 396.00 | 316.00 |   19.67 |  666.33 |  343.00 |    59.00 |  1999.00 |  1029.00
 9 | Wed Jan 01 21:00:00 2020 | 236.00 | 396.00 | 316.00 |  686.33 | 1333.00 | 1009.67 |  2059.00 |  3999.00 |  3029.00
 9 | Wed Jan 01 22:00:00 2020 | 236.00 | 396.00 | 316.00 | 1353.00 | 1999.67 | 1676.33 |  4059.00 |  5999.00 |  5029.00
 9 | Wed Jan 01 23:00:00 2020 | 236.00 | 396.00 | 316.00 | 2019.67 | 2666.33 | 2343.00 |  6059.00 |  7999.00 |  7029.00
 9 | Thu Jan 02 00:00:00 2020 | 236.00 | 396.00 | 316.00 | 2686.33 | 3333.00 | 3009.67 |  8059.00 |  9999.00 |  9029.00
 9 | Thu Jan 02 01:00:00 2020 | 236.00 | 396.00 | 316.00 | 3353.00 | 3666.33 | 3509.67 | 10059.00 | 10999.00 | 10529.00
(60 rows)

INSERT INTO events
SELECT v % 10 AS a,
       v % 100 AS b,
       v / 3.0 AS c,
       timestamp '2020-01-01 20:00:00' +
       ((v / 10000.0) * (timestamp '2020-01-01 15:00:00' -
                   timestamp '2020-01-01 10:00:00')) AS d,
       v AS e
FROM generate_series(12000, 13000) v;
SELECT a,
       d_hour,
       min_b::numeric(12,2),
       max_b::numeric(12,2),
       avg_b::numeric(12,2),
       min_c::numeric(12,2),
       max_c::numeric(12,2),
       avg_c::numeric(12,2),
       min_e::numeric(12,2),
       max_e::numeric(12,2),
       avg_e::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          | min_b  | max_b  | avg_b  |  min_c  |  max_c  |  avg_c  |  min_e   |  max_e   |  avg_e
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 200.00 | 360.00 | 280.00 |   16.67 |  663.33 |  340.00 |    50.00 |  1990.00 |  1020.00
 0 | Wed Jan 01 21:00:00 2020 | 200.00 | 360.00 | 280.00 |  683.33 | 1330.00 | 1006.67 |  2050.00 |  3990.00 |  3020.00
 0 | Wed Jan 01 22:00:00 2020 | 200.00 | 360.00 | 280.00 | 1350.00 | 1996.67 | 1673.33 |  4050.00 |  5990.00 |  5020.00
 0 | Wed Jan 01 23:00:00 2020 | 200.00 | 360.00 | 280.00 | 2016.67 | 2663.33 | 2340.00 |  6050.00 |  7990.00 |  7020.00
 0 | Thu Jan 02 00:00:00 2020 | 200.00 | 360.00 | 280.00 | 2683.33 | 3330.00 | 3006.67 |  8050.00 |  9990.00 |  9020.00
 0 | Thu Jan 02 01:00:00 2020 | 200.00 | 360.00 | 280.00 | 3350.00 | 3663.33 | 3506.67 | 10050.00 | 10990.00 | 10520.00
 0 | Thu Jan 02 02:00:00 2020 |  20.00 |  90.00 |  55.00 | 4006.67 | 4330.00 | 4168.33 | 12020.00 | 12990.00 | 12505.00
 1 | Wed Jan 01 20:00:00 2020 | 204.00 | 364.00 | 284.00 |   17.00 |  663.67 |  340.33 |    51.00 |  1991.00 |  1021.00
 1 | Wed Jan 01 21:00:00 2020 | 204.00 | 364.00 | 284.00 |  683.67 | 1330.33 | 1007.00 |  2051.00 |  3991.00 |  3021.00
 1 | Wed Jan 01 22:00:00 2020 | 204.00 | 364.00 | 284.00 | 1350.33 | 1997.00 | 1673.67 |  4051.00 |  5991.00 |  5021.00
 1 | Wed Jan 01 23:00:00 2020 | 204.00 | 364.00 | 284.00 | 2017.00 | 2663.67 | 2340.33 |  6051.00 |  7991.00 |  7021.00
 1 | Thu Jan 02 00:00:00 2020 | 204.00 | 364.00 | 284.00 | 2683.67 | 3330.33 | 3007.00 |  8051.00 |  9991.00 |  9021.00
 1 | Thu Jan 02 01:00:00 2020 | 204.00 | 364.00 | 284.00 | 3350.33 | 3663.67 | 3507.00 | 10051.00 | 10991.00 | 10521.00
 1 | Thu Jan 02 02:00:00 2020 |  11.00 |  91.00 |  51.00 | 4003.67 | 4330.33 | 4167.00 | 12011.00 | 12991.00 | 12501.00
 2 | Wed Jan 01 20:00:00 2020 | 208.00 | 368.00 | 288.00 |   17.33 |  664.00 |  340.67 |    52.00 |  1992.00 |  1022.00
 2 | Wed Jan 01 21:00:00 2020 | 208.00 | 368.00 | 288.00 |  684.00 | 1330.67 | 1007.33 |  2052.00 |  3992.00 |  3022.00
 2 | Wed Jan 01 22:00:00 2020 | 208.00 | 368.00 | 288.00 | 1350.67 | 1997.33 | 1674.00 |  4052.00 |  5992.00 |  5022.00
 2 | Wed Jan 01 23:00:00 2020 | 208.00 | 368.00 | 288.00 | 2017.33 | 2664.00 | 2340.67 |  6052.00 |  7992.00 |  7022.00
 2 | Thu Jan 02 00:00:00 2020 | 208.00 | 368.00 | 288.00 | 2684.00 | 3330.67 | 3007.33 |  8052.00 |  9992.00 |  9022.00
 2 | Thu Jan 02 01:00:00 2020 | 208.00 | 368.00 | 288.00 | 3350.67 | 3664.00 | 3507.33 | 10052.00 | 10992.00 | 10522.00
 2 | Thu Jan 02 02:00:00 2020 |  12.00 |  92.00 |  52.00 | 4004.00 | 4330.67 | 4167.33 | 12012.00 | 12992.00 | 12502.00
 3 | Wed Jan 01 20:00:00 2020 | 212.00 | 372.00 | 292.00 |   17.67 |  664.33 |  341.00 |    53.00 |  1993.00 |  1023.00
 3 | Wed Jan 01 21:00:00 2020 | 212.00 | 372.00 | 292.00 |  684.33 | 1331.00 | 1007.67 |  2053.00 |  3993.00 |  3023.00
 3 | Wed Jan 01 22:00:00 2020 | 212.00 | 372.00 | 292.00 | 1351.00 | 1997.67 | 1674.33 |  4053.00 |  5993.00 |  5023.00
 3 | Wed Jan 01 23:00:00 2020 | 212.00 | 372.00 | 292.00 | 2017.67 | 2664.33 | 2341.00 |  6053.00 |  7993.00 |  7023.00
 3 | Thu Jan 02 00:00:00 2020 | 212.00 | 372.00 | 292.00 | 2684.33 | 3331.00 | 3007.67 |  8053.00 |  9993.00 |  9023.00
 3 | Thu Jan 02 01:00:00 2020 | 212.00 | 372.00 | 292.00 | 3351.00 | 3664.33 | 3507.67 | 10053.00 | 10993.00 | 10523.00
 3 | Thu Jan 02 02:00:00 2020 |  13.00 |  93.00 |  53.00 | 4004.33 | 4331.00 | 4167.67 | 12013.00 | 12993.00 | 12503.00
 4 | Wed Jan 01 20:00:00 2020 | 216.00 | 376.00 | 296.00 |   18.00 |  664.67 |  341.33 |    54.00 |  1994.00 |  1024.00
 4 | Wed Jan 01 21:00:00 2020 | 216.00 | 376.00 | 296.00 |  684.67 | 1331.33 | 1008.00 |  2054.00 |  3994.00 |  3024.00
 4 | Wed Jan 01 22:00:00 2020 | 216.00 | 376.00 | 296.00 | 1351.33 | 1998.00 | 1674.67 |  4054.00 |  5994.00 |  5024.00
 4 | Wed Jan 01 23:00:00 2020 | 216.00 | 376.00 | 296.00 | 2018.00 | 2664.67 | 2341.33 |  6054.00 |  7994.00 |  7024.00
 4 | Thu Jan 02 00:00:00 2020 | 216.00 | 376.00 | 296.00 | 2684.67 | 3331.33 | 3008.00 |  8054.00 |  9994.00 |  9024.00
 4 | Thu Jan 02 01:00:00 2020 | 216.00 | 376.00 | 296.00 | 3351.33 | 3664.67 | 3508.00 | 10054.00 | 10994.00 | 10524.00
 4 | Thu Jan 02 02:00:00 2020 |  14.00 |  94.00 |  54.00 | 4004.67 | 4331.33 | 4168.00 | 12014.00 | 12994.00 | 12504.00
 5 | Wed Jan 01 20:00:00 2020 | 220.00 | 380.00 | 300.00 |   18.33 |  665.00 |  341.67 |    55.00 |  1995.00 |  1025.00
 5 | Wed Jan 01 21:00:00 2020 | 220.00 | 380.00 | 300.00 |  685.00 | 1331.67 | 1008.33 |  2055.00 |  3995.00 |  3025.00
 5 | Wed Jan 01 22:00:00 2020 | 220.00 | 380.00 | 300.00 | 1351.67 | 1998.33 | 1675.00 |  4055.00 |  5995.00 |  5025.00
 5 | Wed Jan 01 23:00:00 2020 | 220.00 | 380.00 | 300.00 | 2018.33 | 2665.00 | 2341.67 |  6055.00 |  7995.00 |  7025.00
 5 | Thu Jan 02 00:00:00 2020 | 220.00 | 380.00 | 300.00 | 2685.00 | 3331.67 | 3008.33 |  8055.00 |  9995.00 |  9025.00
 5 | Thu Jan 02 01:00:00 2020 | 220.00 | 380.00 | 300.00 | 3351.67 | 3665.00 | 3508.33 | 10055.00 | 10995.00 | 10525.00
 5 | Thu Jan 02 02:00:00 2020 |  15.00 |  95.00 |  55.00 | 4005.00 | 4331.67 | 4168.33 | 12015.00 | 12995.00 | 12505.00
 6 | Wed Jan 01 20:00:00 2020 | 224.00 | 384.00 | 304.00 |   18.67 |  665.33 |  342.00 |    56.00 |  1996.00 |  1026.00
 6 | Wed Jan 01 21:00:00 2020 | 224.00 | 384.00 | 304.00 |  685.33 | 1332.00 | 1008.67 |  2056.00 |  3996.00 |  3026.00
 6 | Wed Jan 01 22:00:00 2020 | 224.00 | 384.00 | 304.00 | 1352.00 | 1998.67 | 1675.33 |  4056.00 |  5996.00 |  5026.00
 6 | Wed Jan 01 23:00:00 2020 | 224.00 | 384.00 | 304.00 | 2018.67 | 2665.33 | 2342.00 |  6056.00 |  7996.00 |  7026.00
 6 | Thu Jan 02 00:00:00 2020 | 224.00 | 384.00 | 304.00 | 2685.33 | 3332.00 | 3008.67 |  8056.00 |  9996.00 |  9026.00
 6 | Thu Jan 02 01:00:00 2020 | 224.00 | 384.00 | 304.00 | 3352.00 | 3665.33 | 3508.67 | 10056.00 | 10996.00 | 10526.00
 6 | Thu Jan 02 02:00:00 2020 |  16.00 |  96.00 |  56.00 | 4005.33 | 4332.00 | 4168.67 | 12016.00 | 12996.00 | 12506.00
 7 | Wed Jan 01 20:00:00 2020 | 228.00 | 388.00 | 308.00 |   19.00 |  665.67 |  342.33 |    57.00 |  1997.00 |  1027.00
 7 | Wed Jan 01 21:00:00 2020 | 228.00 | 388.00 | 308.00 |  685.67 | 1332.33 | 1009.00 |  2057.00 |  3997.00 |  3027.00
 7 | Wed Jan 01 22:00:00 2020 | 228.00 | 388.00 | 308.00 | 1352.33 | 1999.00 | 1675.67 |  4057.00 |  5997.00 |  5027.00
 7 | Wed Jan 01 23:00:00 2020 | 228.00 | 388.00 | 308.00 | 2019.00 | 2665.67 | 2342.33 |  6057.00 |  7997.00 |  7027.00
 7 | Thu Jan 02 00:00:00 2020 | 228.00 | 388.00 | 308.00 | 2685.67 | 3332.33 | 3009.00 |  8057.00 |  9997.00 |  9027.00
 7 | Thu Jan 02 01:00:00 2020 | 228.00 | 388.00 | 308.00 | 3352.33 | 3665.67 | 3509.00 | 10057.00 | 10997.00 | 10527.00
 7 | Thu Jan 02 02:00:00 2020 |  17.00 |  97.00 |  57.00 | 4005.67 | 4332.33 | 4169.00 | 12017.00 | 12997.00 | 12507.00
 8 | Wed Jan 01 20:00:00 2020 | 232.00 | 392.00 | 312.00 |   19.33 |  666.00 |  342.67 |    58.00 |  1998.00 |  1028.00
 8 | Wed Jan 01 21:00:00 2020 | 232.00 | 392.00 | 312.00 |  686.00 | 1332.67 | 1009.33 |  2058.00 |  3998.00 |  3028.00
 8 | Wed Jan 01 22:00:00 2020 | 232.00 | 392.00 | 312.00 | 1352.67 | 1999.33 | 1676.00 |  4058.00 |  5998.00 |  5028.00
 8 | Wed Jan 01 23:00:00 2020 | 232.00 | 392.00 | 312.00 | 2019.33 | 2666.00 | 2342.67 |  6058.00 |  7998.00 |  7028.00
 8 | Thu Jan 02 00:00:00 2020 | 232.00 | 392.00 | 312.00 | 2686.00 | 3332.67 | 3009.33 |  8058.00 |  9998.00 |  9028.00
 8 | Thu Jan 02 01:00:00 2020 | 232.00 | 392.00 | 312.00 | 3352.67 | 3666.00 | 3509.33 | 10058.00 | 10998.00 | 10528.00
 8 | Thu Jan 02 02:00:00 2020 |  18.00 |  98.00 |  58.00 | 4006.00 | 4332.67 | 4169.33 | 12018.00 | 12998.00 | 12508.00
 9 | Wed Jan 01 20:00:00 2020 | 236.00 | 396.00 | 316.00 |   19.67 |  666.33 |  343.00 |    59.00 |  1999.00 |  1029.00
 9 | Wed Jan 01 21:00:00 2020 | 236.00 | 396.00 | 316.00 |  686.33 | 1333.00 | 1009.67 |  2059.00 |  3999.00 |  3029.00
 9 | Wed Jan 01 22:00:00 2020 | 236.00 | 396.00 | 316.00 | 1353.00 | 1999.67 | 1676.33 |  4059.00 |  5999.00 |  5029.00
 9 | Wed Jan 01 23:00:00 2020 | 236.00 | 396.00 | 316.00 | 2019.67 | 2666.33 | 2343.00 |  6059.00 |  7999.00 |  7029.00
 9 | Thu Jan 02 00:00:00 2020 | 236.00 | 396.00 | 316.00 | 2686.33 | 3333.00 | 3009.67 |  8059.00 |  9999.00 |  9029.00
 9 | Thu Jan 02 01:00:00 2020 | 236.00 | 396.00 | 316.00 | 3353.00 | 3666.33 | 3509.67 | 10059.00 | 10999.00 | 10529.00
 9 | Thu Jan 02 02:00:00 2020 |  19.00 |  99.00 |  59.00 | 4006.33 | 4333.00 | 4169.67 | 12019.00 | 12999.00 | 12509.00
(70 rows)

DELETE FROM events WHERE b < 100;
ERROR:  MATERIALIZED VIEW 'mv' on table 'events' does not support UPDATE/DELETE
DROP VIEW mv;
ERROR:  DROP VIEW not supported for mv
DROP MATERIALIZED VIEW mv;
CREATE MATERIALIZED VIEW mv WITH (citus.cimv) AS
SELECT a,
       date_trunc('hour', d) AS d_hour,
       avg(b) AS avg_b
FROM events
WHERE b > 10
GROUP BY a, d_hour;
SELECT a,
       d_hour,
       avg_b::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          | avg_b
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 280.00
 0 | Wed Jan 01 21:00:00 2020 | 280.00
 0 | Wed Jan 01 22:00:00 2020 | 280.00
 0 | Wed Jan 01 23:00:00 2020 | 280.00
 0 | Thu Jan 02 00:00:00 2020 | 280.00
 0 | Thu Jan 02 01:00:00 2020 | 280.00
 0 | Thu Jan 02 02:00:00 2020 |  55.00
 1 | Wed Jan 01 20:00:00 2020 | 284.00
 1 | Wed Jan 01 21:00:00 2020 | 284.00
 1 | Wed Jan 01 22:00:00 2020 | 284.00
 1 | Wed Jan 01 23:00:00 2020 | 284.00
 1 | Thu Jan 02 00:00:00 2020 | 284.00
 1 | Thu Jan 02 01:00:00 2020 | 284.00
 1 | Thu Jan 02 02:00:00 2020 |  51.00
 2 | Wed Jan 01 20:00:00 2020 | 288.00
 2 | Wed Jan 01 21:00:00 2020 | 288.00
 2 | Wed Jan 01 22:00:00 2020 | 288.00
 2 | Wed Jan 01 23:00:00 2020 | 288.00
 2 | Thu Jan 02 00:00:00 2020 | 288.00
 2 | Thu Jan 02 01:00:00 2020 | 288.00
 2 | Thu Jan 02 02:00:00 2020 |  52.00
 3 | Wed Jan 01 20:00:00 2020 | 292.00
 3 | Wed Jan 01 21:00:00 2020 | 292.00
 3 | Wed Jan 01 22:00:00 2020 | 292.00
 3 | Wed Jan 01 23:00:00 2020 | 292.00
 3 | Thu Jan 02 00:00:00 2020 | 292.00
 3 | Thu Jan 02 01:00:00 2020 | 292.00
 3 | Thu Jan 02 02:00:00 2020 |  53.00
 4 | Wed Jan 01 20:00:00 2020 | 296.00
 4 | Wed Jan 01 21:00:00 2020 | 296.00
 4 | Wed Jan 01 22:00:00 2020 | 296.00
 4 | Wed Jan 01 23:00:00 2020 | 296.00
 4 | Thu Jan 02 00:00:00 2020 | 296.00
 4 | Thu Jan 02 01:00:00 2020 | 296.00
 4 | Thu Jan 02 02:00:00 2020 |  54.00
 5 | Wed Jan 01 20:00:00 2020 | 300.00
 5 | Wed Jan 01 21:00:00 2020 | 300.00
 5 | Wed Jan 01 22:00:00 2020 | 300.00
 5 | Wed Jan 01 23:00:00 2020 | 300.00
 5 | Thu Jan 02 00:00:00 2020 | 300.00
 5 | Thu Jan 02 01:00:00 2020 | 300.00
 5 | Thu Jan 02 02:00:00 2020 |  55.00
 6 | Wed Jan 01 20:00:00 2020 | 304.00
 6 | Wed Jan 01 21:00:00 2020 | 304.00
 6 | Wed Jan 01 22:00:00 2020 | 304.00
 6 | Wed Jan 01 23:00:00 2020 | 304.00
 6 | Thu Jan 02 00:00:00 2020 | 304.00
 6 | Thu Jan 02 01:00:00 2020 | 304.00
 6 | Thu Jan 02 02:00:00 2020 |  56.00
 7 | Wed Jan 01 20:00:00 2020 | 308.00
 7 | Wed Jan 01 21:00:00 2020 | 308.00
 7 | Wed Jan 01 22:00:00 2020 | 308.00
 7 | Wed Jan 01 23:00:00 2020 | 308.00
 7 | Thu Jan 02 00:00:00 2020 | 308.00
 7 | Thu Jan 02 01:00:00 2020 | 308.00
 7 | Thu Jan 02 02:00:00 2020 |  57.00
 8 | Wed Jan 01 20:00:00 2020 | 312.00
 8 | Wed Jan 01 21:00:00 2020 | 312.00
 8 | Wed Jan 01 22:00:00 2020 | 312.00
 8 | Wed Jan 01 23:00:00 2020 | 312.00
 8 | Thu Jan 02 00:00:00 2020 | 312.00
 8 | Thu Jan 02 01:00:00 2020 | 312.00
 8 | Thu Jan 02 02:00:00 2020 |  58.00
 9 | Wed Jan 01 20:00:00 2020 | 316.00
 9 | Wed Jan 01 21:00:00 2020 | 316.00
 9 | Wed Jan 01 22:00:00 2020 | 316.00
 9 | Wed Jan 01 23:00:00 2020 | 316.00
 9 | Thu Jan 02 00:00:00 2020 | 316.00
 9 | Thu Jan 02 01:00:00 2020 | 316.00
 9 | Thu Jan 02 02:00:00 2020 |  59.00
(70 rows)

DELETE FROM events WHERE b < 20;
SELECT a,
       d_hour,
       avg_b::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          | avg_b
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 280.00
 0 | Wed Jan 01 21:00:00 2020 | 280.00
 0 | Wed Jan 01 22:00:00 2020 | 280.00
 0 | Wed Jan 01 23:00:00 2020 | 280.00
 0 | Thu Jan 02 00:00:00 2020 | 280.00
 0 | Thu Jan 02 01:00:00 2020 | 280.00
 0 | Thu Jan 02 02:00:00 2020 |  55.00
 1 | Wed Jan 01 20:00:00 2020 | 284.00
 1 | Wed Jan 01 21:00:00 2020 | 284.00
 1 | Wed Jan 01 22:00:00 2020 | 284.00
 1 | Wed Jan 01 23:00:00 2020 | 284.00
 1 | Thu Jan 02 00:00:00 2020 | 284.00
 1 | Thu Jan 02 01:00:00 2020 | 284.00
 1 | Thu Jan 02 02:00:00 2020 |  56.00
 2 | Wed Jan 01 20:00:00 2020 | 288.00
 2 | Wed Jan 01 21:00:00 2020 | 288.00
 2 | Wed Jan 01 22:00:00 2020 | 288.00
 2 | Wed Jan 01 23:00:00 2020 | 288.00
 2 | Thu Jan 02 00:00:00 2020 | 288.00
 2 | Thu Jan 02 01:00:00 2020 | 288.00
 2 | Thu Jan 02 02:00:00 2020 |  57.00
 3 | Wed Jan 01 20:00:00 2020 | 292.00
 3 | Wed Jan 01 21:00:00 2020 | 292.00
 3 | Wed Jan 01 22:00:00 2020 | 292.00
 3 | Wed Jan 01 23:00:00 2020 | 292.00
 3 | Thu Jan 02 00:00:00 2020 | 292.00
 3 | Thu Jan 02 01:00:00 2020 | 292.00
 3 | Thu Jan 02 02:00:00 2020 |  58.00
 4 | Wed Jan 01 20:00:00 2020 | 296.00
 4 | Wed Jan 01 21:00:00 2020 | 296.00
 4 | Wed Jan 01 22:00:00 2020 | 296.00
 4 | Wed Jan 01 23:00:00 2020 | 296.00
 4 | Thu Jan 02 00:00:00 2020 | 296.00
 4 | Thu Jan 02 01:00:00 2020 | 296.00
 4 | Thu Jan 02 02:00:00 2020 |  59.00
 5 | Wed Jan 01 20:00:00 2020 | 300.00
 5 | Wed Jan 01 21:00:00 2020 | 300.00
 5 | Wed Jan 01 22:00:00 2020 | 300.00
 5 | Wed Jan 01 23:00:00 2020 | 300.00
 5 | Thu Jan 02 00:00:00 2020 | 300.00
 5 | Thu Jan 02 01:00:00 2020 | 300.00
 5 | Thu Jan 02 02:00:00 2020 |  60.00
 6 | Wed Jan 01 20:00:00 2020 | 304.00
 6 | Wed Jan 01 21:00:00 2020 | 304.00
 6 | Wed Jan 01 22:00:00 2020 | 304.00
 6 | Wed Jan 01 23:00:00 2020 | 304.00
 6 | Thu Jan 02 00:00:00 2020 | 304.00
 6 | Thu Jan 02 01:00:00 2020 | 304.00
 6 | Thu Jan 02 02:00:00 2020 |  61.00
 7 | Wed Jan 01 20:00:00 2020 | 308.00
 7 | Wed Jan 01 21:00:00 2020 | 308.00
 7 | Wed Jan 01 22:00:00 2020 | 308.00
 7 | Wed Jan 01 23:00:00 2020 | 308.00
 7 | Thu Jan 02 00:00:00 2020 | 308.00
 7 | Thu Jan 02 01:00:00 2020 | 308.00
 7 | Thu Jan 02 02:00:00 2020 |  62.00
 8 | Wed Jan 01 20:00:00 2020 | 312.00
 8 | Wed Jan 01 21:00:00 2020 | 312.00
 8 | Wed Jan 01 22:00:00 2020 | 312.00
 8 | Wed Jan 01 23:00:00 2020 | 312.00
 8 | Thu Jan 02 00:00:00 2020 | 312.00
 8 | Thu Jan 02 01:00:00 2020 | 312.00
 8 | Thu Jan 02 02:00:00 2020 |  63.00
 9 | Wed Jan 01 20:00:00 2020 | 316.00
 9 | Wed Jan 01 21:00:00 2020 | 316.00
 9 | Wed Jan 01 22:00:00 2020 | 316.00
 9 | Wed Jan 01 23:00:00 2020 | 316.00
 9 | Thu Jan 02 00:00:00 2020 | 316.00
 9 | Thu Jan 02 01:00:00 2020 | 316.00
 9 | Thu Jan 02 02:00:00 2020 |  64.00
(70 rows)

UPDATE events SET b = b + b;
SELECT a,
       d_hour,
       avg_b::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          | avg_b
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 560.00
 0 | Wed Jan 01 21:00:00 2020 | 560.00
 0 | Wed Jan 01 22:00:00 2020 | 560.00
 0 | Wed Jan 01 23:00:00 2020 | 560.00
 0 | Thu Jan 02 00:00:00 2020 | 560.00
 0 | Thu Jan 02 01:00:00 2020 | 560.00
 0 | Thu Jan 02 02:00:00 2020 | 110.00
 1 | Wed Jan 01 20:00:00 2020 | 568.00
 1 | Wed Jan 01 21:00:00 2020 | 568.00
 1 | Wed Jan 01 22:00:00 2020 | 568.00
 1 | Wed Jan 01 23:00:00 2020 | 568.00
 1 | Thu Jan 02 00:00:00 2020 | 568.00
 1 | Thu Jan 02 01:00:00 2020 | 568.00
 1 | Thu Jan 02 02:00:00 2020 | 112.00
 2 | Wed Jan 01 20:00:00 2020 | 576.00
 2 | Wed Jan 01 21:00:00 2020 | 576.00
 2 | Wed Jan 01 22:00:00 2020 | 576.00
 2 | Wed Jan 01 23:00:00 2020 | 576.00
 2 | Thu Jan 02 00:00:00 2020 | 576.00
 2 | Thu Jan 02 01:00:00 2020 | 576.00
 2 | Thu Jan 02 02:00:00 2020 | 114.00
 3 | Wed Jan 01 20:00:00 2020 | 584.00
 3 | Wed Jan 01 21:00:00 2020 | 584.00
 3 | Wed Jan 01 22:00:00 2020 | 584.00
 3 | Wed Jan 01 23:00:00 2020 | 584.00
 3 | Thu Jan 02 00:00:00 2020 | 584.00
 3 | Thu Jan 02 01:00:00 2020 | 584.00
 3 | Thu Jan 02 02:00:00 2020 | 116.00
 4 | Wed Jan 01 20:00:00 2020 | 592.00
 4 | Wed Jan 01 21:00:00 2020 | 592.00
 4 | Wed Jan 01 22:00:00 2020 | 592.00
 4 | Wed Jan 01 23:00:00 2020 | 592.00
 4 | Thu Jan 02 00:00:00 2020 | 592.00
 4 | Thu Jan 02 01:00:00 2020 | 592.00
 4 | Thu Jan 02 02:00:00 2020 | 118.00
 5 | Wed Jan 01 20:00:00 2020 | 600.00
 5 | Wed Jan 01 21:00:00 2020 | 600.00
 5 | Wed Jan 01 22:00:00 2020 | 600.00
 5 | Wed Jan 01 23:00:00 2020 | 600.00
 5 | Thu Jan 02 00:00:00 2020 | 600.00
 5 | Thu Jan 02 01:00:00 2020 | 600.00
 5 | Thu Jan 02 02:00:00 2020 | 120.00
 6 | Wed Jan 01 20:00:00 2020 | 608.00
 6 | Wed Jan 01 21:00:00 2020 | 608.00
 6 | Wed Jan 01 22:00:00 2020 | 608.00
 6 | Wed Jan 01 23:00:00 2020 | 608.00
 6 | Thu Jan 02 00:00:00 2020 | 608.00
 6 | Thu Jan 02 01:00:00 2020 | 608.00
 6 | Thu Jan 02 02:00:00 2020 | 122.00
 7 | Wed Jan 01 20:00:00 2020 | 616.00
 7 | Wed Jan 01 21:00:00 2020 | 616.00
 7 | Wed Jan 01 22:00:00 2020 | 616.00
 7 | Wed Jan 01 23:00:00 2020 | 616.00
 7 | Thu Jan 02 00:00:00 2020 | 616.00
 7 | Thu Jan 02 01:00:00 2020 | 616.00
 7 | Thu Jan 02 02:00:00 2020 | 124.00
 8 | Wed Jan 01 20:00:00 2020 | 624.00
 8 | Wed Jan 01 21:00:00 2020 | 624.00
 8 | Wed Jan 01 22:00:00 2020 | 624.00
 8 | Wed Jan 01 23:00:00 2020 | 624.00
 8 | Thu Jan 02 00:00:00 2020 | 624.00
 8 | Thu Jan 02 01:00:00 2020 | 624.00
 8 | Thu Jan 02 02:00:00 2020 | 126.00
 9 | Wed Jan 01 20:00:00 2020 | 632.00
 9 | Wed Jan 01 21:00:00 2020 | 632.00
 9 | Wed Jan 01 22:00:00 2020 | 632.00
 9 | Wed Jan 01 23:00:00 2020 | 632.00
 9 | Thu Jan 02 00:00:00 2020 | 632.00
 9 | Thu Jan 02 01:00:00 2020 | 632.00
 9 | Thu Jan 02 02:00:00 2020 | 128.00
(70 rows)

DROP MATERIALIZED VIEW mv;
CREATE MATERIALIZED VIEW mv WITH (citus.cimv, citus.insertonlycapture) AS
SELECT a,
       date_trunc('hour', d) AS d_hour,
       avg(b) AS avg_b
FROM events
WHERE b > 10
GROUP BY a, d_hour;
SELECT a,
       d_hour,
       avg_b::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          | avg_b
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 560.00
 0 | Wed Jan 01 21:00:00 2020 | 560.00
 0 | Wed Jan 01 22:00:00 2020 | 560.00
 0 | Wed Jan 01 23:00:00 2020 | 560.00
 0 | Thu Jan 02 00:00:00 2020 | 560.00
 0 | Thu Jan 02 01:00:00 2020 | 560.00
 0 | Thu Jan 02 02:00:00 2020 | 110.00
 1 | Wed Jan 01 20:00:00 2020 | 568.00
 1 | Wed Jan 01 21:00:00 2020 | 568.00
 1 | Wed Jan 01 22:00:00 2020 | 568.00
 1 | Wed Jan 01 23:00:00 2020 | 568.00
 1 | Thu Jan 02 00:00:00 2020 | 568.00
 1 | Thu Jan 02 01:00:00 2020 | 568.00
 1 | Thu Jan 02 02:00:00 2020 | 112.00
 2 | Wed Jan 01 20:00:00 2020 | 576.00
 2 | Wed Jan 01 21:00:00 2020 | 576.00
 2 | Wed Jan 01 22:00:00 2020 | 576.00
 2 | Wed Jan 01 23:00:00 2020 | 576.00
 2 | Thu Jan 02 00:00:00 2020 | 576.00
 2 | Thu Jan 02 01:00:00 2020 | 576.00
 2 | Thu Jan 02 02:00:00 2020 | 114.00
 3 | Wed Jan 01 20:00:00 2020 | 584.00
 3 | Wed Jan 01 21:00:00 2020 | 584.00
 3 | Wed Jan 01 22:00:00 2020 | 584.00
 3 | Wed Jan 01 23:00:00 2020 | 584.00
 3 | Thu Jan 02 00:00:00 2020 | 584.00
 3 | Thu Jan 02 01:00:00 2020 | 584.00
 3 | Thu Jan 02 02:00:00 2020 | 116.00
 4 | Wed Jan 01 20:00:00 2020 | 592.00
 4 | Wed Jan 01 21:00:00 2020 | 592.00
 4 | Wed Jan 01 22:00:00 2020 | 592.00
 4 | Wed Jan 01 23:00:00 2020 | 592.00
 4 | Thu Jan 02 00:00:00 2020 | 592.00
 4 | Thu Jan 02 01:00:00 2020 | 592.00
 4 | Thu Jan 02 02:00:00 2020 | 118.00
 5 | Wed Jan 01 20:00:00 2020 | 600.00
 5 | Wed Jan 01 21:00:00 2020 | 600.00
 5 | Wed Jan 01 22:00:00 2020 | 600.00
 5 | Wed Jan 01 23:00:00 2020 | 600.00
 5 | Thu Jan 02 00:00:00 2020 | 600.00
 5 | Thu Jan 02 01:00:00 2020 | 600.00
 5 | Thu Jan 02 02:00:00 2020 | 120.00
 6 | Wed Jan 01 20:00:00 2020 | 608.00
 6 | Wed Jan 01 21:00:00 2020 | 608.00
 6 | Wed Jan 01 22:00:00 2020 | 608.00
 6 | Wed Jan 01 23:00:00 2020 | 608.00
 6 | Thu Jan 02 00:00:00 2020 | 608.00
 6 | Thu Jan 02 01:00:00 2020 | 608.00
 6 | Thu Jan 02 02:00:00 2020 | 122.00
 7 | Wed Jan 01 20:00:00 2020 | 616.00
 7 | Wed Jan 01 21:00:00 2020 | 616.00
 7 | Wed Jan 01 22:00:00 2020 | 616.00
 7 | Wed Jan 01 23:00:00 2020 | 616.00
 7 | Thu Jan 02 00:00:00 2020 | 616.00
 7 | Thu Jan 02 01:00:00 2020 | 616.00
 7 | Thu Jan 02 02:00:00 2020 | 124.00
 8 | Wed Jan 01 20:00:00 2020 | 624.00
 8 | Wed Jan 01 21:00:00 2020 | 624.00
 8 | Wed Jan 01 22:00:00 2020 | 624.00
 8 | Wed Jan 01 23:00:00 2020 | 624.00
 8 | Thu Jan 02 00:00:00 2020 | 624.00
 8 | Thu Jan 02 01:00:00 2020 | 624.00
 8 | Thu Jan 02 02:00:00 2020 | 126.00
 9 | Wed Jan 01 20:00:00 2020 | 632.00
 9 | Wed Jan 01 21:00:00 2020 | 632.00
 9 | Wed Jan 01 22:00:00 2020 | 632.00
 9 | Wed Jan 01 23:00:00 2020 | 632.00
 9 | Thu Jan 02 00:00:00 2020 | 632.00
 9 | Thu Jan 02 01:00:00 2020 | 632.00
 9 | Thu Jan 02 02:00:00 2020 | 128.00
(70 rows)

INSERT INTO events
SELECT v % 10 AS a,
       v % 100 AS b,
       v / 3.0 AS c,
       timestamp '2020-01-01 20:00:00' +
       ((v / 10000.0) * (timestamp '2020-01-01 15:00:00' -
                   timestamp '2020-01-01 10:00:00')) AS d,
       v AS e
FROM generate_series(13000, 14000) v;
SELECT a,
       d_hour,
       avg_b::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          | avg_b
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 560.00
 0 | Wed Jan 01 21:00:00 2020 | 560.00
 0 | Wed Jan 01 22:00:00 2020 | 560.00
 0 | Wed Jan 01 23:00:00 2020 | 560.00
 0 | Thu Jan 02 00:00:00 2020 | 560.00
 0 | Thu Jan 02 01:00:00 2020 | 560.00
 0 | Thu Jan 02 02:00:00 2020 |  82.50
 1 | Wed Jan 01 20:00:00 2020 | 568.00
 1 | Wed Jan 01 21:00:00 2020 | 568.00
 1 | Wed Jan 01 22:00:00 2020 | 568.00
 1 | Wed Jan 01 23:00:00 2020 | 568.00
 1 | Thu Jan 02 00:00:00 2020 | 568.00
 1 | Thu Jan 02 01:00:00 2020 | 568.00
 1 | Thu Jan 02 02:00:00 2020 |  79.71
 2 | Wed Jan 01 20:00:00 2020 | 576.00
 2 | Wed Jan 01 21:00:00 2020 | 576.00
 2 | Wed Jan 01 22:00:00 2020 | 576.00
 2 | Wed Jan 01 23:00:00 2020 | 576.00
 2 | Thu Jan 02 00:00:00 2020 | 576.00
 2 | Thu Jan 02 01:00:00 2020 | 576.00
 2 | Thu Jan 02 02:00:00 2020 |  81.18
 3 | Wed Jan 01 20:00:00 2020 | 584.00
 3 | Wed Jan 01 21:00:00 2020 | 584.00
 3 | Wed Jan 01 22:00:00 2020 | 584.00
 3 | Wed Jan 01 23:00:00 2020 | 584.00
 3 | Thu Jan 02 00:00:00 2020 | 584.00
 3 | Thu Jan 02 01:00:00 2020 | 584.00
 3 | Thu Jan 02 02:00:00 2020 |  82.65
 4 | Wed Jan 01 20:00:00 2020 | 592.00
 4 | Wed Jan 01 21:00:00 2020 | 592.00
 4 | Wed Jan 01 22:00:00 2020 | 592.00
 4 | Wed Jan 01 23:00:00 2020 | 592.00
 4 | Thu Jan 02 00:00:00 2020 | 592.00
 4 | Thu Jan 02 01:00:00 2020 | 592.00
 4 | Thu Jan 02 02:00:00 2020 |  84.12
 5 | Wed Jan 01 20:00:00 2020 | 600.00
 5 | Wed Jan 01 21:00:00 2020 | 600.00
 5 | Wed Jan 01 22:00:00 2020 | 600.00
 5 | Wed Jan 01 23:00:00 2020 | 600.00
 5 | Thu Jan 02 00:00:00 2020 | 600.00
 5 | Thu Jan 02 01:00:00 2020 | 600.00
 5 | Thu Jan 02 02:00:00 2020 |  85.59
 6 | Wed Jan 01 20:00:00 2020 | 608.00
 6 | Wed Jan 01 21:00:00 2020 | 608.00
 6 | Wed Jan 01 22:00:00 2020 | 608.00
 6 | Wed Jan 01 23:00:00 2020 | 608.00
 6 | Thu Jan 02 00:00:00 2020 | 608.00
 6 | Thu Jan 02 01:00:00 2020 | 608.00
 6 | Thu Jan 02 02:00:00 2020 |  87.06
 7 | Wed Jan 01 20:00:00 2020 | 616.00
 7 | Wed Jan 01 21:00:00 2020 | 616.00
 7 | Wed Jan 01 22:00:00 2020 | 616.00
 7 | Wed Jan 01 23:00:00 2020 | 616.00
 7 | Thu Jan 02 00:00:00 2020 | 616.00
 7 | Thu Jan 02 01:00:00 2020 | 616.00
 7 | Thu Jan 02 02:00:00 2020 |  88.53
 8 | Wed Jan 01 20:00:00 2020 | 624.00
 8 | Wed Jan 01 21:00:00 2020 | 624.00
 8 | Wed Jan 01 22:00:00 2020 | 624.00
 8 | Wed Jan 01 23:00:00 2020 | 624.00
 8 | Thu Jan 02 00:00:00 2020 | 624.00
 8 | Thu Jan 02 01:00:00 2020 | 624.00
 8 | Thu Jan 02 02:00:00 2020 |  90.00
 9 | Wed Jan 01 20:00:00 2020 | 632.00
 9 | Wed Jan 01 21:00:00 2020 | 632.00
 9 | Wed Jan 01 22:00:00 2020 | 632.00
 9 | Wed Jan 01 23:00:00 2020 | 632.00
 9 | Thu Jan 02 00:00:00 2020 | 632.00
 9 | Thu Jan 02 01:00:00 2020 | 632.00
 9 | Thu Jan 02 02:00:00 2020 |  91.47
(70 rows)

DELETE FROM events WHERE b < 100;
SELECT a,
       d_hour,
       avg_b::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          | avg_b
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 560.00
 0 | Wed Jan 01 21:00:00 2020 | 560.00
 0 | Wed Jan 01 22:00:00 2020 | 560.00
 0 | Wed Jan 01 23:00:00 2020 | 560.00
 0 | Thu Jan 02 00:00:00 2020 | 560.00
 0 | Thu Jan 02 01:00:00 2020 | 560.00
 0 | Thu Jan 02 02:00:00 2020 |  82.50
 1 | Wed Jan 01 20:00:00 2020 | 568.00
 1 | Wed Jan 01 21:00:00 2020 | 568.00
 1 | Wed Jan 01 22:00:00 2020 | 568.00
 1 | Wed Jan 01 23:00:00 2020 | 568.00
 1 | Thu Jan 02 00:00:00 2020 | 568.00
 1 | Thu Jan 02 01:00:00 2020 | 568.00
 1 | Thu Jan 02 02:00:00 2020 |  79.71
 2 | Wed Jan 01 20:00:00 2020 | 576.00
 2 | Wed Jan 01 21:00:00 2020 | 576.00
 2 | Wed Jan 01 22:00:00 2020 | 576.00
 2 | Wed Jan 01 23:00:00 2020 | 576.00
 2 | Thu Jan 02 00:00:00 2020 | 576.00
 2 | Thu Jan 02 01:00:00 2020 | 576.00
 2 | Thu Jan 02 02:00:00 2020 |  81.18
 3 | Wed Jan 01 20:00:00 2020 | 584.00
 3 | Wed Jan 01 21:00:00 2020 | 584.00
 3 | Wed Jan 01 22:00:00 2020 | 584.00
 3 | Wed Jan 01 23:00:00 2020 | 584.00
 3 | Thu Jan 02 00:00:00 2020 | 584.00
 3 | Thu Jan 02 01:00:00 2020 | 584.00
 3 | Thu Jan 02 02:00:00 2020 |  82.65
 4 | Wed Jan 01 20:00:00 2020 | 592.00
 4 | Wed Jan 01 21:00:00 2020 | 592.00
 4 | Wed Jan 01 22:00:00 2020 | 592.00
 4 | Wed Jan 01 23:00:00 2020 | 592.00
 4 | Thu Jan 02 00:00:00 2020 | 592.00
 4 | Thu Jan 02 01:00:00 2020 | 592.00
 4 | Thu Jan 02 02:00:00 2020 |  84.12
 5 | Wed Jan 01 20:00:00 2020 | 600.00
 5 | Wed Jan 01 21:00:00 2020 | 600.00
 5 | Wed Jan 01 22:00:00 2020 | 600.00
 5 | Wed Jan 01 23:00:00 2020 | 600.00
 5 | Thu Jan 02 00:00:00 2020 | 600.00
 5 | Thu Jan 02 01:00:00 2020 | 600.00
 5 | Thu Jan 02 02:00:00 2020 |  85.59
 6 | Wed Jan 01 20:00:00 2020 | 608.00
 6 | Wed Jan 01 21:00:00 2020 | 608.00
 6 | Wed Jan 01 22:00:00 2020 | 608.00
 6 | Wed Jan 01 23:00:00 2020 | 608.00
 6 | Thu Jan 02 00:00:00 2020 | 608.00
 6 | Thu Jan 02 01:00:00 2020 | 608.00
 6 | Thu Jan 02 02:00:00 2020 |  87.06
 7 | Wed Jan 01 20:00:00 2020 | 616.00
 7 | Wed Jan 01 21:00:00 2020 | 616.00
 7 | Wed Jan 01 22:00:00 2020 | 616.00
 7 | Wed Jan 01 23:00:00 2020 | 616.00
 7 | Thu Jan 02 00:00:00 2020 | 616.00
 7 | Thu Jan 02 01:00:00 2020 | 616.00
 7 | Thu Jan 02 02:00:00 2020 |  88.53
 8 | Wed Jan 01 20:00:00 2020 | 624.00
 8 | Wed Jan 01 21:00:00 2020 | 624.00
 8 | Wed Jan 01 22:00:00 2020 | 624.00
 8 | Wed Jan 01 23:00:00 2020 | 624.00
 8 | Thu Jan 02 00:00:00 2020 | 624.00
 8 | Thu Jan 02 01:00:00 2020 | 624.00
 8 | Thu Jan 02 02:00:00 2020 |  90.00
 9 | Wed Jan 01 20:00:00 2020 | 632.00
 9 | Wed Jan 01 21:00:00 2020 | 632.00
 9 | Wed Jan 01 22:00:00 2020 | 632.00
 9 | Wed Jan 01 23:00:00 2020 | 632.00
 9 | Thu Jan 02 00:00:00 2020 | 632.00
 9 | Thu Jan 02 01:00:00 2020 | 632.00
 9 | Thu Jan 02 02:00:00 2020 |  91.47
(70 rows)

UPDATE events SET b = b + b;
SELECT a,
       d_hour,
       avg_b::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          | avg_b
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 560.00
 0 | Wed Jan 01 21:00:00 2020 | 560.00
 0 | Wed Jan 01 22:00:00 2020 | 560.00
 0 | Wed Jan 01 23:00:00 2020 | 560.00
 0 | Thu Jan 02 00:00:00 2020 | 560.00
 0 | Thu Jan 02 01:00:00 2020 | 560.00
 0 | Thu Jan 02 02:00:00 2020 |  82.50
 1 | Wed Jan 01 20:00:00 2020 | 568.00
 1 | Wed Jan 01 21:00:00 2020 | 568.00
 1 | Wed Jan 01 22:00:00 2020 | 568.00
 1 | Wed Jan 01 23:00:00 2020 | 568.00
 1 | Thu Jan 02 00:00:00 2020 | 568.00
 1 | Thu Jan 02 01:00:00 2020 | 568.00
 1 | Thu Jan 02 02:00:00 2020 |  79.71
 2 | Wed Jan 01 20:00:00 2020 | 576.00
 2 | Wed Jan 01 21:00:00 2020 | 576.00
 2 | Wed Jan 01 22:00:00 2020 | 576.00
 2 | Wed Jan 01 23:00:00 2020 | 576.00
 2 | Thu Jan 02 00:00:00 2020 | 576.00
 2 | Thu Jan 02 01:00:00 2020 | 576.00
 2 | Thu Jan 02 02:00:00 2020 |  81.18
 3 | Wed Jan 01 20:00:00 2020 | 584.00
 3 | Wed Jan 01 21:00:00 2020 | 584.00
 3 | Wed Jan 01 22:00:00 2020 | 584.00
 3 | Wed Jan 01 23:00:00 2020 | 584.00
 3 | Thu Jan 02 00:00:00 2020 | 584.00
 3 | Thu Jan 02 01:00:00 2020 | 584.00
 3 | Thu Jan 02 02:00:00 2020 |  82.65
 4 | Wed Jan 01 20:00:00 2020 | 592.00
 4 | Wed Jan 01 21:00:00 2020 | 592.00
 4 | Wed Jan 01 22:00:00 2020 | 592.00
 4 | Wed Jan 01 23:00:00 2020 | 592.00
 4 | Thu Jan 02 00:00:00 2020 | 592.00
 4 | Thu Jan 02 01:00:00 2020 | 592.00
 4 | Thu Jan 02 02:00:00 2020 |  84.12
 5 | Wed Jan 01 20:00:00 2020 | 600.00
 5 | Wed Jan 01 21:00:00 2020 | 600.00
 5 | Wed Jan 01 22:00:00 2020 | 600.00
 5 | Wed Jan 01 23:00:00 2020 | 600.00
 5 | Thu Jan 02 00:00:00 2020 | 600.00
 5 | Thu Jan 02 01:00:00 2020 | 600.00
 5 | Thu Jan 02 02:00:00 2020 |  85.59
 6 | Wed Jan 01 20:00:00 2020 | 608.00
 6 | Wed Jan 01 21:00:00 2020 | 608.00
 6 | Wed Jan 01 22:00:00 2020 | 608.00
 6 | Wed Jan 01 23:00:00 2020 | 608.00
 6 | Thu Jan 02 00:00:00 2020 | 608.00
 6 | Thu Jan 02 01:00:00 2020 | 608.00
 6 | Thu Jan 02 02:00:00 2020 |  87.06
 7 | Wed Jan 01 20:00:00 2020 | 616.00
 7 | Wed Jan 01 21:00:00 2020 | 616.00
 7 | Wed Jan 01 22:00:00 2020 | 616.00
 7 | Wed Jan 01 23:00:00 2020 | 616.00
 7 | Thu Jan 02 00:00:00 2020 | 616.00
 7 | Thu Jan 02 01:00:00 2020 | 616.00
 7 | Thu Jan 02 02:00:00 2020 |  88.53
 8 | Wed Jan 01 20:00:00 2020 | 624.00
 8 | Wed Jan 01 21:00:00 2020 | 624.00
 8 | Wed Jan 01 22:00:00 2020 | 624.00
 8 | Wed Jan 01 23:00:00 2020 | 624.00
 8 | Thu Jan 02 00:00:00 2020 | 624.00
 8 | Thu Jan 02 01:00:00 2020 | 624.00
 8 | Thu Jan 02 02:00:00 2020 |  90.00
 9 | Wed Jan 01 20:00:00 2020 | 632.00
 9 | Wed Jan 01 21:00:00 2020 | 632.00
 9 | Wed Jan 01 22:00:00 2020 | 632.00
 9 | Wed Jan 01 23:00:00 2020 | 632.00
 9 | Thu Jan 02 00:00:00 2020 | 632.00
 9 | Thu Jan 02 01:00:00 2020 | 632.00
 9 | Thu Jan 02 02:00:00 2020 |  91.47
(70 rows)

REFRESH MATERIALIZED VIEW mv WITH NO DATA;
SELECT * FROM mv;
 a | d_hour | avg_b
---------------------------------------------------------------------
(0 rows)

REFRESH MATERIALIZED VIEW mv;
SELECT a,
       d_hour,
       avg_b::numeric(12,2)
FROM mv
ORDER BY a, d_hour;
 a |          d_hour          |  avg_b
---------------------------------------------------------------------
 0 | Wed Jan 01 20:00:00 2020 | 1120.00
 0 | Wed Jan 01 21:00:00 2020 | 1120.00
 0 | Wed Jan 01 22:00:00 2020 | 1120.00
 0 | Wed Jan 01 23:00:00 2020 | 1120.00
 0 | Thu Jan 02 00:00:00 2020 | 1120.00
 0 | Thu Jan 02 01:00:00 2020 | 1120.00
 0 | Thu Jan 02 02:00:00 2020 |  280.00
 1 | Wed Jan 01 20:00:00 2020 | 1136.00
 1 | Wed Jan 01 21:00:00 2020 | 1136.00
 1 | Wed Jan 01 22:00:00 2020 | 1136.00
 1 | Wed Jan 01 23:00:00 2020 | 1136.00
 1 | Thu Jan 02 00:00:00 2020 | 1136.00
 1 | Thu Jan 02 01:00:00 2020 | 1136.00
 1 | Thu Jan 02 02:00:00 2020 |  284.00
 2 | Wed Jan 01 20:00:00 2020 | 1152.00
 2 | Wed Jan 01 21:00:00 2020 | 1152.00
 2 | Wed Jan 01 22:00:00 2020 | 1152.00
 2 | Wed Jan 01 23:00:00 2020 | 1152.00
 2 | Thu Jan 02 00:00:00 2020 | 1152.00
 2 | Thu Jan 02 01:00:00 2020 | 1152.00
 2 | Thu Jan 02 02:00:00 2020 |  288.00
 3 | Wed Jan 01 20:00:00 2020 | 1168.00
 3 | Wed Jan 01 21:00:00 2020 | 1168.00
 3 | Wed Jan 01 22:00:00 2020 | 1168.00
 3 | Wed Jan 01 23:00:00 2020 | 1168.00
 3 | Thu Jan 02 00:00:00 2020 | 1168.00
 3 | Thu Jan 02 01:00:00 2020 | 1168.00
 3 | Thu Jan 02 02:00:00 2020 |  292.00
 4 | Wed Jan 01 20:00:00 2020 | 1184.00
 4 | Wed Jan 01 21:00:00 2020 | 1184.00
 4 | Wed Jan 01 22:00:00 2020 | 1184.00
 4 | Wed Jan 01 23:00:00 2020 | 1184.00
 4 | Thu Jan 02 00:00:00 2020 | 1184.00
 4 | Thu Jan 02 01:00:00 2020 | 1184.00
 4 | Thu Jan 02 02:00:00 2020 |  296.00
 5 | Wed Jan 01 20:00:00 2020 | 1200.00
 5 | Wed Jan 01 21:00:00 2020 | 1200.00
 5 | Wed Jan 01 22:00:00 2020 | 1200.00
 5 | Wed Jan 01 23:00:00 2020 | 1200.00
 5 | Thu Jan 02 00:00:00 2020 | 1200.00
 5 | Thu Jan 02 01:00:00 2020 | 1200.00
 5 | Thu Jan 02 02:00:00 2020 |  300.00
 6 | Wed Jan 01 20:00:00 2020 | 1216.00
 6 | Wed Jan 01 21:00:00 2020 | 1216.00
 6 | Wed Jan 01 22:00:00 2020 | 1216.00
 6 | Wed Jan 01 23:00:00 2020 | 1216.00
 6 | Thu Jan 02 00:00:00 2020 | 1216.00
 6 | Thu Jan 02 01:00:00 2020 | 1216.00
 6 | Thu Jan 02 02:00:00 2020 |  304.00
 7 | Wed Jan 01 20:00:00 2020 | 1232.00
 7 | Wed Jan 01 21:00:00 2020 | 1232.00
 7 | Wed Jan 01 22:00:00 2020 | 1232.00
 7 | Wed Jan 01 23:00:00 2020 | 1232.00
 7 | Thu Jan 02 00:00:00 2020 | 1232.00
 7 | Thu Jan 02 01:00:00 2020 | 1232.00
 7 | Thu Jan 02 02:00:00 2020 |  308.00
 8 | Wed Jan 01 20:00:00 2020 | 1248.00
 8 | Wed Jan 01 21:00:00 2020 | 1248.00
 8 | Wed Jan 01 22:00:00 2020 | 1248.00
 8 | Wed Jan 01 23:00:00 2020 | 1248.00
 8 | Thu Jan 02 00:00:00 2020 | 1248.00
 8 | Thu Jan 02 01:00:00 2020 | 1248.00
 8 | Thu Jan 02 02:00:00 2020 |  312.00
 9 | Wed Jan 01 20:00:00 2020 | 1264.00
 9 | Wed Jan 01 21:00:00 2020 | 1264.00
 9 | Wed Jan 01 22:00:00 2020 | 1264.00
 9 | Wed Jan 01 23:00:00 2020 | 1264.00
 9 | Thu Jan 02 00:00:00 2020 | 1264.00
 9 | Thu Jan 02 01:00:00 2020 | 1264.00
 9 | Thu Jan 02 02:00:00 2020 |  316.00
(70 rows)

DROP MATERIALIZED VIEW mv;
CREATE MATERIALIZED VIEW mv WITH (citus.cimv, citus.insertonlycapture) AS
SELECT a,
       date_trunc('hour', d) AS d_hour,
       avg(b) AS avg_b
FROM events
WHERE b > 10
GROUP BY a, d_hour WITH NO DATA;
SELECT * FROM mv;
 a | d_hour | avg_b
---------------------------------------------------------------------
(0 rows)

-- make sure same mv can be created in different schemas without overlap
CREATE SCHEMA another_schema;
SET search_path to another_schema;
SET citus.shard_count TO 4;
CREATE TABLE events (a int, b int, c double precision, d timestamp, e bigint);
CREATE MATERIALIZED VIEW mv WITH (citus.cimv) AS
SELECT a,
       date_trunc('hour', d) AS d_hour,
       min(b) AS min_b,
       max(b) AS max_b,
       avg(b) AS avg_b,
       min(c) AS min_c,
       max(c) AS max_c,
       avg(c) AS avg_c,
       min(e) AS min_e,
       max(e) AS max_e,
       avg(e) AS avg_e
FROM events
WHERE b > 10
GROUP BY a, d_hour;
DROP MATERIALIZED VIEW mv;
NOTICE:  drop cascades to 4 other objects
-- test that another user can create CIMV as well
CREATE USER new_user;
NOTICE:  not propagating CREATE ROLE/USER commands to worker nodes
CREATE SCHEMA another_schema2;
SET search_path to another_schema2;
CREATE TABLE events (a int, b int, c double precision, d timestamp, e bigint);
CREATE MATERIALIZED VIEW mv WITH (citus.cimv) AS
SELECT a,
       date_trunc('hour', d) AS d_hour,
       min(b) AS min_b,
       max(b) AS max_b,
       avg(b) AS avg_b,
       min(c) AS min_c,
       max(c) AS max_c,
       avg(c) AS avg_c,
       min(e) AS min_e,
       max(e) AS max_e,
       avg(e) AS avg_e
FROM events
WHERE b > 10
GROUP BY a, d_hour;
REFRESH MATERIALIZED VIEW mv;
DROP MATERIALIZED VIEW mv CASCADE;
NOTICE:  drop cascades to 4 other objects
SET client_min_messages TO WARNING; -- suppress cascade messages
DROP SCHEMA cimv CASCADE;
