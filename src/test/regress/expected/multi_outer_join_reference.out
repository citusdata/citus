SET citus.next_shard_id TO 1260000;
SET citus.log_multi_join_order to true;
SET client_min_messages TO LOG;
SET citus.shard_count TO 4;
CREATE TABLE multi_outer_join_left_hash
(
	l_custkey integer not null,
	l_name varchar(25) not null,
	l_address varchar(40) not null,
	l_nationkey integer not null,
	l_phone char(15) not null,
	l_acctbal decimal(15,2) not null,
	l_mktsegment char(10) not null,
	l_comment varchar(117) not null
);
SELECT create_distributed_table('multi_outer_join_left_hash', 'l_custkey');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

CREATE TABLE multi_outer_join_right_reference
(
	r_custkey integer not null,
	r_name varchar(25) not null,
	r_address varchar(40) not null,
	r_nationkey integer not null,
	r_phone char(15) not null,
	r_acctbal decimal(15,2) not null,
	r_mktsegment char(10) not null,
	r_comment varchar(117) not null
);
SELECT create_reference_table('multi_outer_join_right_reference');
 create_reference_table
---------------------------------------------------------------------

(1 row)

CREATE TABLE multi_outer_join_third_reference
(
	t_custkey integer not null,
	t_name varchar(25) not null,
	t_address varchar(40) not null,
	t_nationkey integer not null,
	t_phone char(15) not null,
	t_acctbal decimal(15,2) not null,
	t_mktsegment char(10) not null,
	t_comment varchar(117) not null
);
SELECT create_reference_table('multi_outer_join_third_reference');
 create_reference_table
---------------------------------------------------------------------

(1 row)

CREATE TABLE multi_outer_join_right_hash
(
	r_custkey integer not null,
	r_name varchar(25) not null,
	r_address varchar(40) not null,
	r_nationkey integer not null,
	r_phone char(15) not null,
	r_acctbal decimal(15,2) not null,
	r_mktsegment char(10) not null,
	r_comment varchar(117) not null
);
SELECT create_distributed_table('multi_outer_join_right_hash', 'r_custkey');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

-- Make sure we do not crash if both tables are emmpty
SELECT
	min(l_custkey), max(l_custkey)
FROM
	multi_outer_join_left_hash a LEFT JOIN multi_outer_join_third_reference b ON (l_custkey = t_custkey);
 min | max
---------------------------------------------------------------------
     |
(1 row)

-- Left table is a large table
\set customer_1_10_data :abs_srcdir '/data/customer-1-10.data'
\set customer_11_20_data :abs_srcdir '/data/customer-11-20.data'
\set client_side_copy_command '\\copy multi_outer_join_left_hash FROM ' :'customer_1_10_data' ' with delimiter '''|''';'
:client_side_copy_command
\set client_side_copy_command '\\copy multi_outer_join_left_hash FROM ' :'customer_11_20_data' ' with delimiter '''|''';'
:client_side_copy_command
-- Right table is a small table
\set customer_1_15_data :abs_srcdir '/data/customer-1-15.data'
\set client_side_copy_command '\\copy multi_outer_join_right_reference FROM ' :'customer_1_15_data' ' with delimiter '''|''';'
:client_side_copy_command
\set client_side_copy_command '\\copy multi_outer_join_right_hash FROM ' :'customer_1_15_data' ' with delimiter '''|''';'
:client_side_copy_command
-- Make sure we do not crash if one table has data
SELECT
	min(l_custkey), max(l_custkey)
FROM
	multi_outer_join_left_hash a LEFT JOIN multi_outer_join_third_reference b ON (l_custkey = t_custkey);
 min | max
---------------------------------------------------------------------
   1 |  20
(1 row)

SELECT
	min(t_custkey), max(t_custkey)
FROM
	multi_outer_join_third_reference a LEFT JOIN multi_outer_join_right_reference b ON (r_custkey = t_custkey);
 min | max
---------------------------------------------------------------------
     |
(1 row)

-- Third table is a single shard table with all data
\set customer_1_30_data :abs_srcdir '/data/customer-1-30.data'
\set client_side_copy_command '\\copy multi_outer_join_third_reference FROM ' :'customer_1_30_data' ' with delimiter '''|''';'
:client_side_copy_command
\set client_side_copy_command '\\copy multi_outer_join_right_hash FROM ' :'customer_1_30_data' ' with delimiter '''|''';'
:client_side_copy_command
-- Regular outer join should return results for all rows
SELECT
	min(l_custkey), max(l_custkey)
FROM
	multi_outer_join_left_hash a LEFT JOIN multi_outer_join_right_reference b ON (l_custkey = r_custkey);
 min | max
---------------------------------------------------------------------
   1 |  20
(1 row)

-- Since this is a broadcast join, we should be able to join on any key
SELECT
	count(*)
FROM
	multi_outer_join_left_hash a LEFT JOIN multi_outer_join_right_reference b ON (l_nationkey = r_nationkey);
 count
---------------------------------------------------------------------
    28
(1 row)

-- Anti-join should return customers for which there is no row in the right table
SELECT
	min(l_custkey), max(l_custkey)
FROM
	multi_outer_join_left_hash a LEFT JOIN multi_outer_join_right_reference b ON (l_custkey = r_custkey)
WHERE
	r_custkey IS NULL;
 min | max
---------------------------------------------------------------------
  16 |  20
(1 row)

-- Partial anti-join with specific value
SELECT
	min(l_custkey), max(l_custkey)
FROM
	multi_outer_join_left_hash a LEFT JOIN multi_outer_join_right_reference b ON (l_custkey = r_custkey)
WHERE
	r_custkey IS NULL OR r_custkey = 5;
 min | max
---------------------------------------------------------------------
   5 |  20
(1 row)

-- This query is an INNER JOIN in disguise since there cannot be NULL results
-- Added extra filter to make query not router plannable
SELECT
	min(l_custkey), max(l_custkey)
FROM
	multi_outer_join_left_hash a LEFT JOIN multi_outer_join_right_reference b ON (l_custkey = r_custkey)
WHERE
	r_custkey = 5 or r_custkey > 15;
LOG:  join order: [ "multi_outer_join_left_hash" ][ reference join "multi_outer_join_right_reference" ]
 min | max
---------------------------------------------------------------------
   5 |   5
(1 row)

-- Apply a filter before the join
SELECT
	count(l_custkey), count(r_custkey)
FROM
	multi_outer_join_left_hash a LEFT JOIN multi_outer_join_right_reference b
	ON (l_custkey = r_custkey AND r_custkey = 5);
 count | count
---------------------------------------------------------------------
    20 |     1
(1 row)

-- Apply a filter before the join (no matches right)
SELECT
	count(l_custkey), count(r_custkey)
FROM
	multi_outer_join_left_hash a LEFT JOIN multi_outer_join_right_reference b
	ON (l_custkey = r_custkey AND r_custkey = -1 /* nonexistant */);
 count | count
---------------------------------------------------------------------
    20 |     0
(1 row)

-- Apply a filter before the join (no matches left)
SELECT
	count(l_custkey), count(r_custkey)
FROM
	multi_outer_join_left_hash a LEFT JOIN multi_outer_join_right_reference b
	ON (l_custkey = r_custkey AND l_custkey = -1 /* nonexistant */);
 count | count
---------------------------------------------------------------------
    20 |     0
(1 row)

-- Right join is allowed as we recursively plan the distributed table (multi_outer_join_left_hash)
SELECT
	min(r_custkey), max(r_custkey)
FROM
	multi_outer_join_left_hash a RIGHT JOIN multi_outer_join_right_reference b ON (l_custkey = r_custkey);
LOG:  join order: [ "multi_outer_join_left_hash" ]
 min | max
---------------------------------------------------------------------
   1 |  15
(1 row)

-- Reverse right join should be same as left join
SELECT
	min(l_custkey), max(l_custkey)
FROM
	multi_outer_join_right_reference a RIGHT JOIN multi_outer_join_left_hash b ON (l_custkey = r_custkey);
 min | max
---------------------------------------------------------------------
   1 |  20
(1 row)

-- load some more data
\set customer_21_30_data :abs_srcdir '/data/customer-21-30.data'
\set client_side_copy_command '\\copy multi_outer_join_right_reference FROM ' :'customer_21_30_data' ' with delimiter '''|''';'
:client_side_copy_command
-- Update shards so that they do not have 1-1 matching, triggering an error.
UPDATE pg_dist_shard SET shardminvalue = '2147483646' WHERE shardid = 1260006;
UPDATE pg_dist_shard SET shardmaxvalue = '2147483647' WHERE shardid = 1260006;
SELECT
	min(l_custkey), max(l_custkey)
FROM
	multi_outer_join_left_hash a LEFT JOIN multi_outer_join_right_hash b ON (l_custkey = r_custkey);
ERROR:  hash partitioned table has overlapping shards
UPDATE pg_dist_shard SET shardminvalue = '-2147483648' WHERE shardid = 1260006;
UPDATE pg_dist_shard SET shardmaxvalue = '-1073741825' WHERE shardid = 1260006;
-- empty tables
TRUNCATE multi_outer_join_left_hash, multi_outer_join_right_hash, multi_outer_join_right_reference;
-- reload shards with 1-1 matching
\set client_side_copy_command '\\copy multi_outer_join_left_hash FROM ' :'customer_1_15_data' ' with delimiter '''|''';'
:client_side_copy_command
\set client_side_copy_command '\\copy multi_outer_join_left_hash FROM ' :'customer_21_30_data' ' with delimiter '''|''';'
:client_side_copy_command
\set client_side_copy_command '\\copy multi_outer_join_right_reference FROM ' :'customer_11_20_data' ' with delimiter '''|''';'
:client_side_copy_command
\set client_side_copy_command '\\copy multi_outer_join_right_reference FROM ' :'customer_21_30_data' ' with delimiter '''|''';'
:client_side_copy_command
\set client_side_copy_command '\\copy multi_outer_join_right_hash FROM ' :'customer_11_20_data' ' with delimiter '''|''';'
:client_side_copy_command
\set client_side_copy_command '\\copy multi_outer_join_right_hash FROM ' :'customer_21_30_data' ' with delimiter '''|''';'
:client_side_copy_command
-- multi_outer_join_third_reference is a single shard table
-- Regular left join should work as expected
SELECT
	min(l_custkey), max(l_custkey)
FROM
	multi_outer_join_left_hash a LEFT JOIN multi_outer_join_right_hash b ON (l_custkey = r_custkey);
 min | max
---------------------------------------------------------------------
   1 |  30
(1 row)

-- Citus can use broadcast join here
SELECT
	count(*)
FROM
	multi_outer_join_left_hash a LEFT JOIN multi_outer_join_right_hash b ON (l_nationkey = r_nationkey);
LOG:  join order: [ "multi_outer_join_right_hash" ]
 count
---------------------------------------------------------------------
    52
(1 row)

-- Anti-join should return customers for which there is no row in the right table
SELECT
	min(l_custkey), max(l_custkey)
FROM
	multi_outer_join_left_hash a LEFT JOIN multi_outer_join_right_reference b ON (l_custkey = r_custkey)
WHERE
	r_custkey IS NULL;
 min | max
---------------------------------------------------------------------
   1 |  10
(1 row)

-- Partial anti-join with specific value (5, 11-15)
SELECT
	min(l_custkey), max(l_custkey)
FROM
	multi_outer_join_left_hash a LEFT JOIN multi_outer_join_right_reference b ON (l_custkey = r_custkey)
WHERE
	r_custkey IS NULL OR r_custkey = 15;
 min | max
---------------------------------------------------------------------
   1 |  15
(1 row)

-- This query is an INNER JOIN in disguise since there cannot be NULL results (21)
-- Added extra filter to make query not router plannable
SELECT
	min(l_custkey), max(l_custkey)
FROM
	multi_outer_join_left_hash a LEFT JOIN multi_outer_join_right_reference b ON (l_custkey = r_custkey)
WHERE
	r_custkey = 21 or r_custkey < 10;
LOG:  join order: [ "multi_outer_join_left_hash" ][ reference join "multi_outer_join_right_reference" ]
 min | max
---------------------------------------------------------------------
  21 |  21
(1 row)

-- Apply a filter before the join
SELECT
	count(l_custkey), count(r_custkey)
FROM
	multi_outer_join_left_hash a LEFT JOIN multi_outer_join_right_reference b
	ON (l_custkey = r_custkey AND r_custkey = 21);
 count | count
---------------------------------------------------------------------
    25 |     1
(1 row)

-- Right join should be allowed in this case as we recursively plan the distributed table (multi_outer_join_left_hash
SELECT
	min(r_custkey), max(r_custkey)
FROM
	multi_outer_join_left_hash a RIGHT JOIN multi_outer_join_right_reference b ON (l_custkey = r_custkey);
LOG:  join order: [ "multi_outer_join_left_hash" ]
 min | max
---------------------------------------------------------------------
  11 |  30
(1 row)

-- Reverse right join should be same as left join
SELECT
	min(l_custkey), max(l_custkey)
FROM
	multi_outer_join_right_reference a RIGHT JOIN multi_outer_join_left_hash b ON (l_custkey = r_custkey);
 min | max
---------------------------------------------------------------------
   1 |  30
(1 row)

-- complex query tree should error out
SELECT
	*
FROM
	multi_outer_join_left_hash l1
	LEFT JOIN multi_outer_join_right_reference r1 ON (l1.l_custkey = r1.r_custkey)
	LEFT JOIN multi_outer_join_right_reference r2 ON (l1.l_custkey  = r2.r_custkey)
	RIGHT JOIN multi_outer_join_left_hash l2 ON (r2.r_custkey = l2.l_custkey);
LOG:  join order: [ "multi_outer_join_left_hash" ]
LOG:  join order: [ "multi_outer_join_left_hash" ]
 l_custkey |       l_name       |                l_address                | l_nationkey |     l_phone     | l_acctbal | l_mktsegment |                                                  l_comment                                                   | r_custkey |       r_name       |                r_address                | r_nationkey |     r_phone     | r_acctbal | r_mktsegment |                                                  r_comment                                                   | r_custkey |       r_name       |                r_address                | r_nationkey |     r_phone     | r_acctbal | r_mktsegment |                                                  r_comment                                                   | l_custkey |       l_name       |                l_address                | l_nationkey |     l_phone     | l_acctbal | l_mktsegment |                                                     l_comment
---------------------------------------------------------------------
        11 | Customer#000000011 | PkWS 3HlXqwTuzrKg633BEi                 |          23 | 33-464-151-3439 |   -272.60 | BUILDING     | ckages. requests sleep slyly. quickly even pinto beans promise above the slyly regular pinto beans.          |        11 | Customer#000000011 | PkWS 3HlXqwTuzrKg633BEi                 |          23 | 33-464-151-3439 |   -272.60 | BUILDING     | ckages. requests sleep slyly. quickly even pinto beans promise above the slyly regular pinto beans.          |        11 | Customer#000000011 | PkWS 3HlXqwTuzrKg633BEi                 |          23 | 33-464-151-3439 |   -272.60 | BUILDING     | ckages. requests sleep slyly. quickly even pinto beans promise above the slyly regular pinto beans.          |        11 | Customer#000000011 | PkWS 3HlXqwTuzrKg633BEi                 |          23 | 33-464-151-3439 |   -272.60 | BUILDING     | ckages. requests sleep slyly. quickly even pinto beans promise above the slyly regular pinto beans.
        12 | Customer#000000012 | 9PWKuhzT4Zr1Q                           |          13 | 23-791-276-1263 |   3396.49 | HOUSEHOLD    |  to the carefully final braids. blithely regular requests nag. ironic theodolites boost quickly along        |        12 | Customer#000000012 | 9PWKuhzT4Zr1Q                           |          13 | 23-791-276-1263 |   3396.49 | HOUSEHOLD    |  to the carefully final braids. blithely regular requests nag. ironic theodolites boost quickly along        |        12 | Customer#000000012 | 9PWKuhzT4Zr1Q                           |          13 | 23-791-276-1263 |   3396.49 | HOUSEHOLD    |  to the carefully final braids. blithely regular requests nag. ironic theodolites boost quickly along        |        12 | Customer#000000012 | 9PWKuhzT4Zr1Q                           |          13 | 23-791-276-1263 |   3396.49 | HOUSEHOLD    |  to the carefully final braids. blithely regular requests nag. ironic theodolites boost quickly along
        13 | Customer#000000013 | nsXQu0oVjD7PM659uC3SRSp                 |           3 | 13-761-547-5974 |   3857.34 | BUILDING     | ounts sleep carefully after the close frays. carefully bold notornis use ironic requests. blithely           |        13 | Customer#000000013 | nsXQu0oVjD7PM659uC3SRSp                 |           3 | 13-761-547-5974 |   3857.34 | BUILDING     | ounts sleep carefully after the close frays. carefully bold notornis use ironic requests. blithely           |        13 | Customer#000000013 | nsXQu0oVjD7PM659uC3SRSp                 |           3 | 13-761-547-5974 |   3857.34 | BUILDING     | ounts sleep carefully after the close frays. carefully bold notornis use ironic requests. blithely           |        13 | Customer#000000013 | nsXQu0oVjD7PM659uC3SRSp                 |           3 | 13-761-547-5974 |   3857.34 | BUILDING     | ounts sleep carefully after the close frays. carefully bold notornis use ironic requests. blithely
        14 | Customer#000000014 | KXkletMlL2JQEA                          |           1 | 11-845-129-3851 |   5266.30 | FURNITURE    | , ironic packages across the unus                                                                            |        14 | Customer#000000014 | KXkletMlL2JQEA                          |           1 | 11-845-129-3851 |   5266.30 | FURNITURE    | , ironic packages across the unus                                                                            |        14 | Customer#000000014 | KXkletMlL2JQEA                          |           1 | 11-845-129-3851 |   5266.30 | FURNITURE    | , ironic packages across the unus                                                                            |        14 | Customer#000000014 | KXkletMlL2JQEA                          |           1 | 11-845-129-3851 |   5266.30 | FURNITURE    | , ironic packages across the unus
        15 | Customer#000000015 | YtWggXoOLdwdo7b0y,BZaGUQMLJMX1Y,EC,6Dn  |          23 | 33-687-542-7601 |   2788.52 | HOUSEHOLD    |  platelets. regular deposits detect asymptotes. blithely unusual packages nag slyly at the fluf              |        15 | Customer#000000015 | YtWggXoOLdwdo7b0y,BZaGUQMLJMX1Y,EC,6Dn  |          23 | 33-687-542-7601 |   2788.52 | HOUSEHOLD    |  platelets. regular deposits detect asymptotes. blithely unusual packages nag slyly at the fluf              |        15 | Customer#000000015 | YtWggXoOLdwdo7b0y,BZaGUQMLJMX1Y,EC,6Dn  |          23 | 33-687-542-7601 |   2788.52 | HOUSEHOLD    |  platelets. regular deposits detect asymptotes. blithely unusual packages nag slyly at the fluf              |        15 | Customer#000000015 | YtWggXoOLdwdo7b0y,BZaGUQMLJMX1Y,EC,6Dn  |          23 | 33-687-542-7601 |   2788.52 | HOUSEHOLD    |  platelets. regular deposits detect asymptotes. blithely unusual packages nag slyly at the fluf
        21 | Customer#000000021 | XYmVpr9yAHDEn                           |           8 | 18-902-614-8344 |   1428.25 | MACHINERY    |  quickly final accounts integrate blithely furiously u                                                       |        21 | Customer#000000021 | XYmVpr9yAHDEn                           |           8 | 18-902-614-8344 |   1428.25 | MACHINERY    |  quickly final accounts integrate blithely furiously u                                                       |        21 | Customer#000000021 | XYmVpr9yAHDEn                           |           8 | 18-902-614-8344 |   1428.25 | MACHINERY    |  quickly final accounts integrate blithely furiously u                                                       |        21 | Customer#000000021 | XYmVpr9yAHDEn                           |           8 | 18-902-614-8344 |   1428.25 | MACHINERY    |  quickly final accounts integrate blithely furiously u
        22 | Customer#000000022 | QI6p41,FNs5k7RZoCCVPUTkUdYpB            |           3 | 13-806-545-9701 |    591.98 | MACHINERY    | s nod furiously above the furiously ironic ideas.                                                            |        22 | Customer#000000022 | QI6p41,FNs5k7RZoCCVPUTkUdYpB            |           3 | 13-806-545-9701 |    591.98 | MACHINERY    | s nod furiously above the furiously ironic ideas.                                                            |        22 | Customer#000000022 | QI6p41,FNs5k7RZoCCVPUTkUdYpB            |           3 | 13-806-545-9701 |    591.98 | MACHINERY    | s nod furiously above the furiously ironic ideas.                                                            |        22 | Customer#000000022 | QI6p41,FNs5k7RZoCCVPUTkUdYpB            |           3 | 13-806-545-9701 |    591.98 | MACHINERY    | s nod furiously above the furiously ironic ideas.
        23 | Customer#000000023 | OdY W13N7Be3OC5MpgfmcYss0Wn6TKT         |           3 | 13-312-472-8245 |   3332.02 | HOUSEHOLD    | deposits. special deposits cajole slyly. fluffily special deposits about the furiously                       |        23 | Customer#000000023 | OdY W13N7Be3OC5MpgfmcYss0Wn6TKT         |           3 | 13-312-472-8245 |   3332.02 | HOUSEHOLD    | deposits. special deposits cajole slyly. fluffily special deposits about the furiously                       |        23 | Customer#000000023 | OdY W13N7Be3OC5MpgfmcYss0Wn6TKT         |           3 | 13-312-472-8245 |   3332.02 | HOUSEHOLD    | deposits. special deposits cajole slyly. fluffily special deposits about the furiously                       |        23 | Customer#000000023 | OdY W13N7Be3OC5MpgfmcYss0Wn6TKT         |           3 | 13-312-472-8245 |   3332.02 | HOUSEHOLD    | deposits. special deposits cajole slyly. fluffily special deposits about the furiously
        24 | Customer#000000024 | HXAFgIAyjxtdqwimt13Y3OZO 4xeLe7U8PqG    |          13 | 23-127-851-8031 |   9255.67 | MACHINERY    | into beans. fluffily final ideas haggle fluffily                                                             |        24 | Customer#000000024 | HXAFgIAyjxtdqwimt13Y3OZO 4xeLe7U8PqG    |          13 | 23-127-851-8031 |   9255.67 | MACHINERY    | into beans. fluffily final ideas haggle fluffily                                                             |        24 | Customer#000000024 | HXAFgIAyjxtdqwimt13Y3OZO 4xeLe7U8PqG    |          13 | 23-127-851-8031 |   9255.67 | MACHINERY    | into beans. fluffily final ideas haggle fluffily                                                             |        24 | Customer#000000024 | HXAFgIAyjxtdqwimt13Y3OZO 4xeLe7U8PqG    |          13 | 23-127-851-8031 |   9255.67 | MACHINERY    | into beans. fluffily final ideas haggle fluffily
        25 | Customer#000000025 | Hp8GyFQgGHFYSilH5tBfe                   |          12 | 22-603-468-3533 |   7133.70 | FURNITURE    | y. accounts sleep ruthlessly according to the regular theodolites. unusual instructions sleep. ironic, final |        25 | Customer#000000025 | Hp8GyFQgGHFYSilH5tBfe                   |          12 | 22-603-468-3533 |   7133.70 | FURNITURE    | y. accounts sleep ruthlessly according to the regular theodolites. unusual instructions sleep. ironic, final |        25 | Customer#000000025 | Hp8GyFQgGHFYSilH5tBfe                   |          12 | 22-603-468-3533 |   7133.70 | FURNITURE    | y. accounts sleep ruthlessly according to the regular theodolites. unusual instructions sleep. ironic, final |        25 | Customer#000000025 | Hp8GyFQgGHFYSilH5tBfe                   |          12 | 22-603-468-3533 |   7133.70 | FURNITURE    | y. accounts sleep ruthlessly according to the regular theodolites. unusual instructions sleep. ironic, final
        26 | Customer#000000026 | 8ljrc5ZeMl7UciP                         |          22 | 32-363-455-4837 |   5182.05 | AUTOMOBILE   | c requests use furiously ironic requests. slyly ironic dependencies us                                       |        26 | Customer#000000026 | 8ljrc5ZeMl7UciP                         |          22 | 32-363-455-4837 |   5182.05 | AUTOMOBILE   | c requests use furiously ironic requests. slyly ironic dependencies us                                       |        26 | Customer#000000026 | 8ljrc5ZeMl7UciP                         |          22 | 32-363-455-4837 |   5182.05 | AUTOMOBILE   | c requests use furiously ironic requests. slyly ironic dependencies us                                       |        26 | Customer#000000026 | 8ljrc5ZeMl7UciP                         |          22 | 32-363-455-4837 |   5182.05 | AUTOMOBILE   | c requests use furiously ironic requests. slyly ironic dependencies us
        27 | Customer#000000027 | IS8GIyxpBrLpMT0u7                       |           3 | 13-137-193-2709 |   5679.84 | BUILDING     |  about the carefully ironic pinto beans. accoun                                                              |        27 | Customer#000000027 | IS8GIyxpBrLpMT0u7                       |           3 | 13-137-193-2709 |   5679.84 | BUILDING     |  about the carefully ironic pinto beans. accoun                                                              |        27 | Customer#000000027 | IS8GIyxpBrLpMT0u7                       |           3 | 13-137-193-2709 |   5679.84 | BUILDING     |  about the carefully ironic pinto beans. accoun                                                              |        27 | Customer#000000027 | IS8GIyxpBrLpMT0u7                       |           3 | 13-137-193-2709 |   5679.84 | BUILDING     |  about the carefully ironic pinto beans. accoun
        28 | Customer#000000028 | iVyg0daQ,Tha8x2WPWA9m2529m              |           8 | 18-774-241-1462 |   1007.18 | FURNITURE    |  along the regular deposits. furiously final pac                                                             |        28 | Customer#000000028 | iVyg0daQ,Tha8x2WPWA9m2529m              |           8 | 18-774-241-1462 |   1007.18 | FURNITURE    |  along the regular deposits. furiously final pac                                                             |        28 | Customer#000000028 | iVyg0daQ,Tha8x2WPWA9m2529m              |           8 | 18-774-241-1462 |   1007.18 | FURNITURE    |  along the regular deposits. furiously final pac                                                             |        28 | Customer#000000028 | iVyg0daQ,Tha8x2WPWA9m2529m              |           8 | 18-774-241-1462 |   1007.18 | FURNITURE    |  along the regular deposits. furiously final pac
        29 | Customer#000000029 | sJ5adtfyAkCK63df2,vF25zyQMVYE34uh       |           0 | 10-773-203-7342 |   7618.27 | FURNITURE    | its after the carefully final platelets x-ray against                                                        |        29 | Customer#000000029 | sJ5adtfyAkCK63df2,vF25zyQMVYE34uh       |           0 | 10-773-203-7342 |   7618.27 | FURNITURE    | its after the carefully final platelets x-ray against                                                        |        29 | Customer#000000029 | sJ5adtfyAkCK63df2,vF25zyQMVYE34uh       |           0 | 10-773-203-7342 |   7618.27 | FURNITURE    | its after the carefully final platelets x-ray against                                                        |        29 | Customer#000000029 | sJ5adtfyAkCK63df2,vF25zyQMVYE34uh       |           0 | 10-773-203-7342 |   7618.27 | FURNITURE    | its after the carefully final platelets x-ray against
        30 | Customer#000000030 | nJDsELGAavU63Jl0c5NKsKfL8rIJQQkQnYL2QJY |           1 | 11-764-165-5076 |   9321.01 | BUILDING     | lithely final requests. furiously unusual account                                                            |        30 | Customer#000000030 | nJDsELGAavU63Jl0c5NKsKfL8rIJQQkQnYL2QJY |           1 | 11-764-165-5076 |   9321.01 | BUILDING     | lithely final requests. furiously unusual account                                                            |        30 | Customer#000000030 | nJDsELGAavU63Jl0c5NKsKfL8rIJQQkQnYL2QJY |           1 | 11-764-165-5076 |   9321.01 | BUILDING     | lithely final requests. furiously unusual account                                                            |        30 | Customer#000000030 | nJDsELGAavU63Jl0c5NKsKfL8rIJQQkQnYL2QJY |           1 | 11-764-165-5076 |   9321.01 | BUILDING     | lithely final requests. furiously unusual account
           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |        10 | Customer#000000010 | 6LrEaV6KR6PLVcgl2ArL Q3rqzLzcT1 v2      |           5 | 15-741-346-9870 |   2753.54 | HOUSEHOLD    | es regular deposits haggle. fur
           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |         2 | Customer#000000002 | XSTf4,NCwDVaWNe6tEgvwfmRchLXak          |          13 | 23-768-687-3665 |    121.65 | AUTOMOBILE   | l accounts. blithely ironic theodolites integrate boldly: caref
           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |         5 | Customer#000000005 | KvpyuHCplrB84WgAiGV6sYpZq7Tj            |           3 | 13-750-942-6364 |    794.47 | HOUSEHOLD    | n accounts will have to unwind. foxes cajole accor
           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |         8 | Customer#000000008 | I0B10bB0AymmC, 0PrRYBCP1yGJ8xcBPmWhl5   |          17 | 27-147-574-9335 |   6819.74 | BUILDING     | among the slyly regular theodolites kindle blithely courts. carefully even theodolites haggle slyly along the ide
           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |         6 | Customer#000000006 | sKZz0CsnMD7mp4Xd0YrBvx,LREYKUWAh yVn    |          20 | 30-114-968-4951 |   7638.57 | AUTOMOBILE   | tions. even deposits boost according to the slyly bold packages. final accounts cajole requests. furious
           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |         4 | Customer#000000004 | XxVSJsLAGtn                             |           4 | 14-128-190-5944 |   2866.83 | MACHINERY    |  requests. final, regular ideas sleep final accou
           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |         1 | Customer#000000001 | IVhzIApeRb ot,c,E                       |          15 | 25-989-741-2988 |    711.56 | BUILDING     | to the even, regular platelets. regular, ironic epitaphs nag e
           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |         3 | Customer#000000003 | MG9kdTD2WBHm                            |           1 | 11-719-748-3364 |   7498.12 | AUTOMOBILE   |  deposits eat slyly ironic, even instructions. express foxes detect slyly. blithely even accounts abov
           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |         9 | Customer#000000009 | xKiAFTjUsCuxfeleNqefumTrjS              |           8 | 18-338-906-3675 |   8324.07 | FURNITURE    | r theodolites according to the requests wake thinly excuses: pending requests haggle furiousl
           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |           |                    |                                         |             |                 |           |              |                                                                                                              |         7 | Customer#000000007 | TcGe5gaZNgVePxU5kRrvXBfkasDTea          |          18 | 28-190-982-9759 |   9561.95 | AUTOMOBILE   | ainst the ironic, express theodolites. express, even pinto beans among the exp
(25 rows)

-- add an anti-join, this should also error out
SELECT
	*
FROM
	multi_outer_join_left_hash l1
	LEFT JOIN multi_outer_join_right_reference r1 ON (l1.l_custkey = r1.r_custkey)
	LEFT JOIN multi_outer_join_right_reference r2 ON (l1.l_custkey  = r2.r_custkey)
	RIGHT JOIN multi_outer_join_left_hash l2 ON (r2.r_custkey = l2.l_custkey)
WHERE
	r1.r_custkey is NULL;
LOG:  join order: [ "multi_outer_join_left_hash" ]
LOG:  join order: [ "multi_outer_join_left_hash" ]
 l_custkey | l_name | l_address | l_nationkey | l_phone | l_acctbal | l_mktsegment | l_comment | r_custkey | r_name | r_address | r_nationkey | r_phone | r_acctbal | r_mktsegment | r_comment | r_custkey | r_name | r_address | r_nationkey | r_phone | r_acctbal | r_mktsegment | r_comment | l_custkey |       l_name       |               l_address               | l_nationkey |     l_phone     | l_acctbal | l_mktsegment |                                                     l_comment
---------------------------------------------------------------------
           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |        10 | Customer#000000010 | 6LrEaV6KR6PLVcgl2ArL Q3rqzLzcT1 v2    |           5 | 15-741-346-9870 |   2753.54 | HOUSEHOLD    | es regular deposits haggle. fur
           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |         2 | Customer#000000002 | XSTf4,NCwDVaWNe6tEgvwfmRchLXak        |          13 | 23-768-687-3665 |    121.65 | AUTOMOBILE   | l accounts. blithely ironic theodolites integrate boldly: caref
           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |         5 | Customer#000000005 | KvpyuHCplrB84WgAiGV6sYpZq7Tj          |           3 | 13-750-942-6364 |    794.47 | HOUSEHOLD    | n accounts will have to unwind. foxes cajole accor
           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |         8 | Customer#000000008 | I0B10bB0AymmC, 0PrRYBCP1yGJ8xcBPmWhl5 |          17 | 27-147-574-9335 |   6819.74 | BUILDING     | among the slyly regular theodolites kindle blithely courts. carefully even theodolites haggle slyly along the ide
           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |         6 | Customer#000000006 | sKZz0CsnMD7mp4Xd0YrBvx,LREYKUWAh yVn  |          20 | 30-114-968-4951 |   7638.57 | AUTOMOBILE   | tions. even deposits boost according to the slyly bold packages. final accounts cajole requests. furious
           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |         4 | Customer#000000004 | XxVSJsLAGtn                           |           4 | 14-128-190-5944 |   2866.83 | MACHINERY    |  requests. final, regular ideas sleep final accou
           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |         1 | Customer#000000001 | IVhzIApeRb ot,c,E                     |          15 | 25-989-741-2988 |    711.56 | BUILDING     | to the even, regular platelets. regular, ironic epitaphs nag e
           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |         3 | Customer#000000003 | MG9kdTD2WBHm                          |           1 | 11-719-748-3364 |   7498.12 | AUTOMOBILE   |  deposits eat slyly ironic, even instructions. express foxes detect slyly. blithely even accounts abov
           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |         9 | Customer#000000009 | xKiAFTjUsCuxfeleNqefumTrjS            |           8 | 18-338-906-3675 |   8324.07 | FURNITURE    | r theodolites according to the requests wake thinly excuses: pending requests haggle furiousl
           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |           |        |           |             |         |           |              |           |         7 | Customer#000000007 | TcGe5gaZNgVePxU5kRrvXBfkasDTea        |          18 | 28-190-982-9759 |   9561.95 | AUTOMOBILE   | ainst the ironic, express theodolites. express, even pinto beans among the exp
(10 rows)

-- Three way join 2-1-1 (broadcast + broadcast join) should work
SELECT
	l_custkey, r_custkey, t_custkey
FROM
	multi_outer_join_left_hash l1
	LEFT JOIN multi_outer_join_right_reference r1 ON (l1.l_custkey = r1.r_custkey)
	LEFT JOIN multi_outer_join_third_reference t1 ON (r1.r_custkey  = t1.t_custkey)
ORDER BY 1;
 l_custkey | r_custkey | t_custkey
---------------------------------------------------------------------
         1 |           |
         2 |           |
         3 |           |
         4 |           |
         5 |           |
         6 |           |
         7 |           |
         8 |           |
         9 |           |
        10 |           |
        11 |        11 |        11
        12 |        12 |        12
        13 |        13 |        13
        14 |        14 |        14
        15 |        15 |        15
        21 |        21 |        21
        22 |        22 |        22
        23 |        23 |        23
        24 |        24 |        24
        25 |        25 |        25
        26 |        26 |        26
        27 |        27 |        27
        28 |        28 |        28
        29 |        29 |        29
        30 |        30 |        30
(25 rows)

-- Right join with single shard right most table should work
SELECT
	l_custkey, r_custkey, t_custkey
FROM
	multi_outer_join_left_hash l1
	LEFT JOIN multi_outer_join_right_hash r1 ON (l1.l_custkey = r1.r_custkey)
	RIGHT JOIN multi_outer_join_third_reference t1 ON (r1.r_custkey  = t1.t_custkey)
ORDER BY 1,2,3;
LOG:  join order: [ "multi_outer_join_left_hash" ]
LOG:  join order: [ "multi_outer_join_right_hash" ]
 l_custkey | r_custkey | t_custkey
---------------------------------------------------------------------
        11 |        11 |        11
        12 |        12 |        12
        13 |        13 |        13
        14 |        14 |        14
        15 |        15 |        15
        21 |        21 |        21
        22 |        22 |        22
        23 |        23 |        23
        24 |        24 |        24
        25 |        25 |        25
        26 |        26 |        26
        27 |        27 |        27
        28 |        28 |        28
        29 |        29 |        29
        30 |        30 |        30
           |           |         1
           |           |         2
           |           |         3
           |           |         4
           |           |         5
           |           |         6
           |           |         7
           |           |         8
           |           |         9
           |           |        10
           |           |        16
           |           |        17
           |           |        18
           |           |        19
           |           |        20
(30 rows)

-- Right join with single shard left most table should work
SELECT
	t_custkey, r_custkey, l_custkey
FROM
	multi_outer_join_third_reference t1
	RIGHT JOIN multi_outer_join_right_hash r1 ON (t1.t_custkey = r1.r_custkey)
	LEFT JOIN multi_outer_join_left_hash l1 ON (r1.r_custkey  = l1.l_custkey)
ORDER BY 1,2,3;
 t_custkey | r_custkey | l_custkey
---------------------------------------------------------------------
        11 |        11 |        11
        12 |        12 |        12
        13 |        13 |        13
        14 |        14 |        14
        15 |        15 |        15
        16 |        16 |
        17 |        17 |
        18 |        18 |
        19 |        19 |
        20 |        20 |
        21 |        21 |        21
        22 |        22 |        22
        23 |        23 |        23
        24 |        24 |        24
        25 |        25 |        25
        26 |        26 |        26
        27 |        27 |        27
        28 |        28 |        28
        29 |        29 |        29
        30 |        30 |        30
(20 rows)

-- Make it anti-join, should display values with l_custkey is null
SELECT
	t_custkey, r_custkey, l_custkey
FROM
	multi_outer_join_third_reference t1
	RIGHT JOIN multi_outer_join_right_hash r1 ON (t1.t_custkey = r1.r_custkey)
	LEFT JOIN multi_outer_join_left_hash l1 ON (r1.r_custkey  = l1.l_custkey)
WHERE
	l_custkey is NULL
ORDER BY 1;
 t_custkey | r_custkey | l_custkey
---------------------------------------------------------------------
        16 |        16 |
        17 |        17 |
        18 |        18 |
        19 |        19 |
        20 |        20 |
(5 rows)

-- Cascading right join with single shard left most table should work
SELECT
	t_custkey, r_custkey, l_custkey
FROM
	multi_outer_join_third_reference t1
	RIGHT JOIN multi_outer_join_right_hash r1 ON (t1.t_custkey = r1.r_custkey)
	RIGHT JOIN multi_outer_join_left_hash l1 ON (r1.r_custkey  = l1.l_custkey)
ORDER BY l_custkey;
 t_custkey | r_custkey | l_custkey
---------------------------------------------------------------------
           |           |         1
           |           |         2
           |           |         3
           |           |         4
           |           |         5
           |           |         6
           |           |         7
           |           |         8
           |           |         9
           |           |        10
        11 |        11 |        11
        12 |        12 |        12
        13 |        13 |        13
        14 |        14 |        14
        15 |        15 |        15
        21 |        21 |        21
        22 |        22 |        22
        23 |        23 |        23
        24 |        24 |        24
        25 |        25 |        25
        26 |        26 |        26
        27 |        27 |        27
        28 |        28 |        28
        29 |        29 |        29
        30 |        30 |        30
(25 rows)

-- full outer join should work with 1-1 matched shards
SELECT
	l_custkey, r_custkey
FROM
	multi_outer_join_left_hash l1
	FULL JOIN multi_outer_join_right_hash r1 ON (l1.l_custkey = r1.r_custkey)
ORDER BY 1,2;
 l_custkey | r_custkey
---------------------------------------------------------------------
         1 |
         2 |
         3 |
         4 |
         5 |
         6 |
         7 |
         8 |
         9 |
        10 |
        11 |        11
        12 |        12
        13 |        13
        14 |        14
        15 |        15
        21 |        21
        22 |        22
        23 |        23
        24 |        24
        25 |        25
        26 |        26
        27 |        27
        28 |        28
        29 |        29
        30 |        30
           |        16
           |        17
           |        18
           |        19
           |        20
(30 rows)

-- full outer join + anti (right) should work with 1-1 matched shards
SELECT
	l_custkey, r_custkey
FROM
	multi_outer_join_left_hash l1
	FULL JOIN multi_outer_join_right_hash r1 ON (l1.l_custkey = r1.r_custkey)
WHERE
	r_custkey is NULL
ORDER BY 1;
 l_custkey | r_custkey
---------------------------------------------------------------------
         1 |
         2 |
         3 |
         4 |
         5 |
         6 |
         7 |
         8 |
         9 |
        10 |
(10 rows)

-- full outer join + anti (left) should work with 1-1 matched shards
SELECT
	l_custkey, r_custkey
FROM
	multi_outer_join_left_hash l1
	FULL JOIN multi_outer_join_right_hash r1 ON (l1.l_custkey = r1.r_custkey)
WHERE
	l_custkey is NULL
ORDER BY 2;
 l_custkey | r_custkey
---------------------------------------------------------------------
           |        16
           |        17
           |        18
           |        19
           |        20
(5 rows)

-- full outer join + anti (both) should work with 1-1 matched shards
SELECT
	l_custkey, r_custkey
FROM
	multi_outer_join_left_hash l1
	FULL JOIN multi_outer_join_right_hash r1 ON (l1.l_custkey = r1.r_custkey)
WHERE
	l_custkey is NULL or r_custkey is NULL
ORDER BY 1,2 DESC;
 l_custkey | r_custkey
---------------------------------------------------------------------
         1 |
         2 |
         3 |
         4 |
         5 |
         6 |
         7 |
         8 |
         9 |
        10 |
           |        20
           |        19
           |        18
           |        17
           |        16
(15 rows)

-- full outer join should work as we recursively plan the distributed table (multi_outer_join_left_hash
SELECT
	l_custkey, t_custkey
FROM
	multi_outer_join_left_hash l1
	FULL JOIN multi_outer_join_third_reference t1 ON (l1.l_custkey = t1.t_custkey)
ORDER BY 1,2;
LOG:  join order: [ "multi_outer_join_left_hash" ]
 l_custkey | t_custkey
---------------------------------------------------------------------
         1 |         1
         2 |         2
         3 |         3
         4 |         4
         5 |         5
         6 |         6
         7 |         7
         8 |         8
         9 |         9
        10 |        10
        11 |        11
        12 |        12
        13 |        13
        14 |        14
        15 |        15
        21 |        21
        22 |        22
        23 |        23
        24 |        24
        25 |        25
        26 |        26
        27 |        27
        28 |        28
        29 |        29
        30 |        30
           |        16
           |        17
           |        18
           |        19
           |        20
(30 rows)

-- inner join  + single shard left join should work
SELECT
	l_custkey, r_custkey, t_custkey
FROM
	multi_outer_join_left_hash l1
	INNER JOIN multi_outer_join_right_hash r1 ON (l1.l_custkey = r1.r_custkey)
	LEFT JOIN multi_outer_join_third_reference t1 ON (r1.r_custkey  = t1.t_custkey)
ORDER BY 1;
 l_custkey | r_custkey | t_custkey
---------------------------------------------------------------------
        11 |        11 |        11
        12 |        12 |        12
        13 |        13 |        13
        14 |        14 |        14
        15 |        15 |        15
        21 |        21 |        21
        22 |        22 |        22
        23 |        23 |        23
        24 |        24 |        24
        25 |        25 |        25
        26 |        26 |        26
        27 |        27 |        27
        28 |        28 |        28
        29 |        29 |        29
        30 |        30 |        30
(15 rows)

-- inner (broadcast) join  + 2 shards left (local) join should work
SELECT
	l_custkey, t_custkey, r_custkey
FROM
	multi_outer_join_left_hash l1
	INNER JOIN multi_outer_join_third_reference t1 ON (l1.l_custkey = t1.t_custkey)
	LEFT JOIN multi_outer_join_right_hash r1 ON (l1.l_custkey  = r1.r_custkey)
ORDER BY 1,2,3;
 l_custkey | t_custkey | r_custkey
---------------------------------------------------------------------
         1 |         1 |
         2 |         2 |
         3 |         3 |
         4 |         4 |
         5 |         5 |
         6 |         6 |
         7 |         7 |
         8 |         8 |
         9 |         9 |
        10 |        10 |
        11 |        11 |        11
        12 |        12 |        12
        13 |        13 |        13
        14 |        14 |        14
        15 |        15 |        15
        21 |        21 |        21
        22 |        22 |        22
        23 |        23 |        23
        24 |        24 |        24
        25 |        25 |        25
        26 |        26 |        26
        27 |        27 |        27
        28 |        28 |        28
        29 |        29 |        29
        30 |        30 |        30
(25 rows)

-- inner (local) join  + 2 shards left (dual partition) join
SELECT
	t_custkey, l_custkey, r_custkey
FROM
	multi_outer_join_third_reference t1
	INNER JOIN multi_outer_join_left_hash l1 ON (l1.l_custkey = t1.t_custkey)
	LEFT JOIN multi_outer_join_right_reference r1 ON (l1.l_custkey  = r1.r_custkey)
ORDER BY 1,2,3;
 t_custkey | l_custkey | r_custkey
---------------------------------------------------------------------
         1 |         1 |
         2 |         2 |
         3 |         3 |
         4 |         4 |
         5 |         5 |
         6 |         6 |
         7 |         7 |
         8 |         8 |
         9 |         9 |
        10 |        10 |
        11 |        11 |        11
        12 |        12 |        12
        13 |        13 |        13
        14 |        14 |        14
        15 |        15 |        15
        21 |        21 |        21
        22 |        22 |        22
        23 |        23 |        23
        24 |        24 |        24
        25 |        25 |        25
        26 |        26 |        26
        27 |        27 |        27
        28 |        28 |        28
        29 |        29 |        29
        30 |        30 |        30
(25 rows)

-- inner (local) join  + 2 shards left (dual partition) join should work
SELECT
	l_custkey, t_custkey, r_custkey
FROM
	multi_outer_join_left_hash l1
	INNER JOIN multi_outer_join_third_reference t1 ON (l1.l_custkey = t1.t_custkey)
	LEFT JOIN multi_outer_join_right_hash r1 ON (l1.l_custkey  = r1.r_custkey)
ORDER BY 1,2,3;
 l_custkey | t_custkey | r_custkey
---------------------------------------------------------------------
         1 |         1 |
         2 |         2 |
         3 |         3 |
         4 |         4 |
         5 |         5 |
         6 |         6 |
         7 |         7 |
         8 |         8 |
         9 |         9 |
        10 |        10 |
        11 |        11 |        11
        12 |        12 |        12
        13 |        13 |        13
        14 |        14 |        14
        15 |        15 |        15
        21 |        21 |        21
        22 |        22 |        22
        23 |        23 |        23
        24 |        24 |        24
        25 |        25 |        25
        26 |        26 |        26
        27 |        27 |        27
        28 |        28 |        28
        29 |        29 |        29
        30 |        30 |        30
(25 rows)

-- inner (broadcast) join  + 2 shards left (local) + anti join should work
SELECT
	l_custkey, t_custkey, r_custkey
FROM
	multi_outer_join_left_hash l1
	INNER JOIN multi_outer_join_third_reference t1 ON (l1.l_custkey = t1.t_custkey)
	LEFT JOIN multi_outer_join_right_hash r1 ON (l1.l_custkey  = r1.r_custkey)
WHERE
	r_custkey is NULL
ORDER BY 1;
 l_custkey | t_custkey | r_custkey
---------------------------------------------------------------------
         1 |         1 |
         2 |         2 |
         3 |         3 |
         4 |         4 |
         5 |         5 |
         6 |         6 |
         7 |         7 |
         8 |         8 |
         9 |         9 |
        10 |        10 |
(10 rows)

-- Test joinExpr aliases by performing an outer-join.
SELECT
	t_custkey
FROM
	(multi_outer_join_right_hash r1
	LEFT OUTER JOIN multi_outer_join_left_hash l1 ON (l1.l_custkey = r1.r_custkey)) AS
    test(c_custkey, c_nationkey)
    INNER JOIN multi_outer_join_third_reference t1 ON (test.c_custkey = t1.t_custkey)
ORDER BY 1;
 t_custkey
---------------------------------------------------------------------
        11
        12
        13
        14
        15
        16
        17
        18
        19
        20
        21
        22
        23
        24
        25
        26
        27
        28
        29
        30
(20 rows)

-- flattened out subqueries with outer joins are not supported
SELECT
  l1.l_custkey,
  count(*) as cnt
FROM (
  SELECT l_custkey, l_nationkey
  FROM multi_outer_join_left_hash
  WHERE l_comment like '%a%'
) l1
LEFT JOIN (
  SELECT r_custkey, r_name
  FROM multi_outer_join_right_reference
  WHERE r_comment like '%b%'
) l2 ON l1.l_custkey = l2.r_custkey
GROUP BY l1.l_custkey
ORDER BY cnt DESC, l1.l_custkey DESC
LIMIT 20;
 l_custkey | cnt
---------------------------------------------------------------------
        30 |   1
        29 |   1
        28 |   1
        27 |   1
        25 |   1
        24 |   1
        23 |   1
        22 |   1
        21 |   1
        15 |   1
        14 |   1
        13 |   1
        12 |   1
        11 |   1
        10 |   1
         9 |   1
         8 |   1
         7 |   1
         6 |   1
         5 |   1
(20 rows)

-- full join among reference tables should go thourgh router planner
SELECT
	t_custkey, r_custkey
FROM
	multi_outer_join_right_reference FULL JOIN
	multi_outer_join_third_reference ON (t_custkey = r_custkey)
ORDER BY 1;
 t_custkey | r_custkey
---------------------------------------------------------------------
         1 |
         2 |
         3 |
         4 |
         5 |
         6 |
         7 |
         8 |
         9 |
        10 |
        11 |        11
        12 |        12
        13 |        13
        14 |        14
        15 |        15
        16 |        16
        17 |        17
        18 |        18
        19 |        19
        20 |        20
        21 |        21
        22 |        22
        23 |        23
        24 |        24
        25 |        25
        26 |        26
        27 |        27
        28 |        28
        29 |        29
        30 |        30
(30 rows)

-- complex join order with multiple children on the right
SELECT
     count(*)
FROM
    multi_outer_join_left_hash l1
LEFT JOIN (
    multi_outer_join_right_reference r1
    INNER JOIN
    multi_outer_join_third_reference r2
    ON (r_name = t_name)
) AS bar
ON (l_name = r_name);
 count
---------------------------------------------------------------------
    25
(1 row)

-- DROP unused tables to clean up workspace
DROP TABLE multi_outer_join_left_hash;
DROP TABLE multi_outer_join_right_reference;
DROP TABLE multi_outer_join_third_reference;
DROP TABLE multi_outer_join_right_hash;
