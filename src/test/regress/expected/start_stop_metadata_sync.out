CREATE SCHEMA start_stop_metadata_sync;
SET search_path TO "start_stop_metadata_sync";
SET citus.next_shard_id TO 980000;
SET client_min_messages TO WARNING;
SET citus.shard_count TO 4;
SET citus.shard_replication_factor TO 1;
-- create a custom type for testing with a distributed table
CREATE TYPE tt2 AS ENUM ('a', 'b');
-- create test tables
CREATE TABLE distributed_table_1(col int unique, b tt2);
CREATE TABLE "distributed_table_2'! ?._"(col int unique);
CREATE TABLE distributed_table_3(col int);
CREATE TABLE distributed_table_4(a int UNIQUE NOT NULL, b int, c int);
CREATE TABLE reference_table_1(col int unique);
CREATE TABLE reference_table_2(col int unique);
CREATE TABLE local_table(col int unique);
-- create a fkey graph: dist -> dist -> ref1 <- local  && ref1 -> ref2
ALTER TABLE distributed_table_1 ADD CONSTRAINT fkey_1 FOREIGN KEY (col) REFERENCES "distributed_table_2'! ?._"(col);
ALTER TABLE "distributed_table_2'! ?._" ADD CONSTRAINT fkey_1 FOREIGN KEY (col) REFERENCES reference_table_1(col);
ALTER TABLE reference_table_1 ADD CONSTRAINT fkey_1 FOREIGN KEY (col) REFERENCES reference_table_2(col);
ALTER TABLE local_table ADD CONSTRAINT fkey_1 FOREIGN KEY (col) REFERENCES reference_table_1(col);
SELECT create_reference_table('reference_table_2');
 create_reference_table
---------------------------------------------------------------------

(1 row)

SELECT create_reference_table('reference_table_1');
 create_reference_table
---------------------------------------------------------------------

(1 row)

SELECT create_distributed_table('"distributed_table_2''! ?._"', 'col');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

SELECT create_distributed_table('distributed_table_1', 'col');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

SELECT create_distributed_table('distributed_table_3', 'col');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

SELECT create_distributed_table('distributed_table_4', 'a');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

CREATE INDEX ind1 ON distributed_table_4(a);
CREATE INDEX ind2 ON distributed_table_4(b);
CREATE INDEX ind3 ON distributed_table_4(a, b);
CREATE STATISTICS stat ON a,b FROM distributed_table_4;
-- create views to make sure that they'll continue working after stop_sync
INSERT INTO distributed_table_3 VALUES (1);
CREATE VIEW test_view AS SELECT COUNT(*) FROM distributed_table_3;
CREATE MATERIALIZED VIEW test_matview AS SELECT COUNT(*) FROM distributed_table_3;
ALTER TABLE distributed_table_4 DROP COLUMN c;
SELECT start_metadata_sync_to_node('localhost', :worker_1_port);
 start_metadata_sync_to_node
---------------------------------------------------------------------

(1 row)

\c - - - :worker_1_port
SET search_path TO "start_stop_metadata_sync";
\d+ distributed_table_4
                   Table "start_stop_metadata_sync.distributed_table_4"
 Column |  Type   | Collation | Nullable | Default | Storage | Stats target | Description
---------------------------------------------------------------------
 a      | integer |           | not null |         | plain   |              |
 b      | integer |           |          |         | plain   |              |
Indexes:
    "distributed_table_4_a_key" UNIQUE CONSTRAINT, btree (a)
    "ind1" btree (a)
    "ind2" btree (b)
    "ind3" btree (a, b)
Statistics objects:
    "start_stop_metadata_sync"."stat" (ndistinct, dependencies, mcv) ON a, b FROM distributed_table_4

SELECT * FROM distributed_table_1;
 col | b
---------------------------------------------------------------------
(0 rows)

CREATE VIEW test_view AS SELECT COUNT(*) FROM distributed_table_3;
CREATE MATERIALIZED VIEW test_matview AS SELECT COUNT(*) FROM distributed_table_3;
SELECT * FROM test_view;
 count
---------------------------------------------------------------------
     1
(1 row)

SELECT * FROM test_matview;
 count
---------------------------------------------------------------------
     1
(1 row)

SELECT count(*) > 0 FROM pg_dist_node;
 ?column?
---------------------------------------------------------------------
 t
(1 row)

SELECT count(*) > 0 FROM pg_dist_shard;
 ?column?
---------------------------------------------------------------------
 t
(1 row)

SELECT count(*) > 0 FROM pg_class WHERE relname LIKE 'distributed_table__' AND relnamespace IN (SELECT oid FROM pg_namespace WHERE nspname = 'start_stop_metadata_sync');
 ?column?
---------------------------------------------------------------------
 t
(1 row)

SELECT count(*) > 0 FROM pg_class WHERE relname LIKE 'reference_table__' AND relnamespace IN (SELECT oid FROM pg_namespace WHERE nspname = 'start_stop_metadata_sync');
 ?column?
---------------------------------------------------------------------
 t
(1 row)

\c - - - :master_port
SET search_path TO "start_stop_metadata_sync";
SELECT * FROM distributed_table_1;
 col | b
---------------------------------------------------------------------
(0 rows)

ALTER TABLE distributed_table_4 DROP COLUMN b;
SELECT stop_metadata_sync_to_node('localhost', :worker_1_port);
NOTICE:  dropping metadata on the node (localhost,57637)
NOTICE:  unsynchronizing metadata on the node (localhost,57637)
 stop_metadata_sync_to_node
---------------------------------------------------------------------

(1 row)

\d+ distributed_table_4
                   Table "start_stop_metadata_sync.distributed_table_4"
 Column |  Type   | Collation | Nullable | Default | Storage | Stats target | Description
---------------------------------------------------------------------
 a      | integer |           | not null |         | plain   |              |
Indexes:
    "distributed_table_4_a_key" UNIQUE CONSTRAINT, btree (a)
    "ind1" btree (a)

SELECT * FROM test_view;
 count
---------------------------------------------------------------------
     1
(1 row)

SELECT * FROM test_matview;
 count
---------------------------------------------------------------------
     1
(1 row)

SELECT count(*) > 0 FROM pg_dist_node;
 ?column?
---------------------------------------------------------------------
 t
(1 row)

SELECT count(*) > 0 FROM pg_dist_shard;
 ?column?
---------------------------------------------------------------------
 t
(1 row)

SELECT count(*) > 0 FROM pg_class WHERE relname LIKE 'distributed_table__' AND relnamespace IN (SELECT oid FROM pg_namespace WHERE nspname = 'start_stop_metadata_sync');
 ?column?
---------------------------------------------------------------------
 t
(1 row)

SELECT count(*) > 0 FROM pg_class WHERE relname LIKE 'reference_table__' AND relnamespace IN (SELECT oid FROM pg_namespace WHERE nspname = 'start_stop_metadata_sync');
 ?column?
---------------------------------------------------------------------
 t
(1 row)

\c - - - :worker_1_port
SET search_path TO "start_stop_metadata_sync";
-- these should not be found because of stop_metadata_sync_to_node
SELECT * FROM distributed_table_1;
ERROR:  relation "distributed_table_1" does not exist
\d+ distributed_table_4
SELECT * FROM test_view;
ERROR:  relation "test_view" does not exist
SELECT * FROM test_matview;
ERROR:  relation "test_matview" does not exist
SELECT count(*) > 0 FROM pg_dist_node;
 ?column?
---------------------------------------------------------------------
 f
(1 row)

SELECT count(*) > 0 FROM pg_dist_shard;
 ?column?
---------------------------------------------------------------------
 f
(1 row)

SELECT count(*) > 0 FROM pg_class WHERE relname LIKE 'distributed_table__' AND relnamespace IN (SELECT oid FROM pg_namespace WHERE nspname = 'start_stop_metadata_sync');
 ?column?
---------------------------------------------------------------------
 f
(1 row)

SELECT count(*) > 0 FROM pg_class WHERE relname LIKE 'reference_table__' AND relnamespace IN (SELECT oid FROM pg_namespace WHERE nspname = 'start_stop_metadata_sync');
 ?column?
---------------------------------------------------------------------
 f
(1 row)

\c - - - :master_port
SET search_path TO "start_stop_metadata_sync";
SELECT * FROM distributed_table_1;
 col | b
---------------------------------------------------------------------
(0 rows)

SELECT start_metadata_sync_to_node('localhost', :worker_1_port);
 start_metadata_sync_to_node
---------------------------------------------------------------------

(1 row)

\c - - - :worker_1_port
SELECT count(*) > 0 FROM pg_dist_node;
 ?column?
---------------------------------------------------------------------
 t
(1 row)

SELECT count(*) > 0 FROM pg_dist_shard;
 ?column?
---------------------------------------------------------------------
 t
(1 row)

SELECT count(*) > 0 FROM pg_class WHERE relname LIKE 'distributed_table__' AND relnamespace IN (SELECT oid FROM pg_namespace WHERE nspname = 'start_stop_metadata_sync');
 ?column?
---------------------------------------------------------------------
 t
(1 row)

SELECT count(*) > 0 FROM pg_class WHERE relname LIKE 'reference_table__' AND relnamespace IN (SELECT oid FROM pg_namespace WHERE nspname = 'start_stop_metadata_sync');
 ?column?
---------------------------------------------------------------------
 t
(1 row)

\c - - - :master_port
SET search_path TO "start_stop_metadata_sync";
--cleanup
SET client_min_messages TO WARNING;
DROP SCHEMA start_stop_metadata_sync CASCADE;
