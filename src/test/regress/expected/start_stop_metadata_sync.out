CREATE SCHEMA start_stop_metadata_sync;
SET search_path TO "start_stop_metadata_sync";
SET citus.next_shard_id TO 980000;
SET client_min_messages TO WARNING;
SET citus.shard_count TO 4;
SET citus.shard_replication_factor TO 1;
CREATE TABLE distributed_table_1(col int unique);
CREATE TABLE "distributed_table_2'! ?._"(col int unique);
CREATE TABLE distributed_table_3(col int);
CREATE TABLE reference_table_1(col int unique);
CREATE TABLE reference_table_2(col int unique);
CREATE TABLE local_table(col int unique);
ALTER TABLE distributed_table_1 ADD CONSTRAINT fkey_1 FOREIGN KEY (col) REFERENCES "distributed_table_2'! ?._"(col);
ALTER TABLE "distributed_table_2'! ?._" ADD CONSTRAINT fkey_1 FOREIGN KEY (col) REFERENCES reference_table_1(col);
ALTER TABLE reference_table_1 ADD CONSTRAINT fkey_1 FOREIGN KEY (col) REFERENCES reference_table_2(col);
ALTER TABLE local_table ADD CONSTRAINT fkey_1 FOREIGN KEY (col) REFERENCES reference_table_1(col);
SELECT create_reference_table('reference_table_2');
 create_reference_table
---------------------------------------------------------------------

(1 row)

SELECT create_reference_table('reference_table_1');
 create_reference_table
---------------------------------------------------------------------

(1 row)

SELECT create_distributed_table('"distributed_table_2''! ?._"', 'col');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

SELECT create_distributed_table('distributed_table_1', 'col');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

SELECT create_distributed_table('distributed_table_3', 'col');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

CREATE VIEW test_view AS SELECT COUNT(*) FROM distributed_table_3;
CREATE MATERIALIZED VIEW test_matview AS SELECT COUNT(*) FROM distributed_table_3;
INSERT INTO distributed_table_3 VALUES (1);
SELECT start_metadata_sync_to_node('localhost', :worker_1_port);
 start_metadata_sync_to_node
---------------------------------------------------------------------

(1 row)

\c - - - :worker_1_port
SET search_path TO "start_stop_metadata_sync";
CREATE VIEW test_view AS SELECT COUNT(*) FROM distributed_table_3;
CREATE MATERIALIZED VIEW test_matview AS SELECT COUNT(*) FROM distributed_table_3;
SELECT * FROM test_view;
 count
---------------------------------------------------------------------
     1
(1 row)

SELECT * FROM test_matview;
 count
---------------------------------------------------------------------
     1
(1 row)

SELECT count(*) > 0 FROM pg_dist_node;
 ?column?
---------------------------------------------------------------------
 t
(1 row)

SELECT count(*) > 0 FROM pg_dist_shard;
 ?column?
---------------------------------------------------------------------
 t
(1 row)

SELECT count(*) > 0 FROM pg_class WHERE relname LIKE 'distributed_table__' AND relnamespace IN (SELECT oid FROM pg_namespace WHERE nspname = 'start_stop_metadata_sync');
 ?column?
---------------------------------------------------------------------
 t
(1 row)

SELECT count(*) > 0 FROM pg_class WHERE relname LIKE 'reference_table__' AND relnamespace IN (SELECT oid FROM pg_namespace WHERE nspname = 'start_stop_metadata_sync');
 ?column?
---------------------------------------------------------------------
 t
(1 row)

\c - - - :master_port
SET search_path TO "start_stop_metadata_sync";
SELECT stop_metadata_sync_to_node('localhost', :worker_1_port);
 stop_metadata_sync_to_node
---------------------------------------------------------------------

(1 row)

SELECT * FROM test_view;
 count
---------------------------------------------------------------------
     1
(1 row)

SELECT * FROM test_matview;
 count
---------------------------------------------------------------------
     0
(1 row)

SELECT count(*) > 0 FROM pg_dist_node;
 ?column?
---------------------------------------------------------------------
 t
(1 row)

SELECT count(*) > 0 FROM pg_dist_shard;
 ?column?
---------------------------------------------------------------------
 t
(1 row)

SELECT count(*) > 0 FROM pg_class WHERE relname LIKE 'distributed_table__' AND relnamespace IN (SELECT oid FROM pg_namespace WHERE nspname = 'start_stop_metadata_sync');
 ?column?
---------------------------------------------------------------------
 t
(1 row)

SELECT count(*) > 0 FROM pg_class WHERE relname LIKE 'reference_table__' AND relnamespace IN (SELECT oid FROM pg_namespace WHERE nspname = 'start_stop_metadata_sync');
 ?column?
---------------------------------------------------------------------
 t
(1 row)

\c - - - :worker_1_port
SET search_path TO "start_stop_metadata_sync";
SELECT * FROM test_view;
ERROR:  relation "test_view" does not exist
SELECT * FROM test_matview;
ERROR:  relation "test_matview" does not exist
SELECT count(*) > 0 FROM pg_dist_node;
 ?column?
---------------------------------------------------------------------
 f
(1 row)

SELECT count(*) > 0 FROM pg_dist_shard;
 ?column?
---------------------------------------------------------------------
 f
(1 row)

SELECT count(*) > 0 FROM pg_class WHERE relname LIKE 'distributed_table__' AND relnamespace IN (SELECT oid FROM pg_namespace WHERE nspname = 'start_stop_metadata_sync');
 ?column?
---------------------------------------------------------------------
 f
(1 row)

SELECT count(*) > 0 FROM pg_class WHERE relname LIKE 'reference_table__' AND relnamespace IN (SELECT oid FROM pg_namespace WHERE nspname = 'start_stop_metadata_sync');
 ?column?
---------------------------------------------------------------------
 f
(1 row)

\c - - - :master_port
--cleanup
DROP SCHEMA start_stop_metadata_sync CASCADE;
NOTICE:  drop cascades to 8 other objects
DETAIL:  drop cascades to table start_stop_metadata_sync.distributed_table_1
drop cascades to table start_stop_metadata_sync."distributed_table_2'! ?._"
drop cascades to table start_stop_metadata_sync.distributed_table_3
drop cascades to table start_stop_metadata_sync.reference_table_1
drop cascades to table start_stop_metadata_sync.reference_table_2
drop cascades to table start_stop_metadata_sync.local_table
drop cascades to view start_stop_metadata_sync.test_view
drop cascades to materialized view start_stop_metadata_sync.test_matview
