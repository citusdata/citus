/*
  Test to check if the background tasks scheduled by the background rebalancer
  has the correct dependencies.
*/
CREATE SCHEMA background_rebalance_parallel;
SET search_path TO background_rebalance_parallel;
SET citus.next_shard_id TO 85674000;
SET citus.shard_replication_factor TO 1;
ALTER SEQUENCE pg_dist_background_job_job_id_seq RESTART 17777;
ALTER SEQUENCE pg_dist_background_task_task_id_seq RESTART 1460000;
ALTER SYSTEM SET citus.background_task_queue_interval TO '1s';
SELECT pg_reload_conf();
 pg_reload_conf
---------------------------------------------------------------------
 t
(1 row)

SELECT 1 FROM citus_disable_node('localhost', :worker_2_port, synchronous:=true);
 ?column?
---------------------------------------------------------------------
        1
(1 row)

/* Create two tables table1_coloc1, table2_coloc1 and in a colocation group  */
CREATE TABLE table1_colg1 (a int PRIMARY KEY);
SELECT create_distributed_table('table1_colg1', 'a', shard_count => 8, colocate_with => 'none');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

CREATE TABLE table2_colg1 (b int PRIMARY KEY);
SELECT create_distributed_table('table2_colg1', 'b' , colocate_with => 'table1_colg1');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

CREATE TABLE table1_colg2 (a int PRIMARY KEY);
SELECT create_distributed_table('table1_colg2 ', 'a', shard_count => 8, colocate_with => 'none');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

CREATE TABLE  table2_colg2 (b int primary key);
SELECT create_distributed_table('table2_colg2', 'b' , colocate_with => 'table1_colg2');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

/* Activate a node so that we can rebalance */
SELECT 1 FROM citus_activate_node('localhost', :worker_2_port);
 ?column?
---------------------------------------------------------------------
        1
(1 row)

SELECT citus_set_node_property('localhost', :worker_2_port, 'shouldhaveshards', true);
 citus_set_node_property
---------------------------------------------------------------------

(1 row)

SELECT * FROM citus_rebalance_start();
NOTICE:  Scheduled 8 moves as job xxx
DETAIL:  Rebalance scheduled as background job
HINT:  To monitor progress, run: SELECT * FROM citus_rebalance_status();
 citus_rebalance_start
---------------------------------------------------------------------
                 17777
(1 row)

SELECT citus_rebalance_wait();
 citus_rebalance_wait
---------------------------------------------------------------------

(1 row)

/* Check that all the move tasks for shards of table1_colg1 and table2_colg1 sequentially take a dependency on each other.
 * The all the move tasks of table1_colg2 and table2_colg2 sequentially take a dependency on each other *
   The first move task scheduled in each group has no dependency.
 */
SELECT * FROM pg_dist_background_task_depend WHERE job_id = 17777 ORDER BY task_id ASC;
 job_id | task_id | depends_on
---------------------------------------------------------------------
  17777 | 1460001 |    1460000
  17777 | 1460002 |    1460001
  17777 | 1460003 |    1460002
  17777 | 1460004 |    1460003
  17777 | 1460005 |    1460004
  17777 | 1460006 |    1460005
  17777 | 1460007 |    1460006
(7 rows)

/* Check that if there is a reference table that needs to be synched to a node, the first move scheduled in a colocation group takes a dependency on the
   replicate_reference_tables task */
SELECT 1 FROM citus_drain_node('localhost',:worker_2_port);
NOTICE:  Moving shard xxxxx from localhost:xxxxx to localhost:xxxxx ...
NOTICE:  Moving shard xxxxx from localhost:xxxxx to localhost:xxxxx ...
NOTICE:  Moving shard xxxxx from localhost:xxxxx to localhost:xxxxx ...
NOTICE:  Moving shard xxxxx from localhost:xxxxx to localhost:xxxxx ...
NOTICE:  Moving shard xxxxx from localhost:xxxxx to localhost:xxxxx ...
NOTICE:  Moving shard xxxxx from localhost:xxxxx to localhost:xxxxx ...
NOTICE:  Moving shard xxxxx from localhost:xxxxx to localhost:xxxxx ...
NOTICE:  Moving shard xxxxx from localhost:xxxxx to localhost:xxxxx ...
 ?column?
---------------------------------------------------------------------
        1
(1 row)

SELECT 1 FROM citus_disable_node('localhost', :worker_2_port, synchronous:=true);
 ?column?
---------------------------------------------------------------------
        1
(1 row)

CREATE TABLE ref_table(a int PRIMARY KEY);
SELECT create_reference_table('ref_table');
 create_reference_table
---------------------------------------------------------------------

(1 row)

/* Activate a node so that we can rebalance */
SELECT 1 FROM citus_activate_node('localhost', :worker_2_port);
 ?column?
---------------------------------------------------------------------
        1
(1 row)

SELECT citus_set_node_property('localhost', :worker_2_port, 'shouldhaveshards', true);
 citus_set_node_property
---------------------------------------------------------------------

(1 row)

SELECT * FROM citus_rebalance_start();
NOTICE:  Scheduled 8 moves as job xxx
DETAIL:  Rebalance scheduled as background job
HINT:  To monitor progress, run: SELECT * FROM citus_rebalance_status();
 citus_rebalance_start
---------------------------------------------------------------------
                 17778
(1 row)

SELECT citus_rebalance_wait();
 citus_rebalance_wait
---------------------------------------------------------------------

(1 row)

SELECT * FROM pg_dist_background_task_depend WHERE job_id = 17778 ORDER BY task_id ASC;
 job_id | task_id | depends_on
---------------------------------------------------------------------
  17778 | 1460009 |    1460008
  17778 | 1460010 |    1460009
  17778 | 1460011 |    1460010
  17778 | 1460012 |    1460011
  17778 | 1460013 |    1460012
  17778 | 1460014 |    1460013
  17778 | 1460015 |    1460014
  17778 | 1460016 |    1460015
(8 rows)

DROP SCHEMA background_rebalance_parallel CASCADE;
NOTICE:  drop cascades to 5 other objects
DETAIL:  drop cascades to table table1_colg1
drop cascades to table table2_colg1
drop cascades to table table1_colg2
drop cascades to table table2_colg2
drop cascades to table ref_table
TRUNCATE pg_dist_background_job CASCADE;
NOTICE:  truncate cascades to table "pg_dist_background_task"
NOTICE:  truncate cascades to table "pg_dist_background_task_depend"
