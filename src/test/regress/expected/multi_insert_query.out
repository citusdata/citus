--
-- MULTI_INSERT_QUERY
--
ALTER SEQUENCE pg_catalog.pg_dist_shardid_seq RESTART 1300000;
ALTER SEQUENCE pg_catalog.pg_dist_jobid_seq RESTART 1300000;
CREATE SCHEMA insert_query
CREATE TABLE hash_table (
    key int,
    value text,
    attributes text[]
)
CREATE TABLE append_table (
    LIKE hash_table
)
CREATE TABLE staging_table (
    LIKE hash_table
);
SELECT master_create_distributed_table('insert_query.hash_table', 'key', 'hash');
 master_create_distributed_table 
---------------------------------
 
(1 row)

SELECT master_create_worker_shards('insert_query.hash_table', 4, 2);
 master_create_worker_shards 
-----------------------------
 
(1 row)

SELECT master_create_distributed_table('insert_query.append_table', 'key', 'append');
 master_create_distributed_table 
---------------------------------
 
(1 row)

-- Try to insert into both distributed tables from staging table
SELECT master_insert_query_result('insert_query.hash_table', $$
  SELECT s, 'value-'||s, ARRAY['a-'||s,'b-'||s] FROM generate_series(1, 1000) s
$$);
 master_insert_query_result 
----------------------------
                       1000
(1 row)

SELECT count(*) FROM insert_query.hash_table;
 count 
-------
  1000
(1 row)

SELECT * FROM insert_query.hash_table LIMIT 1;
 key |  value  | attributes 
-----+---------+------------
   1 | value-1 | {a-1,b-1}
(1 row)

-- Try to insert into both distributed tables from staging table
SELECT master_insert_query_result('insert_query.append_table', $$
  SELECT s, 'value-'||s, ARRAY['a-'||s,'b-'||s] FROM generate_series(1001, 2000) s
$$);
 master_insert_query_result 
----------------------------
                       1000
(1 row)

SELECT count(*) FROM insert_query.append_table;
 count 
-------
  1000
(1 row)

SELECT * FROM insert_query.append_table LIMIT 1;
 key  |   value    |   attributes    
------+------------+-----------------
 1001 | value-1001 | {a-1001,b-1001}
(1 row)

-- Load 1000 rows in to staging table
INSERT INTO insert_query.staging_table
SELECT s, 'value-'||s, ARRAY['a-'||s,'b-'||s] FROM generate_series(2001, 3000) s;
-- Move all the rows into target table
SELECT master_insert_query_result('insert_query.hash_table',
                                  'DELETE FROM insert_query.staging_table RETURNING *');
 master_insert_query_result 
----------------------------
                       1000
(1 row)

SELECT count(*) FROM insert_query.hash_table;
 count 
-------
  2000
(1 row)

-- Copy from a distributed table to a distributed table
SELECT master_insert_query_result('insert_query.append_table', 
                                  'SELECT * FROM insert_query.hash_table LIMIT 10');
 master_insert_query_result 
----------------------------
                         10
(1 row)

SELECT count(*) FROM insert_query.append_table;
 count 
-------
  1010
(1 row)

-- Too many columns
SELECT master_insert_query_result('insert_query.hash_table', $$
  SELECT key, value, attributes, attributes FROM insert_query.append_table
$$);
ERROR:  query result has more columns than table
-- Too few columns
SELECT master_insert_query_result('insert_query.hash_table', $$
  SELECT key, value FROM insert_query.append_table
$$);
ERROR:  query result has fewer columns than table
-- Non-matching data type
SELECT master_insert_query_result('insert_query.hash_table', $$
  SELECT key, attributes, value FROM insert_query.append_table
$$);
ERROR:  query result does not match the type of column "value"
