--
-- TDIGEST_AGGREGATE_SUPPORT
--   test the integration of github.com/tvondra/tdigest aggregates into the citus planner
--   for push down parts of the aggregate to use parallelized execution and reduced data
--   transfer sizes for aggregates not grouped by the distribution column
--
SET citus.next_shard_id TO 20070000;
CREATE SCHEMA tdigest_aggregate_support;
SET search_path TO tdigest_aggregate_support, public;
-- create the tdigest extension when installed
SELECT CASE WHEN COUNT(*) > 0
    THEN 'CREATE EXTENSION tdigest WITH SCHEMA public'
    ELSE 'SELECT false AS tdigest_present' END
AS create_cmd FROM pg_available_extensions()
WHERE name = 'tdigest'
\gset
:create_cmd;
SET citus.shard_count TO 4;
SET citus.coordinator_aggregation_strategy TO 'disabled'; -- prevent aggregate execution when the aggregate can't be pushed down
CREATE TABLE latencies (a int, b int, latency double precision);
SELECT create_distributed_table('latencies', 'a');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

SELECT setseed(0.42); -- make the random data inserted deterministic
 setseed
---------------------------------------------------------------------

(1 row)

INSERT INTO latencies
SELECT (random()*20)::int AS a,
       (random()*20)::int AS b,
       random()*10000.0 AS latency
FROM generate_series(1, 10000);
-- explain no grouping to verify partially pushed down for tdigest(value, compression)
EXPLAIN (COSTS OFF, VERBOSE)
SELECT tdigest(latency, 100)
FROM latencies;
                                         QUERY PLAN
---------------------------------------------------------------------
 Aggregate
   Output: tdigest(remote_scan.tdigest)
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.tdigest
         Task Count: 4
         Tasks Shown: One of 4
         ->  Task
               Node: host=localhost port=xxxxx dbname=regression
               ->  Aggregate
                     Output: tdigest(latency, 100)
                     ->  Seq Scan on tdigest_aggregate_support.latencies_20070000 latencies
                           Output: a, b, latency
(12 rows)

-- explain grouping by distribution column is completely pushed down for tdigest(value, compression)
EXPLAIN (COSTS OFF, VERBOSE)
SELECT a, tdigest(latency, 100)
FROM latencies
GROUP BY a;
                                      QUERY PLAN
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.a, remote_scan.tdigest
   Task Count: 4
   Tasks Shown: One of 4
   ->  Task
         Node: host=localhost port=xxxxx dbname=regression
         ->  HashAggregate
               Output: a, tdigest(latency, 100)
               Group Key: latencies.a
               ->  Seq Scan on tdigest_aggregate_support.latencies_20070000 latencies
                     Output: a, b, latency
(11 rows)

-- explain grouping by non-distribution column is partially pushed down for tdigest(value, compression)
EXPLAIN (COSTS OFF, VERBOSE)
SELECT b, tdigest(latency, 100)
FROM latencies
GROUP BY b;
                                         QUERY PLAN
---------------------------------------------------------------------
 HashAggregate
   Output: remote_scan.b, tdigest(remote_scan.tdigest)
   Group Key: remote_scan.b
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.b, remote_scan.tdigest
         Task Count: 4
         Tasks Shown: One of 4
         ->  Task
               Node: host=localhost port=xxxxx dbname=regression
               ->  HashAggregate
                     Output: b, tdigest(latency, 100)
                     Group Key: latencies.b
                     ->  Seq Scan on tdigest_aggregate_support.latencies_20070000 latencies
                           Output: a, b, latency
(14 rows)

-- explain no grouping to verify partially pushed down for tdigest_precentile(value, compression, quantile)
EXPLAIN (COSTS OFF, VERBOSE)
SELECT tdigest_percentile(latency, 100, 0.99)
FROM latencies;
                                         QUERY PLAN
---------------------------------------------------------------------
 Aggregate
   Output: tdigest_percentile(remote_scan.tdigest_percentile, '0.99'::double precision)
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.tdigest_percentile
         Task Count: 4
         Tasks Shown: One of 4
         ->  Task
               Node: host=localhost port=xxxxx dbname=regression
               ->  Aggregate
                     Output: tdigest(latency, 100)
                     ->  Seq Scan on tdigest_aggregate_support.latencies_20070000 latencies
                           Output: a, b, latency
(12 rows)

-- explain grouping by distribution column is completely pushed down for tdigest_precentile(value, compression, quantile)
EXPLAIN (COSTS OFF, VERBOSE)
SELECT a, tdigest_percentile(latency, 100, 0.99)
FROM latencies
GROUP BY a;
                                      QUERY PLAN
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.a, remote_scan.tdigest_percentile
   Task Count: 4
   Tasks Shown: One of 4
   ->  Task
         Node: host=localhost port=xxxxx dbname=regression
         ->  HashAggregate
               Output: a, tdigest_percentile(latency, 100, '0.99'::double precision)
               Group Key: latencies.a
               ->  Seq Scan on tdigest_aggregate_support.latencies_20070000 latencies
                     Output: a, b, latency
(11 rows)

-- explain grouping by non-distribution column is partially pushed down for tdigest_precentile(value, compression, quantile)
EXPLAIN (COSTS OFF, VERBOSE)
SELECT b, tdigest_percentile(latency, 100, 0.99)
FROM latencies
GROUP BY b;
                                              QUERY PLAN
---------------------------------------------------------------------
 HashAggregate
   Output: remote_scan.b, tdigest_percentile(remote_scan.tdigest_percentile, '0.99'::double precision)
   Group Key: remote_scan.b
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.b, remote_scan.tdigest_percentile
         Task Count: 4
         Tasks Shown: One of 4
         ->  Task
               Node: host=localhost port=xxxxx dbname=regression
               ->  HashAggregate
                     Output: b, tdigest(latency, 100)
                     Group Key: latencies.b
                     ->  Seq Scan on tdigest_aggregate_support.latencies_20070000 latencies
                           Output: a, b, latency
(14 rows)

-- explain no grouping to verify partially pushed down for tdigest_precentile(value, compression, quantiles[])
EXPLAIN (COSTS OFF, VERBOSE)
SELECT tdigest_percentile(latency, 100, ARRAY[0.99, 0.95])
FROM latencies;
                                           QUERY PLAN
---------------------------------------------------------------------
 Aggregate
   Output: tdigest_percentile(remote_scan.tdigest_percentile, '{0.99,0.95}'::double precision[])
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.tdigest_percentile
         Task Count: 4
         Tasks Shown: One of 4
         ->  Task
               Node: host=localhost port=xxxxx dbname=regression
               ->  Aggregate
                     Output: tdigest(latency, 100)
                     ->  Seq Scan on tdigest_aggregate_support.latencies_20070000 latencies
                           Output: a, b, latency
(12 rows)

-- explain grouping by distribution column is completely pushed down for tdigest_precentile(value, compression, quantiles[])
EXPLAIN (COSTS OFF, VERBOSE)
SELECT a, tdigest_percentile(latency, 100, ARRAY[0.99, 0.95])
FROM latencies
GROUP BY a;
                                          QUERY PLAN
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.a, remote_scan.tdigest_percentile
   Task Count: 4
   Tasks Shown: One of 4
   ->  Task
         Node: host=localhost port=xxxxx dbname=regression
         ->  HashAggregate
               Output: a, tdigest_percentile(latency, 100, '{0.99,0.95}'::double precision[])
               Group Key: latencies.a
               ->  Seq Scan on tdigest_aggregate_support.latencies_20070000 latencies
                     Output: a, b, latency
(11 rows)

-- explain grouping by non-distribution column is partially pushed down for tdigest_precentile(value, compression, quantiles[])
EXPLAIN (COSTS OFF, VERBOSE)
SELECT b, tdigest_percentile(latency, 100, ARRAY[0.99, 0.95])
FROM latencies
GROUP BY b;
                                                   QUERY PLAN
---------------------------------------------------------------------
 HashAggregate
   Output: remote_scan.b, tdigest_percentile(remote_scan.tdigest_percentile, '{0.99,0.95}'::double precision[])
   Group Key: remote_scan.b
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.b, remote_scan.tdigest_percentile
         Task Count: 4
         Tasks Shown: One of 4
         ->  Task
               Node: host=localhost port=xxxxx dbname=regression
               ->  HashAggregate
                     Output: b, tdigest(latency, 100)
                     Group Key: latencies.b
                     ->  Seq Scan on tdigest_aggregate_support.latencies_20070000 latencies
                           Output: a, b, latency
(14 rows)

-- explain no grouping to verify partially pushed down for tdigest_precentile_of(value, compression, hypotetical_value)
EXPLAIN (COSTS OFF, VERBOSE)
SELECT tdigest_percentile_of(latency, 100, 9000)
FROM latencies;
                                          QUERY PLAN
---------------------------------------------------------------------
 Aggregate
   Output: tdigest_percentile_of(remote_scan.tdigest_percentile_of, '9000'::double precision)
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.tdigest_percentile_of
         Task Count: 4
         Tasks Shown: One of 4
         ->  Task
               Node: host=localhost port=xxxxx dbname=regression
               ->  Aggregate
                     Output: tdigest(latency, 100)
                     ->  Seq Scan on tdigest_aggregate_support.latencies_20070000 latencies
                           Output: a, b, latency
(12 rows)

-- explain grouping by distribution column is completely pushed down for tdigest_precentile_of(value, compression, hypotetical_value)
EXPLAIN (COSTS OFF, VERBOSE)
SELECT a, tdigest_percentile_of(latency, 100, 9000)
FROM latencies
GROUP BY a;
                                       QUERY PLAN
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.a, remote_scan.tdigest_percentile_of
   Task Count: 4
   Tasks Shown: One of 4
   ->  Task
         Node: host=localhost port=xxxxx dbname=regression
         ->  HashAggregate
               Output: a, tdigest_percentile_of(latency, 100, '9000'::double precision)
               Group Key: latencies.a
               ->  Seq Scan on tdigest_aggregate_support.latencies_20070000 latencies
                     Output: a, b, latency
(11 rows)

-- explain grouping by non-distribution column is partially pushed down for tdigest_precentile_of(value, compression, hypotetical_value)
EXPLAIN (COSTS OFF, VERBOSE)
SELECT b, tdigest_percentile_of(latency, 100, 9000)
FROM latencies
GROUP BY b;
                                                 QUERY PLAN
---------------------------------------------------------------------
 HashAggregate
   Output: remote_scan.b, tdigest_percentile_of(remote_scan.tdigest_percentile_of, '9000'::double precision)
   Group Key: remote_scan.b
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.b, remote_scan.tdigest_percentile_of
         Task Count: 4
         Tasks Shown: One of 4
         ->  Task
               Node: host=localhost port=xxxxx dbname=regression
               ->  HashAggregate
                     Output: b, tdigest(latency, 100)
                     Group Key: latencies.b
                     ->  Seq Scan on tdigest_aggregate_support.latencies_20070000 latencies
                           Output: a, b, latency
(14 rows)

-- explain no grouping to verify partially pushed down for tdigest_precentile_of(value, compression, hypotetical_values[])
EXPLAIN (COSTS OFF, VERBOSE)
SELECT tdigest_percentile_of(latency, 100, ARRAY[9000, 9500])
FROM latencies;
                                              QUERY PLAN
---------------------------------------------------------------------
 Aggregate
   Output: tdigest_percentile_of(remote_scan.tdigest_percentile_of, '{9000,9500}'::double precision[])
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.tdigest_percentile_of
         Task Count: 4
         Tasks Shown: One of 4
         ->  Task
               Node: host=localhost port=xxxxx dbname=regression
               ->  Aggregate
                     Output: tdigest(latency, 100)
                     ->  Seq Scan on tdigest_aggregate_support.latencies_20070000 latencies
                           Output: a, b, latency
(12 rows)

-- explain grouping by distribution column is completely pushed down for tdigest_precentile_of(value, compression, hypotetical_values[])
EXPLAIN (COSTS OFF, VERBOSE)
SELECT a, tdigest_percentile_of(latency, 100, ARRAY[9000, 9500])
FROM latencies
GROUP BY a;
                                           QUERY PLAN
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.a, remote_scan.tdigest_percentile_of
   Task Count: 4
   Tasks Shown: One of 4
   ->  Task
         Node: host=localhost port=xxxxx dbname=regression
         ->  HashAggregate
               Output: a, tdigest_percentile_of(latency, 100, '{9000,9500}'::double precision[])
               Group Key: latencies.a
               ->  Seq Scan on tdigest_aggregate_support.latencies_20070000 latencies
                     Output: a, b, latency
(11 rows)

-- explain grouping by non-distribution column is partially pushed down for tdigest_precentile_of(value, compression, hypotetical_values[])
EXPLAIN (COSTS OFF, VERBOSE)
SELECT b, tdigest_percentile_of(latency, 100, ARRAY[9000, 9500])
FROM latencies
GROUP BY b;
                                                      QUERY PLAN
---------------------------------------------------------------------
 HashAggregate
   Output: remote_scan.b, tdigest_percentile_of(remote_scan.tdigest_percentile_of, '{9000,9500}'::double precision[])
   Group Key: remote_scan.b
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.b, remote_scan.tdigest_percentile_of
         Task Count: 4
         Tasks Shown: One of 4
         ->  Task
               Node: host=localhost port=xxxxx dbname=regression
               ->  HashAggregate
                     Output: b, tdigest(latency, 100)
                     Group Key: latencies.b
                     ->  Seq Scan on tdigest_aggregate_support.latencies_20070000 latencies
                           Output: a, b, latency
(14 rows)

-- verifying results - should be stable due to seed while inserting the data, if failure due to data these queries could be removed or check for certain ranges
SELECT tdigest(latency, 100) FROM latencies;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          tdigest
---------------------------------------------------------------------
 flags 0 count 10000 compression 100 centroids 46 (0.397027, 1) (4.993398, 1) (5.909367, 1) (6.324342, 1) (16.598357, 2) (28.974330, 2) (66.978955, 4) (117.027568, 6) (239.795455, 9) (539.912265, 15) (1253.159517, 23) (3125.566701, 35) (5715.193949, 42) (15097.303037, 78) (29532.582573, 102) (52993.242485, 125) (104462.303239, 180) (252921.253493, 309) (477888.569045, 404) (989177.745874, 590) (2054008.195101, 877) (3411475.845724, 1019) (5639026.617669, 1264) (6737561.952449, 1192) (7493299.664739, 1105) (6334574.844842, 809) (4807686.705113, 568) (3835023.608817, 429) (2105412.375550, 227) (1539878.278444, 163) (1441125.003319, 150) (817909.924575, 84) (529524.706216, 54) (404203.606239, 41) (297154.393093, 30) (158915.034779, 16) (109470.373816, 11) (109613.937149, 11) (69825.094021, 7) (39927.521836, 4) (29951.824085, 3) (19974.743724, 2) (9989.097258, 1) (9995.834827, 1) (9996.046554, 1) (9998.566615, 1)
(1 row)

SELECT tdigest_percentile(latency, 100, 0.99) FROM latencies;
 tdigest_percentile
---------------------------------------------------------------------
   9870.41882540529
(1 row)

SELECT tdigest_percentile_of(latency, 100, 9000) FROM latencies;
 tdigest_percentile_of
---------------------------------------------------------------------
      0.90381982378332
(1 row)

CREATE TABLE latencies_rollup (a int, tdigest tdigest);
SELECT create_distributed_table('latencies_rollup', 'a', colocate_with => 'latencies');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

INSERT INTO latencies_rollup
SELECT a, tdigest(latency, 100)
FROM latencies
GROUP BY a;
EXPLAIN (COSTS OFF, VERBOSE)
SELECT tdigest(tdigest)
FROM latencies_rollup;
                                                QUERY PLAN
---------------------------------------------------------------------
 Aggregate
   Output: tdigest(remote_scan.tdigest)
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.tdigest
         Task Count: 4
         Tasks Shown: One of 4
         ->  Task
               Node: host=localhost port=xxxxx dbname=regression
               ->  Aggregate
                     Output: tdigest(tdigest)
                     ->  Seq Scan on tdigest_aggregate_support.latencies_rollup_20070004 latencies_rollup
                           Output: a, tdigest
(12 rows)

-- explain grouping by distribution column is completely pushed down for tdigest(tdigest)
EXPLAIN (COSTS OFF, VERBOSE)
SELECT a, tdigest(tdigest)
FROM latencies_rollup
GROUP BY a;
                                             QUERY PLAN
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.a, remote_scan.tdigest
   Task Count: 4
   Tasks Shown: One of 4
   ->  Task
         Node: host=localhost port=xxxxx dbname=regression
         ->  HashAggregate
               Output: a, tdigest(tdigest)
               Group Key: latencies_rollup.a
               ->  Seq Scan on tdigest_aggregate_support.latencies_rollup_20070004 latencies_rollup
                     Output: a, tdigest
(11 rows)

-- explain no grouping to verify partially pushed down for tdigest_precentile(tdigest, quantile)
EXPLAIN (COSTS OFF, VERBOSE)
SELECT tdigest_percentile(tdigest, 0.99)
FROM latencies_rollup;
ERROR:  unsupported aggregate function tdigest_percentile
-- explain grouping by distribution column is completely pushed down for tdigest_precentile(tdigest, quantile)
EXPLAIN (COSTS OFF, VERBOSE)
SELECT a, tdigest_percentile(tdigest, 0.99)
FROM latencies_rollup
GROUP BY a;
                                             QUERY PLAN
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.a, remote_scan.tdigest_percentile
   Task Count: 4
   Tasks Shown: One of 4
   ->  Task
         Node: host=localhost port=xxxxx dbname=regression
         ->  HashAggregate
               Output: a, tdigest_percentile(tdigest, '0.99'::double precision)
               Group Key: latencies_rollup.a
               ->  Seq Scan on tdigest_aggregate_support.latencies_rollup_20070004 latencies_rollup
                     Output: a, tdigest
(11 rows)

-- explain no grouping to verify partially pushed down for tdigest_precentile(value, compression, quantiles[])
EXPLAIN (COSTS OFF, VERBOSE)
SELECT tdigest_percentile(tdigest, ARRAY[0.99, 0.95])
FROM latencies_rollup;
ERROR:  unsupported aggregate function tdigest_percentile
-- explain grouping by distribution column is completely pushed down for tdigest_precentile(value, compression, quantiles[])
EXPLAIN (COSTS OFF, VERBOSE)
SELECT a, tdigest_percentile(tdigest, ARRAY[0.99, 0.95])
FROM latencies_rollup
GROUP BY a;
                                             QUERY PLAN
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.a, remote_scan.tdigest_percentile
   Task Count: 4
   Tasks Shown: One of 4
   ->  Task
         Node: host=localhost port=xxxxx dbname=regression
         ->  HashAggregate
               Output: a, tdigest_percentile(tdigest, '{0.99,0.95}'::double precision[])
               Group Key: latencies_rollup.a
               ->  Seq Scan on tdigest_aggregate_support.latencies_rollup_20070004 latencies_rollup
                     Output: a, tdigest
(11 rows)

-- explain no grouping to verify partially pushed down for tdigest_precentile_of(value, compression, hypotetical_value)
EXPLAIN (COSTS OFF, VERBOSE)
SELECT tdigest_percentile_of(tdigest, 9000)
FROM latencies_rollup;
ERROR:  unsupported aggregate function tdigest_percentile_of
-- explain grouping by distribution column is completely pushed down for tdigest_precentile_of(value, compression, hypotetical_value)
EXPLAIN (COSTS OFF, VERBOSE)
SELECT a, tdigest_percentile_of(tdigest, 9000)
FROM latencies_rollup
GROUP BY a;
                                             QUERY PLAN
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.a, remote_scan.tdigest_percentile_of
   Task Count: 4
   Tasks Shown: One of 4
   ->  Task
         Node: host=localhost port=xxxxx dbname=regression
         ->  HashAggregate
               Output: a, tdigest_percentile_of(tdigest, '9000'::double precision)
               Group Key: latencies_rollup.a
               ->  Seq Scan on tdigest_aggregate_support.latencies_rollup_20070004 latencies_rollup
                     Output: a, tdigest
(11 rows)

-- explain no grouping to verify partially pushed down for tdigest_precentile_of(value, compression, hypotetical_values[])
EXPLAIN (COSTS OFF, VERBOSE)
SELECT tdigest_percentile_of(tdigest, ARRAY[9000, 9500])
FROM latencies_rollup;
ERROR:  unsupported aggregate function tdigest_percentile_of
-- explain grouping by distribution column is completely pushed down for tdigest_precentile_of(value, compression, hypotetical_values[])
EXPLAIN (COSTS OFF, VERBOSE)
SELECT a, tdigest_percentile_of(tdigest, ARRAY[9000, 9500])
FROM latencies_rollup
GROUP BY a;
                                             QUERY PLAN
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.a, remote_scan.tdigest_percentile_of
   Task Count: 4
   Tasks Shown: One of 4
   ->  Task
         Node: host=localhost port=xxxxx dbname=regression
         ->  HashAggregate
               Output: a, tdigest_percentile_of(tdigest, '{9000,9500}'::double precision[])
               Group Key: latencies_rollup.a
               ->  Seq Scan on tdigest_aggregate_support.latencies_rollup_20070004 latencies_rollup
                     Output: a, tdigest
(11 rows)

SET client_min_messages TO WARNING; -- suppress cascade messages
DROP SCHEMA tdigest_aggregate_support CASCADE;
